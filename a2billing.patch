diff -rupN a2billing.orig/addons/contrib/test-cases/lib/Misc.php a2billing/addons/contrib/test-cases/lib/Misc.php
--- a2billing.orig/addons/contrib/test-cases/lib/Misc.php	2012-09-18 06:38:22.000000000 -0300
+++ a2billing/addons/contrib/test-cases/lib/Misc.php	2012-09-20 14:09:25.091341739 -0300
@@ -5,10 +5,10 @@
 /**
  * This file is part of A2Billing (http://www.a2billing.net/)
  *
- * A2Billing, Commercial Open Source Telecom Billing platform,
+ * A2Billing, Commercial Open Source Telecom Billing platform,   
  * powered by Star2billing S.L. <http://www.star2billing.com/>
- *
- * @copyright   Copyright (C) 2004-2012 - Star2billing S.L.
+ * 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
  * @author      Belaid Arezqui <areski@gmail.com>
  * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
  * @package     A2Billing
@@ -27,8 +27,8 @@
  *
  * You should have received a copy of the GNU Affero General Public License
  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
- *
- *
+ * 
+ * 
 **/
 
 
@@ -59,9 +59,9 @@ function a2b_decrypt($text, $key) {
  */
 function a2b_mail($to, $subject, $mail_content, $from = 'root@localhost', $fromname = '', $contenttype = 'multipart/alternative')
 {
-
+	
 	$mail = new PHPMailer(true);
-
+	
 	if (SMTP_SERVER) {
 		$mail->Mailer = "smtp";
 	} else {
@@ -85,7 +85,7 @@ function a2b_mail($to, $subject, $mail_c
 	$mail->AltBody = $mail_content; // Plain text body (for mail clients that cannot read 	HTML)
 	// if ContentType = multipart/alternative -> HTML will be send
 	$mail->ContentType = $contenttype;
-
+	
 	if (strpos($to, ',') > 0) {
 		foreach (explode(',', $to) as $toemail){
             $mail->AddAddress($toemail);
@@ -93,7 +93,7 @@ function a2b_mail($to, $subject, $mail_c
 	} else {
 	    $mail->AddAddress($to);
 	}
-
+	
 	try {
 		$mail->Send();
 	} catch (phpmailerException $e) {
@@ -236,26 +236,11 @@ function sanitize_data($input) {
 		}
 	} else {
 
-		// remove whitespaces (not a must though)
+		// remove whitespaces (not a must though)  
 		$input = trim($input);
 
 		$input = str_replace('--', '', $input);
 		$input = str_replace(';', '', $input);
-		$input = str_replace('#', '', $input);
-		$input = str_replace('/*', '', $input);
-
-		#injection sql
-		$input = str_ireplace('HAVING', '', $input);
-		$input = str_ireplace('UNION', '', $input);
-		$input = str_ireplace('SUBSTRING', '', $input);
-		$input = str_ireplace('ASCII', '', $input);
-		$input = str_ireplace('SHA1', '', $input);
-		$input = str_ireplace('MD5', '', $input);
-		$input = str_ireplace('SCRIPT', '', $input);
-		$input = str_ireplace('ROW_COUNT', '', $input);
-		$input = str_ireplace('SELECT', '', $input);
-		$input = str_ireplace('UPDATE', '', $input);
-		#$input = str_ireplace('DELETE', '', $input);
 
 		if (!(stripos($input, ' or 1') === FALSE)) {
 			return false;
@@ -268,7 +253,7 @@ function sanitize_data($input) {
 			$input = stripslashes($input);
 		}
 		$input = cleanInput($input);
-
+		
 		$output = addslashes($input);
 	}
 
@@ -351,7 +336,7 @@ function display_dateformat($mydate) {
  */
 function display_date_timestamp($timestamp){
 	echo date("m/d/Y H:i:s", $timestamp);
-}
+}	
 
 /*
  * function display_vm_callerid
@@ -359,7 +344,7 @@ function display_date_timestamp($timesta
 function display_vm_callerid($callerid_string){
 	$arr_spli = preg_split("/ /", $callerid_string);
 	echo str_replace('"',"", $arr_spli[0]);
-}
+}	
 
 
 
@@ -469,7 +454,7 @@ function linkonmonitorfile($value) {
 		}
 	}
 	if (!$find_record) return false;
-
+	
 	$myfile = base64_encode($myfile);
 	echo "<a target=_blank href=\"call-log-customers.php?download=file&file=" . $myfile . "\">";
 	echo '<img src="' . Images_Path . '/stock-mic.png" height="18" /></a>';
@@ -490,7 +475,7 @@ function linkonmonitorfile_customer($val
 		}
 	}
 	if (!$find_record) return false;
-
+	
 	$myfile = base64_encode($myfile);
 	echo "<a target=_blank href=\"call-history.php?download=file&file=" . $myfile . "\">";
 	echo '<img src="' . Images_Path . '/stock-mic.png" height="18" /></a>';
@@ -641,7 +626,7 @@ function MDP_NUMERIC($chrs = LEN_CARDNUM
     for($i = 0; $i < $chrs; $i++){
         $myrand .= mt_rand(0,9);
     }
-
+    
     return $myrand;
 }
 
@@ -884,11 +869,11 @@ function get_timezones($handle = null, $
 		$handle = DbConnect();
 	}
 	$instance_table = new Table();
-	if (!is_null($clause))
-		$clause = 'WHERE '.$clause;
+	if (!is_null($clause)) 
+		$clause = 'WHERE '.$clause; 
 	$QUERY = "SELECT id, gmttime, gmtzone, gmtoffset FROM cc_timezone $clause ORDER by id";
 	$result = $instance_table->SQLExec($handle, $QUERY, 1, 300);
-
+	
 	if (is_array($result)) {
 		$num_cur = count($result);
 		for ($i = 0; $i < $num_cur; $i++) {
@@ -904,13 +889,13 @@ function get_timezones($handle = null, $
 }
 
 function display_GMT($currDate, $number, $fulldate = 1)
-{
+{	
 	$timezone_list = get_timezones(null, "gmttime = '".SERVER_GMT."'");
 	foreach ($timezone_list as $key => $timezone_list_val) {
 		$server_offset = $timezone_list_val[3];
 		break;
 	}
-
+	
 	$date_time_array = getdate(strtotime($currDate));
 	$hours = $date_time_array['hours'];
 	$minutes = $date_time_array['minutes'];
@@ -919,7 +904,6 @@ function display_GMT($currDate, $number,
 	$day = $date_time_array['mday'];
 	$year = $date_time_array['year'];
 	$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
-
 	$timestamp = $timestamp - ($server_offset - $number);
 	/*
 	if ($fulldate == 1) {
@@ -929,7 +913,7 @@ function display_GMT($currDate, $number,
 	}
 	return $gmdate;
 	*/
-
+	
 	if ($fulldate == 1) {
 		$date = date("Y-m-d H:i:s", $timestamp);
 	} else {
@@ -1030,7 +1014,7 @@ function get_db_languages($handle = null
  */
 
 function archive_data($condition, $entity = "")
-{
+{	
 	$handle = DbConnect();
 	$instance_table = new Table();
 	if (!empty ($entity)) {
@@ -1073,7 +1057,7 @@ function do_field($sql, $fld, $dbfld) {
 	$fldtype = $fld . 'type';
 	global $$fld;
 	global $$fldtype;
-
+	
 	if ($$fld) {
 		if (strpos($sql, 'WHERE') > 0) {
 			$sql = "$sql AND ";
@@ -1114,7 +1098,7 @@ function currencies_update_yahoo ($DBHan
 	$strong_currency = 'EUR';
 	$url = "http://download.finance.yahoo.com/d/quotes.csv?s=";
 	$return = "";
-
+	
 	$QUERY = "SELECT id, currency, basecurrency FROM cc_currencies ORDER BY id";
 	$old_currencies = $instance_table->SQLExec($DBHandle, $QUERY);
 
@@ -1172,7 +1156,7 @@ function currencies_update_yahoo ($DBHan
 				return gettext("At least one of the entries in the CSV file isn't a number.") . ' ' . gettext('Currency update ABORTED.');
 			}
 		}
-
+		
 		// Find base_currency's value in $strong_currency to help avoid Yahoo's
 		// early truncation,  and therefore win back a lot of accuracy
 		$base_value = $currencies[$index_base_currency];
@@ -1250,7 +1234,7 @@ function generate_invoice_reference() {
 	$invoice_conf_table = new Table('cc_invoice_conf', 'value');
 	$conf_clause = "key_val = 'count_$year'";
 	$result = $invoice_conf_table->Get_list($handle, $conf_clause, 0);
-
+	
 	if (is_array($result) && !empty ($result[0][0])) {
 		$count = $result[0][0];
 		if (!is_numeric($count)) {
@@ -1339,13 +1323,13 @@ function mt_get()
     list($usec, $sec) = explode(" ", microtime());
     return ((float)$usec + (float)$sec);
 }
-
+ 
 // mt_start: starts the microtime counter
 function mt_start()
 {
     global $mt_time; $mt_time = mt_get();
 }
-
+ 
 // mt_end: calculates the elapsed time
 function mt_end($len=4)
 {
@@ -1376,8 +1360,8 @@ function open_url($url)
     $string = ob_get_contents();
 
     ob_end_clean();
-
-    return $string;
+   
+    return $string;    
 }
 
 
@@ -1387,22 +1371,22 @@ function open_url($url)
 function retrieve_rates_callplan($callplan_id, $DBHandle)
 {
     $instance_table = new Table();
-
+    
     $QUERY = "SELECT DISTINCT cc_ratecard.destination, cc_ratecard.dialprefix, cc_ratecard.buyrate, cc_ratecard.rateinitial, cc_ratecard.startdate, cc_ratecard.stopdate, cc_ratecard.initblock, " .
     		"cc_ratecard.connectcharge, cc_ratecard.id_trunk , cc_ratecard.idtariffplan , cc_ratecard.id FROM cc_tariffgroup RIGHT JOIN cc_tariffgroup_plan ON cc_tariffgroup_plan.idtariffgroup=cc_tariffgroup.id " .
     		"INNER JOIN cc_tariffplan ON (cc_tariffplan.id=cc_tariffgroup_plan.idtariffplan ) LEFT JOIN cc_ratecard ON cc_ratecard.idtariffplan=cc_tariffplan.id WHERE cc_tariffgroup.id= '$callplan_id' " .
     		"AND cc_ratecard.rateinitial = (SELECT min(c1.rateinitial) FROM cc_tariffgroup RIGHT JOIN cc_tariffgroup_plan ON cc_tariffgroup_plan.idtariffgroup=cc_tariffgroup.id " .
     		"INNER JOIN cc_tariffplan ON (cc_tariffplan.id=cc_tariffgroup_plan.idtariffplan ) LEFT JOIN cc_ratecard AS c1 ON c1.idtariffplan=cc_tariffplan.id WHERE cc_tariffgroup.id= '$callplan_id' " .
     		"AND cc_ratecard.dialprefix=c1.dialprefix) ORDER BY destination ASC";
-
+	
 	$result = $instance_table -> SQLExec ($DBHandle, $QUERY, 1, 3600); // cached for 1hour
-
+	
 	if (!is_array($result)) {
 	    return false;
 	}
-
+	
 	return $result;
-
+	
 }
 
 /*
@@ -1412,16 +1396,16 @@ function check_cp()
 {
 	$randn = rand(1, 10);
 	$ret_val = ($randn == 5)? 1 : 0;
-
+	
 	$pos_star = strpos(COPYRIGHT, 'star2billing');
 	if ($pos_star === false) {
 		return $ret_val;
 	}
 	$pageURL = get_curPageURL();
     $pos = strpos($pageURL, 'phpsysinfo');
-
+    
     if ($pos === false) {
-
+        
         $footer_content = file_get_contents("templates/default/footer.tpl");
 
         $pos_copyright = strpos($footer_content, '$COPYRIGHT');
@@ -1489,7 +1473,7 @@ function addRealMonth($timeStamp)
 
 
 function Display_Login_Button ($DBHandle, $id) {
-
+	
 	$inst_table = new Table("cc_card", "useralias, uipass");
 	$FG_TABLE_CLAUSE = "id = $id";
 	$list_card_info = $inst_table -> Get_list ($DBHandle, $FG_TABLE_CLAUSE);
@@ -1515,3 +1499,22 @@ function Display_Login_Button ($DBHandle
 }
 
 
+function date_add_hour($tmpdate, $hour = 0) {
+	
+	$second = $hour * 60 * 60 ;
+	$date_time_array = getdate(strtotime($tmpdate));
+	
+
+	$hours = $date_time_array['hours'];
+	$minutes = $date_time_array['minutes'];
+	$seconds = $date_time_array['seconds'];
+	$month = $date_time_array['mon'];
+	$day = $date_time_array['mday'];
+	$year = $date_time_array['year'];
+	
+	$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
+
+	$timestamp = $timestamp + $second;
+
+	return $timestamp;
+}
diff -rupN a2billing.orig/admin/lib/Misc.php a2billing/admin/lib/Misc.php
--- a2billing.orig/admin/lib/Misc.php	2012-09-18 06:38:22.000000000 -0300
+++ a2billing/admin/lib/Misc.php	2012-09-20 14:09:25.091341739 -0300
@@ -5,10 +5,10 @@
 /**
  * This file is part of A2Billing (http://www.a2billing.net/)
  *
- * A2Billing, Commercial Open Source Telecom Billing platform,
+ * A2Billing, Commercial Open Source Telecom Billing platform,   
  * powered by Star2billing S.L. <http://www.star2billing.com/>
- *
- * @copyright   Copyright (C) 2004-2012 - Star2billing S.L.
+ * 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
  * @author      Belaid Arezqui <areski@gmail.com>
  * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
  * @package     A2Billing
@@ -27,8 +27,8 @@
  *
  * You should have received a copy of the GNU Affero General Public License
  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
- *
- *
+ * 
+ * 
 **/
 
 
@@ -59,9 +59,9 @@ function a2b_decrypt($text, $key) {
  */
 function a2b_mail($to, $subject, $mail_content, $from = 'root@localhost', $fromname = '', $contenttype = 'multipart/alternative')
 {
-
+	
 	$mail = new PHPMailer(true);
-
+	
 	if (SMTP_SERVER) {
 		$mail->Mailer = "smtp";
 	} else {
@@ -85,7 +85,7 @@ function a2b_mail($to, $subject, $mail_c
 	$mail->AltBody = $mail_content; // Plain text body (for mail clients that cannot read 	HTML)
 	// if ContentType = multipart/alternative -> HTML will be send
 	$mail->ContentType = $contenttype;
-
+	
 	if (strpos($to, ',') > 0) {
 		foreach (explode(',', $to) as $toemail){
             $mail->AddAddress($toemail);
@@ -93,7 +93,7 @@ function a2b_mail($to, $subject, $mail_c
 	} else {
 	    $mail->AddAddress($to);
 	}
-
+	
 	try {
 		$mail->Send();
 	} catch (phpmailerException $e) {
@@ -236,26 +236,11 @@ function sanitize_data($input) {
 		}
 	} else {
 
-		// remove whitespaces (not a must though)
+		// remove whitespaces (not a must though)  
 		$input = trim($input);
 
 		$input = str_replace('--', '', $input);
 		$input = str_replace(';', '', $input);
-		$input = str_replace('#', '', $input);
-		$input = str_replace('/*', '', $input);
-
-		#injection sql
-		$input = str_ireplace('HAVING', '', $input);
-		$input = str_ireplace('UNION', '', $input);
-		$input = str_ireplace('SUBSTRING', '', $input);
-		$input = str_ireplace('ASCII', '', $input);
-		$input = str_ireplace('SHA1', '', $input);
-		$input = str_ireplace('MD5', '', $input);
-		$input = str_ireplace('SCRIPT', '', $input);
-		$input = str_ireplace('ROW_COUNT', '', $input);
-		$input = str_ireplace('SELECT', '', $input);
-		$input = str_ireplace('UPDATE', '', $input);
-		#$input = str_ireplace('DELETE', '', $input);
 
 		if (!(stripos($input, ' or 1') === FALSE)) {
 			return false;
@@ -268,7 +253,7 @@ function sanitize_data($input) {
 			$input = stripslashes($input);
 		}
 		$input = cleanInput($input);
-
+		
 		$output = addslashes($input);
 	}
 
@@ -351,7 +336,7 @@ function display_dateformat($mydate) {
  */
 function display_date_timestamp($timestamp){
 	echo date("m/d/Y H:i:s", $timestamp);
-}
+}	
 
 /*
  * function display_vm_callerid
@@ -359,7 +344,7 @@ function display_date_timestamp($timesta
 function display_vm_callerid($callerid_string){
 	$arr_spli = preg_split("/ /", $callerid_string);
 	echo str_replace('"',"", $arr_spli[0]);
-}
+}	
 
 
 
@@ -469,7 +454,7 @@ function linkonmonitorfile($value) {
 		}
 	}
 	if (!$find_record) return false;
-
+	
 	$myfile = base64_encode($myfile);
 	echo "<a target=_blank href=\"call-log-customers.php?download=file&file=" . $myfile . "\">";
 	echo '<img src="' . Images_Path . '/stock-mic.png" height="18" /></a>';
@@ -490,7 +475,7 @@ function linkonmonitorfile_customer($val
 		}
 	}
 	if (!$find_record) return false;
-
+	
 	$myfile = base64_encode($myfile);
 	echo "<a target=_blank href=\"call-history.php?download=file&file=" . $myfile . "\">";
 	echo '<img src="' . Images_Path . '/stock-mic.png" height="18" /></a>';
@@ -641,7 +626,7 @@ function MDP_NUMERIC($chrs = LEN_CARDNUM
     for($i = 0; $i < $chrs; $i++){
         $myrand .= mt_rand(0,9);
     }
-
+    
     return $myrand;
 }
 
@@ -884,11 +869,11 @@ function get_timezones($handle = null, $
 		$handle = DbConnect();
 	}
 	$instance_table = new Table();
-	if (!is_null($clause))
-		$clause = 'WHERE '.$clause;
+	if (!is_null($clause)) 
+		$clause = 'WHERE '.$clause; 
 	$QUERY = "SELECT id, gmttime, gmtzone, gmtoffset FROM cc_timezone $clause ORDER by id";
 	$result = $instance_table->SQLExec($handle, $QUERY, 1, 300);
-
+	
 	if (is_array($result)) {
 		$num_cur = count($result);
 		for ($i = 0; $i < $num_cur; $i++) {
@@ -904,13 +889,13 @@ function get_timezones($handle = null, $
 }
 
 function display_GMT($currDate, $number, $fulldate = 1)
-{
+{	
 	$timezone_list = get_timezones(null, "gmttime = '".SERVER_GMT."'");
 	foreach ($timezone_list as $key => $timezone_list_val) {
 		$server_offset = $timezone_list_val[3];
 		break;
 	}
-
+	
 	$date_time_array = getdate(strtotime($currDate));
 	$hours = $date_time_array['hours'];
 	$minutes = $date_time_array['minutes'];
@@ -919,7 +904,6 @@ function display_GMT($currDate, $number,
 	$day = $date_time_array['mday'];
 	$year = $date_time_array['year'];
 	$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
-
 	$timestamp = $timestamp - ($server_offset - $number);
 	/*
 	if ($fulldate == 1) {
@@ -929,7 +913,7 @@ function display_GMT($currDate, $number,
 	}
 	return $gmdate;
 	*/
-
+	
 	if ($fulldate == 1) {
 		$date = date("Y-m-d H:i:s", $timestamp);
 	} else {
@@ -1030,7 +1014,7 @@ function get_db_languages($handle = null
  */
 
 function archive_data($condition, $entity = "")
-{
+{	
 	$handle = DbConnect();
 	$instance_table = new Table();
 	if (!empty ($entity)) {
@@ -1073,7 +1057,7 @@ function do_field($sql, $fld, $dbfld) {
 	$fldtype = $fld . 'type';
 	global $$fld;
 	global $$fldtype;
-
+	
 	if ($$fld) {
 		if (strpos($sql, 'WHERE') > 0) {
 			$sql = "$sql AND ";
@@ -1114,7 +1098,7 @@ function currencies_update_yahoo ($DBHan
 	$strong_currency = 'EUR';
 	$url = "http://download.finance.yahoo.com/d/quotes.csv?s=";
 	$return = "";
-
+	
 	$QUERY = "SELECT id, currency, basecurrency FROM cc_currencies ORDER BY id";
 	$old_currencies = $instance_table->SQLExec($DBHandle, $QUERY);
 
@@ -1172,7 +1156,7 @@ function currencies_update_yahoo ($DBHan
 				return gettext("At least one of the entries in the CSV file isn't a number.") . ' ' . gettext('Currency update ABORTED.');
 			}
 		}
-
+		
 		// Find base_currency's value in $strong_currency to help avoid Yahoo's
 		// early truncation,  and therefore win back a lot of accuracy
 		$base_value = $currencies[$index_base_currency];
@@ -1250,7 +1234,7 @@ function generate_invoice_reference() {
 	$invoice_conf_table = new Table('cc_invoice_conf', 'value');
 	$conf_clause = "key_val = 'count_$year'";
 	$result = $invoice_conf_table->Get_list($handle, $conf_clause, 0);
-
+	
 	if (is_array($result) && !empty ($result[0][0])) {
 		$count = $result[0][0];
 		if (!is_numeric($count)) {
@@ -1339,13 +1323,13 @@ function mt_get()
     list($usec, $sec) = explode(" ", microtime());
     return ((float)$usec + (float)$sec);
 }
-
+ 
 // mt_start: starts the microtime counter
 function mt_start()
 {
     global $mt_time; $mt_time = mt_get();
 }
-
+ 
 // mt_end: calculates the elapsed time
 function mt_end($len=4)
 {
@@ -1376,8 +1360,8 @@ function open_url($url)
     $string = ob_get_contents();
 
     ob_end_clean();
-
-    return $string;
+   
+    return $string;    
 }
 
 
@@ -1387,22 +1371,22 @@ function open_url($url)
 function retrieve_rates_callplan($callplan_id, $DBHandle)
 {
     $instance_table = new Table();
-
+    
     $QUERY = "SELECT DISTINCT cc_ratecard.destination, cc_ratecard.dialprefix, cc_ratecard.buyrate, cc_ratecard.rateinitial, cc_ratecard.startdate, cc_ratecard.stopdate, cc_ratecard.initblock, " .
     		"cc_ratecard.connectcharge, cc_ratecard.id_trunk , cc_ratecard.idtariffplan , cc_ratecard.id FROM cc_tariffgroup RIGHT JOIN cc_tariffgroup_plan ON cc_tariffgroup_plan.idtariffgroup=cc_tariffgroup.id " .
     		"INNER JOIN cc_tariffplan ON (cc_tariffplan.id=cc_tariffgroup_plan.idtariffplan ) LEFT JOIN cc_ratecard ON cc_ratecard.idtariffplan=cc_tariffplan.id WHERE cc_tariffgroup.id= '$callplan_id' " .
     		"AND cc_ratecard.rateinitial = (SELECT min(c1.rateinitial) FROM cc_tariffgroup RIGHT JOIN cc_tariffgroup_plan ON cc_tariffgroup_plan.idtariffgroup=cc_tariffgroup.id " .
     		"INNER JOIN cc_tariffplan ON (cc_tariffplan.id=cc_tariffgroup_plan.idtariffplan ) LEFT JOIN cc_ratecard AS c1 ON c1.idtariffplan=cc_tariffplan.id WHERE cc_tariffgroup.id= '$callplan_id' " .
     		"AND cc_ratecard.dialprefix=c1.dialprefix) ORDER BY destination ASC";
-
+	
 	$result = $instance_table -> SQLExec ($DBHandle, $QUERY, 1, 3600); // cached for 1hour
-
+	
 	if (!is_array($result)) {
 	    return false;
 	}
-
+	
 	return $result;
-
+	
 }
 
 /*
@@ -1412,16 +1396,16 @@ function check_cp()
 {
 	$randn = rand(1, 10);
 	$ret_val = ($randn == 5)? 1 : 0;
-
+	
 	$pos_star = strpos(COPYRIGHT, 'star2billing');
 	if ($pos_star === false) {
 		return $ret_val;
 	}
 	$pageURL = get_curPageURL();
     $pos = strpos($pageURL, 'phpsysinfo');
-
+    
     if ($pos === false) {
-
+        
         $footer_content = file_get_contents("templates/default/footer.tpl");
 
         $pos_copyright = strpos($footer_content, '$COPYRIGHT');
@@ -1489,7 +1473,7 @@ function addRealMonth($timeStamp)
 
 
 function Display_Login_Button ($DBHandle, $id) {
-
+	
 	$inst_table = new Table("cc_card", "useralias, uipass");
 	$FG_TABLE_CLAUSE = "id = $id";
 	$list_card_info = $inst_table -> Get_list ($DBHandle, $FG_TABLE_CLAUSE);
@@ -1515,3 +1499,22 @@ function Display_Login_Button ($DBHandle
 }
 
 
+function date_add_hour($tmpdate, $hour = 0) {
+	
+	$second = $hour * 60 * 60 ;
+	$date_time_array = getdate(strtotime($tmpdate));
+	
+
+	$hours = $date_time_array['hours'];
+	$minutes = $date_time_array['minutes'];
+	$seconds = $date_time_array['seconds'];
+	$month = $date_time_array['mon'];
+	$day = $date_time_array['mday'];
+	$year = $date_time_array['year'];
+	
+	$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
+
+	$timestamp = $timestamp + $second;
+
+	return $timestamp;
+}
diff -rupN a2billing.orig/admin/Public/call-count-reporting-history.php a2billing/admin/Public/call-count-reporting-history.php
--- a2billing.orig/admin/Public/call-count-reporting-history.php	1969-12-31 21:00:00.000000000 -0300
+++ a2billing/admin/Public/call-count-reporting-history.php	2012-09-20 14:09:25.081341712 -0300
@@ -0,0 +1,434 @@
+<?php
+
+/* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4: */
+
+/**
+ * This file is part of A2Billing (http://www.a2billing.net/)
+ *
+ * A2Billing, Commercial Open Source Telecom Billing platform,   
+ * powered by Star2billing S.L. <http://www.star2billing.com/>
+ * 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
+ * @author      Belaid Arezqui <areski@gmail.com>
+ * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
+ * @package     A2Billing
+ *
+ * Software License Agreement (GNU Affero General Public License)
+ *
+ * This program is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU Affero General Public License as
+ * published by the Free Software Foundation, either version 3 of the
+ * License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Affero General Public License for more details.
+ *
+ * You should have received a copy of the GNU Affero General Public License
+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
+ * 
+ * 
+**/
+
+
+include ("../lib/admin.defines.php");
+include ("../lib/admin.module.access.php");
+include ("../lib/admin.smarty.php");
+
+if (! has_rights (ACX_CALL_REPORT)) {
+	Header ("HTTP/1.0 401 Unauthorized");
+	Header ("Location: PP_error.php?c=accessdenied");	   
+	die();
+}
+
+getpost_ifset(array('inputtopvar','topsearch', 'posted', 'Period', 'frommonth', 'fromstatsmonth', 'tomonth', 'tostatsmonth', 'fromday', 'fromstatsday_sday', 'fromstatsmonth_sday', 'today', 'tostatsday_sday', 'tostatsmonth_sday', 'resulttype', 'stitle', 'atmenu', 'order', 'sens', 'choose_currency', 'terminatecauseid', 'nodisplay','grouped'));
+
+
+
+if (!isset ($FG_TABLE_CLAUSE) || strlen($FG_TABLE_CLAUSE)==0) {
+	$cc_yearmonth = sprintf("%04d-%02d-%02d",date("Y"),date("n"),date("d")); 	
+	$FG_TABLE_CLAUSE=" UNIX_TIMESTAMP(starttime) <= UNIX_TIMESTAMP('$cc_yearmonth')";
+}
+
+$FG_DEBUG = 0;
+
+
+// THIS VARIABLE DEFINE THE COLOR OF THE HEAD TABLE
+$FG_TABLE_ALTERNATE_ROW_COLOR[] = "#FFFFFF";
+$FG_TABLE_ALTERNATE_ROW_COLOR[] = "#F2F8FF";
+
+
+$DBHandle = DbConnect();
+
+if($order=="day" && $grouped==0) {
+    $order="";
+}
+
+$FG_TABLE_COL = array();
+switch ($topsearch) {	
+	case "topdestination":
+		$FG_TABLE_COL[]=array (gettext("Destination"), "destination", "25%", "center", "SORT", "15", "lie", "cc_prefix", "destination", "id='%id'", "%1");
+		$on_field1 = "cc_prefix.destination";
+		$on_field2 = "destination";
+		$FG_TABLE_DEFAULT_ORDER = "cc_prefix.destination";
+		$FG_TABLE_NAME="cc_call_archive LEFT JOIN cc_prefix ON cc_call_archive.destination = cc_prefix.prefix";
+		if($order=="card_id" || empty ($order))$order="destination";
+		break;
+	case "topuser":
+	default:
+		$FG_TABLE_COL[]=array (gettext("Account Used"), 'card_id', "25%", "center","SORT", "", "30", "", "", "", "", "linktocustomer_id");
+		$on_field1 = $on_field2 = "card_id";
+		$FG_TABLE_DEFAULT_ORDER = "card_id";
+		$FG_TABLE_NAME="cc_call_archive";
+		if($order=="destination" || empty ($order))$order="card_id";
+		break;
+}
+
+$FG_TABLE_COL[]=array (gettext("Duration"), "calltime", "15%", "center", "SORT", "30", "", "", "", "", "", "display_minute");
+$FG_TABLE_COL[]=array (gettext("Sell"), "cost", "15%", "center","sort","","","","","","","display_2bill");
+$FG_TABLE_COL[]=array (gettext("Buy"), "buy", "15%", "center","sort","","","","","","","display_2bill");
+if ($grouped) $FG_TABLE_COL[]=array (gettext("Calldate"), "day", "10%", "center", "SORT", "19", "", "", "", "", "", "display_dateformat");
+if ((isset($inputtopvar)) && ($inputtopvar!="") && (isset($topsearch)) && ($topsearch!="")){
+	$FG_TABLE_COL[]=array (gettext("NbrCall"), 'nbcall', "10%", "center", "SORT");
+}
+
+
+if ($grouped) {
+	$FG_COL_QUERY=$on_field1.', sum(sessiontime) AS calltime, sum(sessionbill) as cost, sum(buycost) as buy,DATE(starttime) AS day, count(*) as nbcall';
+	$SQL_GROUP=" GROUP BY ".$on_field2.",DATE(starttime) ";
+} else {
+	$FG_COL_QUERY=$on_field1.', sum(sessiontime) AS calltime, sum(sessionbill) as cost, sum(buycost) as buy, count(*) as nbcall';
+	$SQL_GROUP=" GROUP BY ".$on_field2." ";
+}
+
+$FG_TABLE_DEFAULT_SENS = "DESC";
+
+
+$FG_NB_TABLE_COL=count($FG_TABLE_COL);
+$FG_TOTAL_TABLE_COL = $FG_NB_TABLE_COL;
+$FG_HTML_TABLE_TITLE = gettext(" - Call Report - ");
+$FG_HTML_TABLE_WIDTH="96%";
+
+if ( empty ($order) || empty($sens) || ( $order == 'card_id' && $topsearch == 'topdestination') || ( $order == 'destination' && $topsearch == 'topuser')) {
+	$order = $FG_TABLE_DEFAULT_ORDER;
+	$sens  = $FG_TABLE_DEFAULT_SENS;
+}
+
+$date_clause='';
+normalize_day_of_month($fromstatsday_sday, $fromstatsmonth_sday, 1); 
+normalize_day_of_month($tostatsday_sday, $tostatsmonth_sday, 1);
+ 	
+if ($fromday && isset($fromstatsday_sday) && isset($fromstatsmonth_sday)) $date_clause.=" AND UNIX_TIMESTAMP(starttime) >= UNIX_TIMESTAMP('$fromstatsmonth_sday-$fromstatsday_sday') ";
+if ($today && isset($tostatsday_sday) && isset($tostatsmonth_sday)) $date_clause.=" AND UNIX_TIMESTAMP(starttime) <= UNIX_TIMESTAMP('$tostatsmonth_sday-".sprintf("%02d",intval($tostatsday_sday)/*+1*/)." 23:59:59') ";
+
+
+if (strpos($date_clause, 'AND') > 0) {
+	$FG_TABLE_CLAUSE = substr($date_clause,5); 
+}
+
+// To select just terminatecauseid=ANSWER
+if (!isset($terminatecauseid)) {
+	$terminatecauseid="ANSWER";
+}
+if ($terminatecauseid=="ANSWER") {
+	if (strlen($FG_TABLE_CLAUSE)>0) $FG_TABLE_CLAUSE.=" AND ";
+	$FG_TABLE_CLAUSE .=" (terminatecauseid=1) ";
+}
+
+
+$instance_table = new Table($FG_TABLE_NAME, $FG_COL_QUERY);
+
+if (!$nodisplay) {
+	$list = $instance_table -> Get_list ($DBHandle, $FG_TABLE_CLAUSE, $order, $sens, null, null,$inputtopvar , 0,$SQL_GROUP);	
+}
+
+
+$smarty->display('main.tpl');
+
+?>
+
+<!-- ** ** ** ** ** Part for the research ** ** ** ** ** -->
+	<center>
+	<FORM METHOD=POST name="myForm" ACTION="<?php echo $PHP_SELF?>?s=1&t=0&order=<?php echo $order?>&sens=<?php echo $sens?>&current_page=<?php echo $current_page?>">
+	<INPUT TYPE="hidden" NAME="posted" value=1>
+	<INPUT TYPE="hidden" NAME="current_page" value=0>	
+		<table class="bar-status" width="85%" border="0" cellspacing="1" cellpadding="2" align="center">
+			
+			<tr>
+        		<td align="left" class="bgcolor_002">
+					<font class="fontstyle_003">&nbsp;&nbsp;<?php echo gettext("DATE");?></font>
+			</td>
+      			<td align="left" class="bgcolor_003" width="650">
+					<table width="100%" border="0" cellspacing="0" cellpadding="0" >
+					<tr><td class="fontstyle_searchoptions">
+	  				<input type="checkbox" name="fromday" value="true" <?php  if ($fromday){ ?>checked<?php }?>> <?php echo gettext("From");?> :
+					<select name="fromstatsday_sday" class="form_input_select">
+						<?php  
+						for ($i=1;$i<=31;$i++) {
+							if ($fromstatsday_sday==sprintf("%02d",$i)) $selected="selected";
+							else	$selected="";
+							echo '<option value="'.sprintf("%02d",$i)."\"$selected>".sprintf("%02d",$i).'</option>';
+						}
+						?>	
+					</select>
+				 	<select name="fromstatsmonth_sday" class="form_input_select">
+					<?php 	
+						$monthname = array( gettext("January"), gettext("February"),gettext("March"), gettext("April"), gettext("May"), gettext("June"), gettext("July"), gettext("August"), gettext("September"), gettext("October"), gettext("November"), gettext("December"));
+						$year_actual = date("Y");  	
+						for ($i=$year_actual;$i >= $year_actual-1;$i--) {		   
+							if ($year_actual==$i) {
+								$monthnumber = date("n")-1; // Month number without lead 0.
+							} else {
+								$monthnumber=11;
+							}		   
+							for ($j=$monthnumber;$j>=0;$j--) {	
+								$month_formated = sprintf("%02d",$j+1);
+								if ($fromstatsmonth_sday=="$i-$month_formated") $selected="selected";
+								else $selected="";
+								echo "<OPTION value=\"$i-$month_formated\" $selected> $monthname[$j]-$i </option>";				
+							}
+						}
+					?>
+					</select>
+					</td><td class="fontstyle_searchoptions">&nbsp;&nbsp;
+					<input type="checkbox" name="today" value="true" <?php  if ($today){ ?>checked<?php }?>> <?php echo gettext("To");?>  :
+					<select name="tostatsday_sday" class="form_input_select">
+					<?php  
+						for ($i=1;$i<=31;$i++) {
+							if ($tostatsday_sday==sprintf("%02d",$i)){$selected="selected";}else{$selected="";}
+							echo '<option value="'.sprintf("%02d",$i)."\"$selected>".sprintf("%02d",$i).'</option>';
+						}
+					?>						
+					</select>
+				 	<select name="tostatsmonth_sday" class="form_input_select">
+					<?php 	$year_actual = date("Y");  	
+						for ($i=$year_actual;$i >= $year_actual-1;$i--) {		   
+							if ($year_actual==$i) {
+								$monthnumber = date("n")-1; // Month number without lead 0.
+							} else {
+								$monthnumber=11;
+							}		   
+							for ($j=$monthnumber;$j>=0;$j--) {	
+								$month_formated = sprintf("%02d",$j+1);
+							   	if ($tostatsmonth_sday=="$i-$month_formated") $selected="selected";
+								else	$selected="";
+								echo "<OPTION value=\"$i-$month_formated\" $selected> $monthname[$j]-$i </option>";				
+							}
+						}
+					?>
+					</select>
+					</td></tr></table>
+	  			</td>
+    		</tr>
+		<tr>
+			<TD class="bgcolor_004" align="left">
+				<font class="fontstyle_003">&nbsp;&nbsp;<?php echo strtoupper(gettext("Number in Result"));?></font>
+			</TD>
+			<td class="bgcolor_005" align="left" >
+				<table width="100%" border="0" cellspacing="0" cellpadding="0">
+				<tr>	
+					<td  align="left" class="fontstyle_searchoptions" >
+					    <select name="inputtopvar" class="form_input_select">
+						<option value="10" <?php if($inputtopvar==10) echo "selected"?>> 10&nbsp;<?php echo gettext('RESULTS');?>  </option>
+						<option value="20" <?php if($inputtopvar==20) echo "selected"?>> 20&nbsp;<?php echo gettext('RESULTS');?>   </option>
+						<option value="30" <?php if($inputtopvar==30) echo "selected"?>> 30&nbsp;<?php echo gettext('RESULTS');?>   </option>
+						<option value="40" <?php if($inputtopvar==40) echo "selected"?>> 40&nbsp;<?php echo gettext('RESULTS');?>   </option>
+						<option value="50" <?php if($inputtopvar==50) echo "selected"?>> 50&nbsp;<?php echo gettext('RESULTS');?>   </option>
+					    </select>
+					</td>
+					<td  align="center" class="fontstyle_searchoptions">
+						
+					</td>
+					<td  align="center" class="fontstyle_searchoptions">
+						
+					</td>
+				</tr></table>
+			</TD>
+		 </tr>
+			<!-- Select Option : to show just the Answered Calls or all calls, Result type, currencies... -->
+			<tr>
+			  <td class="bgcolor_002" align="left" ><font class="fontstyle_003">&nbsp;&nbsp;<?php echo gettext("OPTIONS");?></font></td>
+			  <td class="bgcolor_003" align="center" >
+			  <table width="100%" border="0" cellspacing="0" cellpadding="0">
+			  <tr>
+			  	<td width="35%" class="fontstyle_searchoptions" >
+				<table width="100%" border="0" cellspacing="0" cellpadding="0">
+				<tr class="bgcolor_005">
+					<td  class="fontstyle_searchoptions">
+						<?php echo gettext("GROUP BY");?> : 
+				   </td>
+				   <td  class="fontstyle_searchoptions">
+				   		<?php echo gettext("Calls by user");?>
+				   		<input type="radio" name="topsearch" value="topuser" <?php if ($topsearch=="topuser" || empty($topsearch)){ ?> checked="checked" <?php  } ?>>
+				   		<?php echo gettext("Calls by destination");?>
+				   		<input type="radio" name="topsearch" value="topdestination" <?php if ($topsearch=="topdestination"){ ?> checked="checked" <?php  } ?>>
+				   </td>
+				</tr>
+				<tr>
+					<td width="20%"  class="fontstyle_searchoptions">
+						<?php echo gettext("SHOW");?> :  						
+				   </td>
+				   <td width="80%"  class="fontstyle_searchoptions">				   		
+				  <?php echo gettext("Answered Calls")?>
+				  <input name="terminatecauseid" type="radio" value="ANSWER" <?php if((!isset($terminatecauseid))||($terminatecauseid=="ANSWER")){?>checked<?php }?> /> 
+				  <?php echo gettext("All Calls")?>	
+				   <input name="terminatecauseid" type="radio" value="ALL" <?php if($terminatecauseid=="ALL"){?>checked<?php }?>/>
+					</td>
+				</tr>
+				<tr class="bgcolor_005">
+					<td  class="fontstyle_searchoptions">
+						<?php echo gettext("GROUP BY DAY");?> : 
+				   </td>
+				   <td  class="fontstyle_searchoptions">
+				   <?php echo gettext("Yes")?>
+				  <input name="grouped" type="radio" value="1" <?php if($grouped){?>checked<?php }?> /> 
+				  <?php echo gettext("NO")?>
+				  <input name="grouped" type="radio" value="0" <?php if((!isset($grouped))||(!$grouped)){?>checked<?php }?>/>
+					</td>
+				</tr>
+				<tr>
+					<td  class="fontstyle_searchoptions">
+						<?php echo gettext("RESULT");?> :
+					</td>
+					<td  class="fontstyle_searchoptions">
+						
+	
+					<?php echo gettext("Mins");?> <input type="radio" NAME="resulttype" value="min" <?php if((!isset($resulttype))||($resulttype=="min")){?>checked<?php }?>> - <?php echo gettext("Secs")?> <input type="radio" NAME="resulttype" value="sec" <?php if($resulttype=="sec"){?>checked<?php }?>>
+
+					</td>
+				</tr>
+				<tr class="bgcolor_005">
+					<td  class="fontstyle_searchoptions">
+						<?php echo gettext("CURRENCY");?> : 
+				   </td>
+				   <td  class="fontstyle_searchoptions">
+				<select NAME="choose_currency" size="1" class="form_input_select">
+							<?php
+								$currencies_list = get_currencies();
+								foreach($currencies_list as $key => $cur_value) {
+							?>
+								<option value='<?php echo $key ?>' <?php if (($choose_currency==$key) || (!isset($choose_currency) && $key==strtoupper(BASE_CURRENCY))){?>selected<?php } ?>><?php echo $cur_value[1].' ('.$cur_value[2].')' ?>
+								</option>
+							<?php 	} ?>
+						</select>   
+					</td>
+				</tr>
+				</table>
+			   </td>
+				</tr>
+				</table>
+			  </td>
+			  </tr>
+			<!-- Select Option : to show just the Answered Calls or all calls, Result type, currencies... -->
+			<tr>
+        		<td class="bgcolor_004" align="left" > </td>
+				<td class="bgcolor_005" align="center" >
+					<input type="image"  name="image16" align="top" border="0" src="<?php echo Images_Path;?>/button-search.gif" />
+	  			</td>
+    		</tr>
+		</tbody></table>
+	</FORM>
+</center>
+<br><br>
+
+<!-- ** ** ** ** ** Part to display the CDR ** ** ** ** ** -->
+<?php if (!$nodisplay) { ?>
+<table width="<?php echo $FG_HTML_TABLE_WIDTH?>" border="0" align="center" cellpadding="0" cellspacing="0">
+	<TR bgcolor="#ffffff">
+		<TD class="bgcolor_021" height=16 style="PADDING-LEFT: 5px; PADDING-RIGHT: 3px">
+		<TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
+			<TR>
+				<TD><SPAN class="fontstyle_003"><?php echo $FG_HTML_TABLE_TITLE?></SPAN></TD>
+			</TR>
+		</TABLE>
+		</TD>
+	</TR>
+        <TR> 
+          <TD> <TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
+                <TR class="bgcolor_008"> 
+				  
+                  <?php 
+				  	if (is_array($list) && count($list)>0){
+					
+				  	for($i=0;$i<$FG_NB_TABLE_COL;$i++){ 
+					?>				
+				  
+					
+                  <TD width="<?php echo $FG_TABLE_COL[$i][2]?>" align=middle class="tableBody" style="PADDING-BOTTOM: 2px; PADDING-LEFT: 2px; PADDING-RIGHT: 2px; PADDING-TOP: 2px"> 
+                    <center><strong> 
+                    <?php  if (strtoupper($FG_TABLE_COL[$i][4])=="SORT"){?>
+                    <a href="<?php  echo $PHP_SELF."?s=1&t=0&stitle=$stitle&atmenu=$atmenu&current_page=$current_page&order=".$FG_TABLE_COL[$i][1]."&sens="; if ($sens=="ASC"){echo"DESC";}else{echo"ASC";} 
+					echo "&topsearch=$topsearch&inputtopvar=$inputtopvar&posted=$posted&Period=$Period&frommonth=$frommonth&fromstatsmonth=$fromstatsmonth&tomonth=$tomonth&tostatsmonth=$tostatsmonth&fromday=$fromday&fromstatsday_sday=$fromstatsday_sday&fromstatsmonth_sday=$fromstatsmonth_sday&today=$today&tostatsday_sday=$tostatsday_sday&tostatsmonth_sday=$tostatsmonth_sday&resulttype=$resulttype&terminatecauseid=$terminatecauseid&grouped=$grouped";?>"> 
+                    <span class="liens"><?php  } ?>
+                    <?php echo $FG_TABLE_COL[$i][0]?> 
+                    <?php if ($order==$FG_TABLE_COL[$i][1] && $sens=="ASC"){?>
+                    &nbsp;<img src="<?php echo Images_Path;?>/icon_up_12x12.GIF" width="12" height="12" border="0"> 
+                    <?php }elseif ($order==$FG_TABLE_COL[$i][1] && $sens=="DESC"){?>
+                    &nbsp;<img src="<?php echo Images_Path;?>/icon_down_12x12.GIF" width="12" height="12" border="0"> 
+                    <?php }?>
+                    <?php  if (strtoupper($FG_TABLE_COL[$i][4])=="SORT"){?>
+                    </span></a> 
+                    <?php }?>
+                    </strong></center></TD>
+				   <?php } ?>
+                </TR>
+                
+				<?php
+				  	 $ligne_number=0;
+				  	 foreach ($list as $recordset) {
+						 $ligne_number++;
+				?>
+               		 <TR bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$ligne_number%2]?>"  onMouseOver="bgColor='#C4FFD7'" onMouseOut="bgColor='<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$ligne_number%2]?>'"> 
+							 
+					<?php 
+						for($i=0;$i<$FG_NB_TABLE_COL;$i++) {
+							
+							$record_display = $recordset[$i];
+							if ( is_numeric($FG_TABLE_COL[$i][5]) && (strlen($record_display) > $FG_TABLE_COL[$i][5])  ){
+								$record_display = substr($record_display, 0, $FG_TABLE_COL[$i][5]-3)."";  
+							} ?>
+	                 		 <TD vAlign=top align="<?php echo $FG_TABLE_COL[$i][3]?>" class=tableBody><?php 
+							 if (isset ($FG_TABLE_COL[$i][11]) && strlen($FG_TABLE_COL[$i][11])>1) {
+							 		call_user_func($FG_TABLE_COL[$i][11], $record_display);
+							 } else {
+							 		echo stripslashes($record_display);
+							 }				 
+						 ?></TD>
+				 	<?php  
+				 		} ?>
+					</TR>
+				<?php
+					 }//foreach ($list as $recordset)
+					 if ($ligne_number < $FG_LIMITE_DISPLAY)
+					 	$ligne_number_end=$ligne_number +2;
+					 
+					 while ($ligne_number < $ligne_number_end) {
+					 	$ligne_number++;
+				?>
+					<TR bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$ligne_number%2]?>"> 
+				  		<?php 
+				  			for($i=0;$i<$FG_NB_TABLE_COL;$i++) { 
+				 		 ?>
+                 		 <TD vAlign=top class=tableBody>&nbsp;</TD>
+				 		 <?php  } ?>
+                 		 <TD align="center" vAlign=top class=tableBodyRight>&nbsp;</TD>				
+					</TR>
+									
+				<?php					 
+					 } //END_WHILE
+					 
+				  }else{
+				  		echo gettext("No data found !!!");
+				  }//end_if
+				 ?>
+                
+            </TABLE></td>
+        </tr>
+      
+      </table>
+<br>
+<?php
+}
+$smarty->display('footer.tpl');
+
diff -rupN a2billing.orig/admin/Public/call-log-customers-history.php a2billing/admin/Public/call-log-customers-history.php
--- a2billing.orig/admin/Public/call-log-customers-history.php	1969-12-31 21:00:00.000000000 -0300
+++ a2billing/admin/Public/call-log-customers-history.php	2012-09-20 14:09:25.081341712 -0300
@@ -0,0 +1,1386 @@
+<?php
+
+/* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4: */
+
+/**
+ * This file is part of A2Billing (http://www.a2billing.net/)
+ *
+ * A2Billing, Commercial Open Source Telecom Billing platform,   
+ * powered by Star2billing S.L. <http://www.star2billing.com/>
+ * 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
+ * @author      Belaid Arezqui <areski@gmail.com>
+ * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
+ * @package     A2Billing
+ *
+ * Software License Agreement (GNU Affero General Public License)
+ *
+ * This program is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU Affero General Public License as
+ * published by the Free Software Foundation, either version 3 of the
+ * License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Affero General Public License for more details.
+ *
+ * You should have received a copy of the GNU Affero General Public License
+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
+ * 
+ * 
+**/
+
+
+include ("../lib/admin.defines.php");
+include ("../lib/admin.module.access.php");
+include ("../lib/admin.smarty.php");
+
+if (! has_rights ( ACX_CALL_REPORT )) {
+	Header ( "HTTP/1.0 401 Unauthorized" );
+	Header ( "Location: PP_error.php?c=accessdenied" );
+	die ();
+}
+
+getpost_ifset ( array ('customer', 'sellrate', 'buyrate', 'entercustomer','entercustomer_num', 'enterprovider', 'entertariffgroup', 'entertrunk', 'enterratecard', 'posted', 'Period', 'frommonth', 'fromstatsmonth', 'tomonth', 'tostatsmonth', 'fromday', 'fromstatsday_sday', 'fromstatsmonth_sday', 'today', 'tostatsday_sday', 'tostatsmonth_sday', 'fromtime', 'totime', 'fromstatsday_hour', 'tostatsday_hour', 'fromstatsday_min', 'tostatsday_min', 'dsttype', 'srctype', 'dnidtype', 'clidtype', 'channel', 'resulttype', 'stitle', 'atmenu', 'current_page', 'order', 'sens', 'dst', 'src', 'dnid', 'clid', 'choose_currency', 'terminatecauseid', 'choose_calltype', 'download', 'file') );
+
+if (($download == "file") && $file) {
+	
+	if (strpos($file, '/') !== false) exit;
+	
+	$value_de = base64_decode ( $file );
+	$dl_full = MONITOR_PATH . "/" . $value_de;
+	$dl_name = $value_de;
+	
+	if (! file_exists ( $dl_full )) {
+		echo gettext ( "ERROR: Cannot download file " . $dl_full . ", it does not exist.<br>" );
+		exit ();
+	}
+	
+	header ( "Content-Type: application/octet-stream" );
+	header ( "Content-Disposition: attachment; filename=$dl_name" );
+	header ( "Content-Length: " . filesize ( $dl_full ) );
+	header ( "Accept-Ranges: bytes" );
+	header ( "Pragma: no-cache" );
+	header ( "Expires: 0" );
+	header ( "Cache-Control: must-revalidate, post-check=0, pre-check=0" );
+	header ( "Content-transfer-encoding: binary" );
+	
+	@readfile ( $dl_full );
+	exit ();
+}
+
+$dialstatus_list = Constants::getDialStatusList ();
+
+if (! isset ( $current_page ) || ($current_page == "")) {
+	$current_page = 0;
+}
+
+// this variable specifie the debug type (0 => nothing, 1 => sql result, 2 => boucle checking, 3 other value checking)
+$FG_DEBUG = 0;
+
+// The variable FG_TABLE_NAME define the table name to use
+$FG_TABLE_NAME = "cc_call_archive t1 LEFT OUTER JOIN cc_trunk t3 ON t1.id_trunk = t3.id_trunk LEFT OUTER JOIN cc_ratecard t4 ON t1.id_ratecard = t4.id";
+
+
+
+// THIS VARIABLE DEFINE THE COLOR OF THE HEAD TABLE
+$FG_TABLE_ALTERNATE_ROW_COLOR [] = "#FFFFFF";
+$FG_TABLE_ALTERNATE_ROW_COLOR [] = "#F2F8FF";
+
+$yesno = array ();
+$yesno ["1"] = array ("Yes", "1" );
+$yesno ["0"] = array ("No", "0" );
+
+// 0 = NORMAL CALL ; 1 = VOIP CALL (SIP/IAX) ; 2= DIDCALL + TRUNK ; 3 = VOIP CALL DID ; 4 = CALLBACK call
+$list_calltype = array ();
+$list_calltype ["0"] = array (gettext("STANDARD"), "0" );
+$list_calltype ["1"] = array (gettext("SIP/IAX"), "1" );
+$list_calltype ["2"] = array (gettext("DIDCALL"), "2" );
+$list_calltype ["3"] = array (gettext("DID_VOIP"), "3" );
+$list_calltype ["4"] = array (gettext("CALLBACK"), "4" );
+$list_calltype ["5"] = array (gettext("PREDICT"), "5" );
+$list_calltype ["6"] = array (gettext("AUTO DIALER"), "6" );
+$list_calltype ["7"] = array (gettext("DID-ALEG"), "7" );
+
+$FG_TABLE_DEFAULT_ORDER = "t1.starttime";
+$FG_TABLE_DEFAULT_SENS = "DESC";
+
+
+$DBHandle = DbConnect ();
+
+$FG_TABLE_COL = array ();
+$FG_TABLE_COL [] = array (gettext ( "Date" ), "starttime", "10%", "center", "SORT", "19", "", "", "", "", "", "display_dateformat" );
+$FG_TABLE_COL [] = array (gettext ( "CallerID" ), "src", "7%", "center", "SORT", "30" );
+$FG_TABLE_COL [] = array (gettext ( "DNID" ), "dnid", "7%", "center", "SORT", "30" );
+$FG_TABLE_COL [] = array (gettext ( "Phone Number" ), "calledstation", "10%", "center", "SORT", "30", "", "", "", "", "", "" );
+$FG_TABLE_COL [] = array (gettext ( "Destination" ), "dest","10%", "center", "SORT", "15", "lie", "cc_prefix", "destination,prefix", "prefix='%id'", "%1" );
+$FG_TABLE_COL [] = array (gettext ( "Buy Rate" ), "buyrate", "6%", "center", "SORT", "30", "", "", "", "", "", "display_2bill" );
+$FG_TABLE_COL [] = array (gettext ( "Sell Rate" ), "rateinitial", "6%", "center", "SORT", "30", "", "", "", "", "", "display_2bill" );
+$FG_TABLE_COL [] = array (gettext ( "Duration" ), "sessiontime", "5%", "center", "SORT", "30", "", "", "", "", "", "display_minute" );
+$FG_TABLE_COL [] = array (gettext ( "Account" ), "card_id", "6%", "center", "sort", "", "lie_link", "cc_card", "username,id", "id='%id'", "%1", "", "A2B_entity_card.php" );
+$FG_TABLE_COL [] = array (gettext ( "Trunk" ), "trunkcode", "6%", "center", "SORT", "30" );
+$FG_TABLE_COL [] = array ('<acronym title="' . gettext ( "Terminate Cause" ) . '">' . gettext ( "TC" ) . '</acronym>', "terminatecauseid", "7%", "center", "SORT", "", "list", $dialstatus_list );
+$FG_TABLE_COL [] = array (gettext ( "CallType" ), "sipiax", "6%", "center", "SORT", "", "list", $list_calltype );
+$FG_TABLE_COL [] = array (gettext ( "Buy" ), "buycost", "7%", "center", "SORT", "30", "", "", "", "", "", "display_2bill" );
+$FG_TABLE_COL [] = array (gettext ( "Sell" ), "sessionbill", "7%", "center", "SORT", "30", "", "", "", "", "", "display_2bill" );
+$FG_TABLE_COL [] = array (gettext ( "Margin" ), "margin", "7%", "center", "SORT", "30", "", "", "", "", "", "display_2dec_percentage" );
+$FG_TABLE_COL [] = array (gettext ( "Markup" ), "markup", "7%", "center", "SORT", "30", "", "", "", "", "", "display_2dec_percentage" );
+
+if (LINK_AUDIO_FILE) {
+	$FG_TABLE_COL [] = array ("", "uniqueid", "1%", "center", "", "30", "", "", "", "", "", "linkonmonitorfile" );
+}
+
+if (has_rights (ACX_DELETE_CDR)) {
+	$FG_TABLE_COL [] = array ("", "id", "1%", "center", "", "30", "", "", "", "", "", "linkdelete_cdr" );
+}
+
+// This Variable store the argument for the SQL query
+$FG_COL_QUERY = 't1.starttime, t1.src, t1.dnid, t1.calledstation, t1.destination AS dest, t4.buyrate, t4.rateinitial, t1.sessiontime, t1.card_id, t3.trunkcode, t1.terminatecauseid, t1.sipiax, t1.buycost, t1.sessionbill, case when t1.sessionbill!=0 then ((t1.sessionbill-t1.buycost)/t1.sessionbill)*100 else NULL end as margin,case when t1.buycost!=0 then ((t1.sessionbill-t1.buycost)/t1.buycost)*100 else NULL end as markup';
+
+if (LINK_AUDIO_FILE) {
+	$FG_COL_QUERY .= ', t1.uniqueid';
+}
+if (has_rights (ACX_DELETE_CDR)) {
+	$FG_COL_QUERY .= ', t1.id';
+}
+$FG_COL_QUERY_GRAPH = 't1.callstart, t1.duration';
+
+$FG_LIMITE_DISPLAY = 25;
+$FG_NB_TABLE_COL = count ( $FG_TABLE_COL );
+$FG_EDITION = true;
+$FG_TOTAL_TABLE_COL = $FG_NB_TABLE_COL;
+if ($FG_DELETION || $FG_EDITION)
+	$FG_TOTAL_TABLE_COL ++;
+
+$FG_HTML_TABLE_TITLE = gettext ( " - Call Logs - " );
+$FG_HTML_TABLE_WIDTH = '98%';
+
+
+$instance_table = new Table ( $FG_TABLE_NAME, $FG_COL_QUERY );
+
+if (is_null ( $order ) || is_null ( $sens )) {
+	$order = $FG_TABLE_DEFAULT_ORDER;
+	$sens = $FG_TABLE_DEFAULT_SENS;
+}
+
+if ($posted == 1) {
+	$SQLcmd = '';
+	$SQLcmd = do_field ( $SQLcmd, 'src', 'src' );
+	$SQLcmd = do_field ( $SQLcmd, 'dst', 'calledstation' );
+	$SQLcmd = do_field ( $SQLcmd, 'dnid', 'dnid' );
+}
+
+$date_clause = '';
+
+normalize_day_of_month($fromstatsday_sday, $fromstatsmonth_sday, 1);
+normalize_day_of_month($tostatsday_sday, $tostatsmonth_sday, 1);
+// Date Clause
+if ($fromday && isset ( $fromstatsday_sday ) && isset ( $fromstatsmonth_sday )) {
+	if ($fromtime) {
+		$date_clause .= " AND t1.starttime >= ('$fromstatsmonth_sday-$fromstatsday_sday $fromstatsday_hour:$fromstatsday_min')";
+	} else {
+		$date_clause .= " AND t1.starttime >= ('$fromstatsmonth_sday-$fromstatsday_sday')";
+	}
+}
+if ($today && isset ( $tostatsday_sday ) && isset ( $tostatsmonth_sday )) {
+	if ($totime) {
+		$date_clause .= " AND t1.starttime <= ('$tostatsmonth_sday-" . sprintf ( "%02d", intval ( $tostatsday_sday )/*+1*/) . " $tostatsday_hour:$tostatsday_min:59')";
+	} else {
+		$date_clause .= " AND t1.starttime <= ('$tostatsmonth_sday-" . sprintf ( "%02d", intval ( $tostatsday_sday )/*+1*/) . " 23:59:59')";
+	}
+}
+
+
+if (strpos ( $SQLcmd, 'WHERE' ) > 0) {
+	$FG_TABLE_CLAUSE = substr ( $SQLcmd, 6 ) . $date_clause;
+} elseif (strpos ( $date_clause, 'AND' ) > 0) {
+	$FG_TABLE_CLAUSE = substr ( $date_clause, 5 );
+}
+
+if (! isset ( $FG_TABLE_CLAUSE ) || strlen ( $FG_TABLE_CLAUSE ) == 0) {
+	$cc_yearmonth = sprintf ( "%04d-%02d-%02d", date ( "Y" ), date ( "n" ), date ( "d" ) );
+	$FG_TABLE_CLAUSE = " t1.starttime >= ('$cc_yearmonth')";
+}
+
+if (isset ( $customer ) && ($customer > 0)) {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= "t1.card_id='$customer'";
+} else {
+	if (isset ( $entercustomer ) && ($entercustomer > 0)) {
+		if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+			$FG_TABLE_CLAUSE .= " AND ";
+		$FG_TABLE_CLAUSE .= "t1.card_id='$entercustomer'";
+	}elseif(isset ( $entercustomer_num ) && ($entercustomer_num > 0)) {
+		$res = $DBHandle -> Execute ("select id from cc_card where username=".$entercustomer_num);
+		if ($res){
+			if($res->RecordCount ()){
+				$row =$res -> fetchRow();
+				if (strlen ( $FG_TABLE_CLAUSE ) > 0)	$FG_TABLE_CLAUSE .= " AND ";
+				$FG_TABLE_CLAUSE .= "t1.card_id='$row[0]'";
+			}
+		}
+	}
+}
+
+if (isset ( $enterprovider ) && $enterprovider > 0) {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= "t3.id_provider = '$enterprovider'";
+}
+if (isset ( $entertrunk ) && $entertrunk > 0) {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= "t3.id_trunk = '$entertrunk'";
+}
+if (isset ( $entertariffgroup ) && $entertariffgroup > 0) {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= "t1.id_tariffgroup = '$entertariffgroup'";
+}
+if (isset ( $enterratecard ) && $enterratecard > 0) {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= "t1.id_ratecard = '$enterratecard'";
+}
+
+
+
+
+if (isset ( $choose_calltype ) && ($choose_calltype != - 1)) {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= " t1.sipiax='$choose_calltype' ";
+}
+
+$FG_ASR_CIC_CLAUSE = $FG_TABLE_CLAUSE;
+
+//To select just terminatecauseid=ANSWER
+if (! isset ( $terminatecauseid )) {
+	$terminatecauseid = "ANSWER";
+}
+if ($terminatecauseid == "ANSWER") {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= " (t1.terminatecauseid=1) ";
+}
+if ($terminatecauseid == "INCOMPLET") {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= " (t1.terminatecauseid !=1) ";
+}
+if ($terminatecauseid == "CONGESTION") {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= " (t1.terminatecauseid=5) ";
+}
+if ($terminatecauseid == "NOANSWER") {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= " (t1.terminatecauseid=3) ";
+}
+if ($terminatecauseid == "BUSY") {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= " (t1.terminatecauseid=2) ";
+}
+if ($terminatecauseid == "CHANUNAVAIL") {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= " (t1.terminatecauseid=6) ";
+}
+if ($terminatecauseid == "CANCEL") {
+	if (strlen ( $FG_TABLE_CLAUSE ) > 0)
+		$FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= " (t1.terminatecauseid=4) ";
+}
+
+if (! $nodisplay) {
+	$list = $instance_table->Get_list ( $DBHandle, $FG_TABLE_CLAUSE, $order, $sens, null, null, $FG_LIMITE_DISPLAY, $current_page * $FG_LIMITE_DISPLAY );
+}
+
+// EXPORT
+$FG_EXPORT_SESSION_VAR = "pr_export_entity_call";
+
+// Query Preparation for the Export Functionality
+$_SESSION [$FG_EXPORT_SESSION_VAR] = "SELECT $FG_COL_QUERY FROM $FG_TABLE_NAME WHERE $FG_TABLE_CLAUSE";
+
+if (! is_null ( $order ) && ($order != '') && ! is_null ( $sens ) && ($sens != '')) {
+	$_SESSION [$FG_EXPORT_SESSION_VAR] .= " ORDER BY $order $sense";
+}
+
+/************************/
+$QUERY = "SELECT DATE(t1.starttime) AS day, sum(t1.sessiontime) AS calltime, sum(t1.sessionbill) AS cost, count(*) as nbcall,
+           sum(t1.buycost) AS buy, sum(case when t1.sessiontime>0 then 1 else 0 end) as success_calls
+        	FROM $FG_TABLE_NAME WHERE $FG_TABLE_CLAUSE GROUP BY day ORDER BY day"; //extract(DAY from calldate)
+
+if (! $nodisplay) {
+	$res = $DBHandle->Execute ( $QUERY );
+	if ($res) {
+		$num = $res->RecordCount ();
+		for($i = 0; $i < $num; $i ++) {
+			$list_total_day [] = $res->fetchRow ();
+		}
+	}
+	
+	if ($FG_DEBUG == 3)
+		echo "<br>Clause : $FG_TABLE_CLAUSE";
+	
+	$nb_record = $instance_table->Table_count ( $DBHandle, $FG_TABLE_CLAUSE );
+	if ($FG_DEBUG >= 1)
+		var_dump ( $list );
+
+}
+
+
+if ($nb_record <= $FG_LIMITE_DISPLAY) {
+	$nb_record_max = 1;
+} else {
+	if ($nb_record % $FG_LIMITE_DISPLAY == 0) {
+		$nb_record_max = (intval ( $nb_record / $FG_LIMITE_DISPLAY ));
+	} else {
+		$nb_record_max = (intval ( $nb_record / $FG_LIMITE_DISPLAY ) + 1);
+	}
+}
+
+if ($FG_DEBUG == 3)
+	echo "<br>Nb_record : $nb_record";
+if ($FG_DEBUG == 3)
+	echo "<br>Nb_record_max : $nb_record_max";
+
+$smarty->display ( 'main.tpl' );
+
+?>
+
+
+<!-- ** ** ** ** ** Part for the research ** ** ** ** ** -->
+<center>
+<FORM METHOD=POST name="myForm"
+	ACTION="<?php
+	echo $PHP_SELF?>?s=1&t=0&order=<?php
+	echo $order?>&sens=<?php
+	echo $sens?>&current_page=<?php
+	echo $current_page?>">
+<INPUT TYPE="hidden" NAME="posted" value=1> <INPUT TYPE="hidden"
+	NAME="current_page" value=0>
+<TABLE class="bar-status" width="85%" border="0" cellspacing="1"
+	cellpadding="2" align="center">
+		<?php
+		if ($_SESSION ["pr_groupID"] == 2 && is_numeric ( $_SESSION ["pr_IDCust"] )) {
+			?>
+		<?php
+		} else {
+			?>
+		<tr>
+		<td align="left" valign="top" class="bgcolor_004"><font
+			class="fontstyle_003">&nbsp;&nbsp;<?php
+			echo gettext ( "CUSTOMERS" );
+			?></font>
+		</td>
+		<td class="bgcolor_005" align="left">
+		<table width="100%" border="0" cellspacing="0" cellpadding="0">
+			<tr>
+				<td class="fontstyle_searchoptions" width="700" valign="top">
+					<?php
+			echo gettext ( "Enter the customer ID" );
+			?>: <INPUT TYPE="text"
+					NAME="entercustomer" value="<?php echo $entercustomer?>"
+					class="form_input_text"> <a href="#"
+					onclick="window.open('A2B_entity_card.php?popup_select=1&popup_formname=myForm&popup_fieldname=entercustomer' , 'CardNumberSelection','scrollbars=1,width=550,height=330,top=20,left=100,scrollbars=1');"><img
+					src="<?php echo Images_Path; ?>/icon_arrow_orange.gif"></a>
+				 <BR> OR <br>
+				<?php echo gettext ( "Enter the customer number" );?>: <INPUT TYPE="text" NAME="entercustomer_num" 
+					value="<?php echo $entercustomer_num?>" class="form_input_text"> <a href="#"
+                                        onclick="window.open('A2B_entity_card.php?popup_select=2&popup_formname=myForm&popup_fieldname=entercustomer_num' , 'CardNumberSelection','scrollbars=1,width=550,height=330,top=20,left=100,scrollbars=1');"><img
+                                        src="<?php echo Images_Path; ?>/icon_arrow_orange.gif"></a>
+				</td>
+				<td width="50%">
+				<table width="100%" border="0" cellspacing="0" cellpadding="0">
+					<tr>
+						<td align="left" class="fontstyle_searchoptions"><?php echo gettext ( "CallPlan" ); ?> :</td>
+						<td align="left" class="fontstyle_searchoptions"><INPUT TYPE="text" NAME="entertariffgroup" value="<?php echo $entertariffgroup?>" size="4" class="form_input_text">&nbsp;<a href="#" onclick="window.open('A2B_entity_tariffgroup.php?popup_select=2&popup_formname=myForm&popup_fieldname=entertariffgroup' , 'CallPlanSelection','scrollbars=1,width=550,height=330,top=20,left=100');"><img
+							src="<?php echo Images_Path; ?>/icon_arrow_orange.gif"></a></td>
+						<td align="left" class="fontstyle_searchoptions"><?php echo gettext ( "Provider" ); ?> :
+			
+			<td align="left" class="fontstyle_searchoptions"><INPUT
+							TYPE="text" NAME="enterprovider"
+							value="<?php echo $enterprovider?>" size="4" class="form_input_text">&nbsp;<a href="#"
+							onclick="window.open('A2B_entity_provider.php?popup_select=2&popup_formname=myForm&popup_fieldname=enterprovider' , 'ProviderSelection','scrollbars=1,width=550,height=330,top=20,left=100');"><img
+							src="<?php echo Images_Path; ?>/icon_arrow_orange.gif"></a></td>
+					</tr>
+					<tr>
+						<td align="left" class="fontstyle_searchoptions"><?php echo gettext ( "Trunk" ); ?> :</td>
+						<td align="left" class="fontstyle_searchoptions"><INPUT
+							TYPE="text" NAME="entertrunk" value="<?php
+			echo $entertrunk?>"
+							size="4" class="form_input_text">&nbsp;<a href="#"
+							onclick="window.open('A2B_entity_trunk.php?popup_select=2&popup_formname=myForm&popup_fieldname=entertrunk' , 'TrunkSelection','scrollbars=1,width=550,height=330,top=20,left=100');"><img
+							src="<?php
+			echo Images_Path;
+			?>/icon_arrow_orange.gif"></a></td>
+						<td align="left" class="fontstyle_searchoptions"><?php
+			echo gettext ( "Rate" );
+			?> :</td>
+						<td align="left" class="fontstyle_searchoptions"><INPUT
+							TYPE="text" NAME="enterratecard"
+							value="<?php
+			echo $enterratecard?>" size="4"
+							class="form_input_text">&nbsp;<a href="#"
+							onclick="window.open('A2B_entity_def_ratecard.php?popup_select=2&popup_formname=myForm&popup_fieldname=enterratecard' , 'RatecardSelection','scrollbars=1,width=550,height=330,top=20,left=100');"><img
+							src="<?php
+			echo Images_Path;
+			?>/icon_arrow_orange.gif"></a></td>
+					</tr>
+				</table>
+				</td>
+			</tr>
+
+		</table>
+		</td>
+	</tr>			
+		<?php
+		}
+		?>
+	<tr>
+		<td align="left" class="bgcolor_004"><font class="fontstyle_003">&nbsp;&nbsp;<?php echo gettext ( "DATE" ); ?></font>
+		</td>
+		<td align="left" class="bgcolor_005">
+		<table width="100%" border="0" cellspacing="0" cellpadding="0">
+			<tr>
+				<td class="fontstyle_searchoptions"><input type="checkbox"
+					name="fromday" value="true" <?php
+					if ($fromday) {
+						?> checked
+					<?php
+					}
+					?>> <?php
+					echo gettext ( "From" );
+					?> :
+				<select name="fromstatsday_sday" class="form_input_select">
+					<?php
+					for($i = 1; $i <= 31; $i ++) {
+						if ($fromstatsday_sday == sprintf ( "%02d", $i ))
+							$selected = "selected";
+						else
+							$selected = "";
+						echo '<option value="' . sprintf ( "%02d", $i ) . "\"$selected>" . sprintf ( "%02d", $i ) . '</option>';
+					}
+					?>	
+				</select> <select name="fromstatsmonth_sday"
+					class="form_input_select">
+				<?php
+				$year_actual = date ( "Y" );
+				$monthname = array (gettext ( "January" ), gettext ( "February" ), gettext ( "March" ), gettext ( "April" ), gettext ( "May" ), gettext ( "June" ), gettext ( "July" ), gettext ( "August" ), gettext ( "September" ), gettext ( "October" ), gettext ( "November" ), gettext ( "December" ) );
+				
+				for($i = $year_actual; $i >= $year_actual - 1; $i --) {
+					if ($year_actual == $i) {
+						$monthnumber = date ( "n" ) - 1; // Month number without lead 0.
+					} else {
+						$monthnumber = 11;
+					}
+					for($j = $monthnumber; $j >= 0; $j --) {
+						$month_formated = sprintf ( "%02d", $j + 1 );
+						if ($fromstatsmonth_sday == "$i-$month_formated")
+							$selected = "selected";
+						else
+							$selected = "";
+						echo "<OPTION value=\"$i-$month_formated\" $selected> $monthname[$j]-$i </option>";
+					}
+				}
+				?>
+				</select> <br />
+				<input type="checkbox" name="fromtime" value="true"
+					<?php
+					if ($fromtime) {
+						?> checked <?php
+					}
+					?>> 
+				<?php
+				echo gettext ( "Time :" )?>
+				<select name="fromstatsday_hour" class="form_input_select">
+				<?php
+				for($i = 0; $i <= 23; $i ++) {
+					if ($fromstatsday_hour == sprintf ( "%02d", $i )) {
+						$selected = "selected";
+					} else {
+						$selected = "";
+					}
+					echo '<option value="' . sprintf ( "%02d", $i ) . "\"$selected>" . sprintf ( "%02d", $i ) . '</option>';
+				}
+				?>						
+				</select> : <select name="fromstatsday_min"
+					class="form_input_select">
+				<?php
+				for($i = 0; $i < 60; $i = $i + 5) {
+					if ($fromstatsday_min == sprintf ( "%02d", $i )) {
+						$selected = "selected";
+					} else {
+						$selected = "";
+					}
+					echo '<option value="' . sprintf ( "%02d", $i ) . "\"$selected>" . sprintf ( "%02d", $i ) . '</option>';
+				}
+				?>						
+				</select></td>
+				<td class="fontstyle_searchoptions"><input type="checkbox"
+					name="today" value="true" <?php
+					if ($today) {
+						?> checked <?php
+					}
+					?>> 
+				<?php
+				echo gettext ( "To" );
+				?>  :
+				<select name="tostatsday_sday" class="form_input_select">
+				<?php
+				for($i = 1; $i <= 31; $i ++) {
+					if ($tostatsday_sday == sprintf ( "%02d", $i )) {
+						$selected = "selected";
+					} else {
+						$selected = "";
+					}
+					echo '<option value="' . sprintf ( "%02d", $i ) . "\"$selected>" . sprintf ( "%02d", $i ) . '</option>';
+				}
+				?>						
+				</select> <select name="tostatsmonth_sday" class="form_input_select">
+				<?php
+				$year_actual = date ( "Y" );
+				for($i = $year_actual; $i >= $year_actual - 1; $i --) {
+					if ($year_actual == $i) {
+						$monthnumber = date ( "n" ) - 1; // Month number without lead 0.
+					} else {
+						$monthnumber = 11;
+					}
+					for($j = $monthnumber; $j >= 0; $j --) {
+						$month_formated = sprintf ( "%02d", $j + 1 );
+						if ($tostatsmonth_sday == "$i-$month_formated")
+							$selected = "selected";
+						else
+							$selected = "";
+						echo "<OPTION value=\"$i-$month_formated\" $selected> $monthname[$j]-$i </option>";
+					}
+				}
+				?>
+				</select> <br />
+				<input type="checkbox" name="totime" value="true"
+					<?php
+					if ($totime) {
+						?> checked <?php
+					}
+					?>> 
+				<?php
+				echo gettext ( "Time :" )?>
+				<select name="tostatsday_hour" class="form_input_select">
+				<?php
+				for($i = 0; $i <= 23; $i ++) {
+					if ($tostatsday_hour == sprintf ( "%02d", $i )) {
+						$selected = "selected";
+					} else {
+						$selected = "";
+					}
+					echo '<option value="' . sprintf ( "%02d", $i ) . "\"$selected>" . sprintf ( "%02d", $i ) . '</option>';
+				}
+				?>						
+				</select> : <select name="tostatsday_min" class="form_input_select">
+				<?php
+				for($i = 0; $i < 60; $i = $i + 5) {
+					if ($tostatsday_min == sprintf ( "%02d", $i )) {
+						$selected = "selected";
+					} else {
+						$selected = "";
+					}
+					echo '<option value="' . sprintf ( "%02d", $i ) . "\"$selected>" . sprintf ( "%02d", $i ) . '</option>';
+				}
+				?>						
+				</select></td>
+			</tr>
+		</table>
+		</td>
+	</tr>
+	<tr>
+		<td class="bgcolor_002" align="left"><font class="fontstyle_003">&nbsp;&nbsp;<?php
+		echo gettext ( "PHONENUMBER" );
+		?></font>
+		</td>
+		<td class="bgcolor_003" align="left">
+		<table width="100%" border="0" cellspacing="0" cellpadding="0">
+			<tr>
+				<td>&nbsp;&nbsp;<INPUT TYPE="text" NAME="dst"
+					value="<?php
+					echo $dst?>" class="form_input_text"></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="dsttype" value="1"
+					<?php
+					if ((! isset ( $dsttype )) || ($dsttype == 1)) {
+						?> checked <?php
+					}
+					?>><?php
+					echo gettext ( "Exact" );
+					?></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="dsttype" value="2" <?php
+					if ($dsttype == 2) {
+						?>
+					checked <?php
+					}
+					?>><?php
+					echo gettext ( "Begins with" );
+					?></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="dsttype" value="3" <?php
+					if ($dsttype == 3) {
+						?>
+					checked <?php
+					}
+					?>><?php
+					echo gettext ( "Contains" );
+					?></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="dsttype" value="4" <?php
+					if ($dsttype == 4) {
+						?>
+					checked <?php
+					}
+					?>><?php
+					echo gettext ( "Ends with" );
+					?></td>
+			</tr>
+		</table>
+		</td>
+	</tr>
+	<tr>
+		<td align="left" class="bgcolor_004"><font class="fontstyle_003">&nbsp;&nbsp;<?php
+		echo gettext ( "CALLERID" );
+		?></font>
+		</td>
+		<td class="bgcolor_005" align="left">
+		<table width="100%" border="0" cellspacing="0" cellpadding="0">
+			<tr>
+				<td>&nbsp;&nbsp;<INPUT TYPE="text" NAME="src"
+					value="<?php
+					echo "$src";
+					?>" class="form_input_text"></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="srctype" value="1"
+					<?php
+					if ((! isset ( $srctype )) || ($srctype == 1)) {
+						?> checked <?php
+					}
+					?>><?php
+					echo gettext ( "Exact" );
+					?></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="srctype" value="2" <?php
+					if ($srctype == 2) {
+						?>
+					checked <?php
+					}
+					?>><?php
+					echo gettext ( "Begins with" );
+					?></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="srctype" value="3" <?php
+					if ($srctype == 3) {
+						?>
+					checked <?php
+					}
+					?>><?php
+					echo gettext ( "Contains" );
+					?></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="srctype" value="4" <?php
+					if ($srctype == 4) {
+						?>
+					checked <?php
+					}
+					?>><?php
+					echo gettext ( "Ends with" );
+					?></td>
+			</tr>
+		</table>
+		</td>
+	</tr>
+
+	<tr>
+		<td align="left" class="bgcolor_004"><font class="fontstyle_003">&nbsp;&nbsp;<?php
+		echo gettext ( "DNID" );
+		?></font>
+		</td>
+		<td class="bgcolor_005" align="left">
+		<table width="100%" border="0" cellspacing="0" cellpadding="0">
+			<tr>
+				<td>&nbsp;&nbsp;<INPUT TYPE="text" NAME="dnid"
+					value="<?php
+					echo "$dnid";
+					?>" class="form_input_text"></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="dnidtype" value="1"
+					<?php
+					if ((! isset ( $dnidtype )) || ($dnidtype == 1)) {
+						?> checked <?php
+					}
+					?>><?php
+					echo gettext ( "Exact" );
+					?></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="dnidtype" value="2" <?php
+					if ($dnidtype == 2) {
+						?>
+					checked <?php
+					}
+					?>><?php
+					echo gettext ( "Begins with" );
+					?></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="dnidtype" value="3" <?php
+					if ($dnidtype == 3) {
+						?>
+					checked <?php
+					}
+					?>><?php
+					echo gettext ( "Contains" );
+					?></td>
+				<td class="fontstyle_searchoptions" align="center"><input
+					type="radio" NAME="dnidtype" value="4" <?php
+					if ($dnidtype == 4) {
+						?>
+					checked <?php
+					}
+					?>><?php
+					echo gettext ( "Ends with" );
+					?></td>
+			</tr>
+		</table>
+		</td>
+	</tr>
+
+	<!-- Select Calltype: -->
+	<tr>
+		<td class="bgcolor_002" align="left"><font class="fontstyle_003">&nbsp;&nbsp;<?php
+		echo gettext ( "CALL TYPE" );
+		?></font></td>
+		<td class="bgcolor_003" align="center">
+		<table width="100%" border="0" cellspacing="0" cellpadding="0">
+			<tr>
+				<td class="fontstyle_searchoptions"><select NAME="choose_calltype"
+					size="1" class="form_input_select">
+					<option value='-1'
+						<?php
+						if (($choose_calltype == - 1) || (! isset ( $choose_calltype ))) {
+							?>
+						selected <?php
+						}
+						?>><?php
+						echo gettext ( 'ALL CALLS' )?>
+								</option>
+							<?php
+							foreach ( $list_calltype as $key => $cur_value ) {
+								?>
+								<option value='<?php
+								echo $cur_value [1]?>'
+						<?php
+								if ($choose_calltype == $cur_value [1]) {
+									?> selected <?php
+								}
+								?>><?php
+								echo gettext ( $cur_value [0] )?>
+								</option>
+							<?php
+							}
+							?>
+						</select></td>
+			</tr>
+		</table>
+		</td>
+	</tr>
+
+	<!-- Select Option : to show just the Answered Calls or all calls, Result type, currencies... -->
+	<tr>
+		<td class="bgcolor_002" align="left"><font class="fontstyle_003">&nbsp;&nbsp;<?php
+		echo gettext ( "OPTIONS" );
+		?></font></td>
+		<td class="bgcolor_003" align="center">
+		<div align="left">
+
+		<table width="100%" border="0" cellspacing="0" cellpadding="0">
+			<tr>
+				<td width="20%" class="fontstyle_searchoptions">
+					<?php
+					echo gettext ( "SHOW CALLS" );
+					?> :  						
+			   </td>
+				<td width="80%" class="fontstyle_searchoptions"><select
+					NAME="terminatecauseid" size="1" class="form_input_select">
+					<option value='ANSWER'
+						<?php
+						if ((! isset ( $terminatecauseid )) || ($terminatecauseid == "ANSWER")) {
+							?>
+						selected <?php
+						}
+						?>><?php
+						echo gettext ( 'ANSWERED' )?>
+							</option>
+
+					<option value='ALL' <?php
+					if ($terminatecauseid == "ALL") {
+						?> selected
+						<?php
+					}
+					?>><?php
+						echo gettext ( 'ALL' )?>
+							</option>
+
+					<option value='INCOMPLET'
+						<?php
+						if ($terminatecauseid == "INCOMPLET") {
+							?> selected <?php
+						}
+						?>><?php
+						echo gettext ( 'NOT COMPLETED' )?>
+							</option>
+
+					<option value='CONGESTION'
+						<?php
+						if ($terminatecauseid == "CONGESTION") {
+							?> selected <?php
+						}
+						?>><?php
+						echo gettext ( 'CONGESTIONED' )?>
+							</option>
+
+					<option value='BUSY' <?php
+					if ($terminatecauseid == "BUSY") {
+						?>
+						selected <?php
+					}
+					?>><?php
+						echo gettext ( 'BUSIED' )?>
+							</option>
+
+					<option value='NOANSWER'
+						<?php
+						if ($terminatecauseid == "NOANSWER") {
+							?> selected <?php
+						}
+						?>><?php
+						echo gettext ( 'NOT ANSWERED' )?>
+							</option>
+
+					<option value='CHANUNAVAIL'
+						<?php
+						if ($terminatecauseid == "CHANUNAVAIL") {
+							?> selected <?php
+						}
+						?>><?php
+						echo gettext ( 'CHANNEL UNAVAILABLE' )?>
+							</option>
+
+					<option value='CANCEL' <?php
+					if ($terminatecauseid == "CANCEL") {
+						?>
+						selected <?php
+					}
+					?>><?php
+						echo gettext ( 'CANCELED' )?>
+							</option>
+
+				</select></td>
+			</tr>
+			<tr class="bgcolor_005">
+				<td class="fontstyle_searchoptions">
+					<?php
+					echo gettext ( "RESULT" );
+					?> : 
+			   </td>
+				<td class="fontstyle_searchoptions">
+					<?php
+					echo gettext ( "mins" );
+					?><input type="radio" NAME="resulttype"
+					value="min"
+					<?php
+					if ((! isset ( $resulttype )) || ($resulttype == "min")) {
+						?> checked
+					<?php
+					}
+					?>> - <?php
+					echo gettext ( "secs" )?> <input type="radio"
+					NAME="resulttype" value="sec" <?php
+					if ($resulttype == "sec") {
+						?>
+					checked <?php
+					}
+					?>></td>
+			</tr>
+			<tr>
+				<td class="fontstyle_searchoptions">
+					<?php
+					echo gettext ( "CURRENCY" );
+					?> :
+				</td>
+				<td class="fontstyle_searchoptions"><select NAME="choose_currency"
+					size="1" class="form_input_select">
+						<?php
+						$currencies_list = get_currencies ();
+						foreach ( $currencies_list as $key => $cur_value ) {
+							?>
+							<option value='<?php
+							echo $key?>'
+						<?php
+							if (($choose_currency == $key) || (! isset ( $choose_currency ) && $key == strtoupper ( BASE_CURRENCY ))) {
+								?>
+						selected <?php
+							}
+							?>><?php
+							echo $cur_value [1] . ' (' . $cur_value [2] . ')'?>
+							</option>
+						<?php
+						}
+						?>
+					</select></td>
+			</tr>
+		</table>
+		
+		</td>
+	</tr>
+	<!-- Select Option : to show just the Answered Calls or all calls, Result type, currencies... -->
+
+	<tr>
+		<td class="bgcolor_004" align="left"></td>
+		<td class="bgcolor_005" align="center"><input type="image"
+			name="image16" align="top" border="0"
+			src="<?php
+			echo Images_Path;
+			?>/button-search.gif" /></td>
+	</tr>
+</table>
+</FORM>
+</center>
+
+
+<!-- ** ** ** ** ** Part to display the CDR ** ** ** ** ** -->
+
+<center><?php
+echo gettext ( "Number of call" );
+?> : <?php
+if (is_array ( $list ) && count ( $list ) > 0) {
+	echo $nb_record;
+} else {
+	echo "0";
+}
+?></center>
+
+<table width="<?php echo $FG_HTML_TABLE_WIDTH?>" border="0" align="center" cellpadding="0" cellspacing="0">
+	<TR bgcolor="#ffffff">
+		<TD class="bgcolor_021" height=16 style="PADDING-LEFT: 5px; PADDING-RIGHT: 3px">
+		<TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
+			<TR>
+				<TD><SPAN class="fontstyle_003"><?php echo $FG_HTML_TABLE_TITLE?></SPAN></TD>
+			</TR>
+		</TABLE>
+		</TD>
+	</TR>
+	<TR>
+		<TD>
+		<TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
+			<TR class="bgcolor_008">
+				<TD width="<?php echo $FG_ACTION_SIZE_COLUMN?>" align=center class="tableBodyRight" style="PADDING-BOTTOM: 2px; PADDING-LEFT: 2px; PADDING-RIGHT: 2px; PADDING-TOP: 2px"></TD>					
+				  
+                  <?php
+						if (is_array ( $list ) && count ( $list ) > 0) {
+							
+							for($i = 0; $i < $FG_NB_TABLE_COL; $i ++) {
+								?>
+					<TD width="<?php echo $FG_TABLE_COL [$i] [2]?>" align=middle class="tableBody" style="PADDING-BOTTOM: 2px; PADDING-LEFT: 2px; PADDING-RIGHT: 2px; PADDING-TOP: 2px">
+						<center><strong> 
+						<?php if (strtoupper ( $FG_TABLE_COL [$i] [4] ) == "SORT") { ?>
+						<a href="<?php
+								echo $PHP_SELF . "?entercustomer_num=$entercustomer_num&s=1&t=0&stitle=$stitle&atmenu=$atmenu&current_page=$current_page&order=" . $FG_TABLE_COL [$i] [1] . "&sens=";
+								if ($sens == "ASC") {
+									echo "DESC";
+								} else {
+									echo "ASC";
+								}
+								echo "&entercustomer=$entercustomer&enterprovider=$enterprovider&entertrunk=$entertrunk&posted=$posted&Period=$Period&frommonth=$frommonth&fromstatsmonth=$fromstatsmonth&tomonth=$tomonth&tostatsmonth=$tostatsmonth&fromday=$fromday&fromstatsday_sday=$fromstatsday_sday&fromstatsmonth_sday=$fromstatsmonth_sday&today=$today&tostatsday_sday=$tostatsday_sday&tostatsmonth_sday=$tostatsmonth_sday&dsttype=$dsttype&srctype=$srctype&clidtype=$clidtype&channel=$channel&resulttype=$resulttype&dst=$dst&src=$src&clid=$clid&terminatecauseid=$terminatecauseid&choose_calltype=$choose_calltype";
+									?>">
+<span class="liens"><?php
+								}
+								?>
+<?php echo $FG_TABLE_COL [$i] [0]?> 
+<?php if ($order == $FG_TABLE_COL [$i] [1] && $sens == "ASC") { ?>
+&nbsp;<img src="<?php echo Images_Path; ?>/icon_up_12x12.GIF" width="12"
+height="12" border="0"> 
+<?php
+ } elseif ($order == $FG_TABLE_COL [$i] [1] && $sens == "DESC") {
+?>
+&nbsp;<img src="<?php echo Images_Path; ?>/icon_down_12x12.GIF" width="12" height="12" border="0"> 
+<?php } ?>
+<?php if (strtoupper ( $FG_TABLE_COL [$i] [4] ) == "SORT") { ?>
+</span></a> 
+<?php } ?>
+</strong></center>
+</TD>
+   <?php } ?>		
+   <?php if ($FG_DELETION || $FG_EDITION) { ?>
+   <?php } ?>		
+</TR>
+<?php
+															
+$ligne_number = 0;
+//print_r($list);
+foreach ( $list as $recordset ) {
+	$ligne_number ++;
+	?>
+
+<TR bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR [$ligne_number % 2]?>" onMouseOver="bgColor='#C4FFD7'" onMouseOut="bgColor='<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR [$ligne_number % 2]?>'">
+<TD vAlign=top align="<?php echo $FG_TABLE_COL [$i] [3]?>" class=tableBody><?php echo $ligne_number + $current_page * $FG_LIMITE_DISPLAY . ".&nbsp;"; ?></TD>
+ 
+<?php for($i = 0; $i < $FG_NB_TABLE_COL; $i ++) { ?>
+
+	<?php if ($FG_TABLE_COL [$i] [6] == "lie") {
+										
+					$instance_sub_table = new Table ( $FG_TABLE_COL [$i] [7], $FG_TABLE_COL [$i] [8] );
+					$sub_clause = str_replace ( "%id", $recordset [$i], $FG_TABLE_COL [$i] [9] );
+					$select_list = $instance_sub_table->Get_list ( $DBHandle, $sub_clause, null, null, null, null, null, null, null, 10);
+					
+					$field_list_sun = preg_split('/,/', $FG_TABLE_COL [$i] [8] );
+					$record_display = $FG_TABLE_COL [$i] [10];
+					
+					if (is_array($select_list)) {
+						for($l = 1; $l <= count ( $field_list_sun ); $l ++) {
+							$record_display = str_replace ( "%$l", $select_list [0] [$l - 1], $record_display );
+						}
+					} else {
+						$record_display = $recordset [$i];
+					}
+				} elseif($FG_TABLE_COL[$i][6]=="lie_link") {
+					$instance_sub_table = new Table($FG_TABLE_COL[$i][7], $FG_TABLE_COL[$i][8]);
+					$sub_clause = str_replace ( "%id", $recordset [$i], $FG_TABLE_COL [$i] [9] );
+					$select_list = $instance_sub_table -> Get_list ($DBHandle, $sub_clause, null, null, null, null, null, null, null, 10);
+					if(is_array($select_list)){
+						$field_list_sun = preg_split('/,/',$FG_TABLE_COL[$i][8]);
+						$record_display = $FG_TABLE_COL[$i][10];
+						$link = $FG_TABLE_COL[$i][12]."?form_action=ask-edit&id=".$select_list[0][1];
+						for ($l=1;$l<=count($field_list_sun);$l++){
+							$val = str_replace("%$l", $select_list[0][$l-1], $record_display);
+							$record_display = "<a href='$link'>$val</a>";
+						}
+					}else{
+						$record_display="";
+					}
+				} elseif ($FG_TABLE_COL [$i] [6] == "list") {
+					$select_list = $FG_TABLE_COL [$i] [7];
+					$record_display = $select_list [$recordset [$i]] [0];
+				
+				} else {
+					$record_display = $recordset [$i];
+				}
+				
+				if (is_numeric ( $FG_TABLE_COL [$i] [5] ) && (strlen ( $record_display ) > $FG_TABLE_COL [$i] [5])) {
+					$record_display = substr ( $record_display, 0, $FG_TABLE_COL [$i] [5] - 3 ) . "";
+				
+				}
+				
+				?>
+		<TD vAlign=top align="<?php echo $FG_TABLE_COL [$i] [3]?>" class=tableBody><?php
+			if (isset ( $FG_TABLE_COL [$i] [11] ) && strlen ( $FG_TABLE_COL [$i] [11] ) > 1) {
+				call_user_func ( $FG_TABLE_COL [$i] [11], $record_display );
+			} elseif (strlen($record_display)>0) {
+				echo stripslashes ( $record_display );
+			} else {
+				echo '&nbsp;';
+			}
+		?></TD>
+	 <?php } ?>
+  
+	</TR>
+	<?php } //foreach ($list as $recordset)
+		if ($ligne_number < $FG_LIMITE_DISPLAY)
+			$ligne_number_end = $ligne_number + 2;
+		while ( $ligne_number < $ligne_number_end ) {
+			$ligne_number ++;
+			?>
+		<TR
+		bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR [$ligne_number % 2]?>"> 
+		<?php for($i = 0; $i < $FG_NB_TABLE_COL; $i ++) { ?>
+		 <TD vAlign=top class=tableBody>&nbsp;</TD>
+		 <?php } ?>
+		 <TD align="center" vAlign=top class=tableBodyRight>&nbsp;</TD>
+		</TR>
+		
+		<?php } //END_WHILE
+				
+				} else {
+					echo gettext ( "No data found !!!" );
+				} //end_if 
+		?>
+		</TABLE>
+		</td>
+	</tr>
+	<TR bgcolor="#ffffff">
+		<TD class="bgcolor_005" height="16" style="PADDING-LEFT: 5px; PADDING-RIGHT: 3px">
+			<TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
+				<TR>
+					<TD align="right"><SPAN class="fontstyle_003">
+                    <?php if ($current_page > 0) { ?>
+					<img src="<?php echo Images_Path; ?>/fleche-g.gif"
+					width="5" height="10"> <a href="<?php echo $PHP_SELF?>?s=1&t=0&order=<?php echo $order?>&sens=<?php echo $sens?>&current_page=<?php echo ($current_page - 1)?><?php
+									if (! is_null ( $letter ) && ($letter != "")) {
+										echo "&letter=$letter";
+									}
+									echo "&entercustomer_num=$entercustomer_num&posted=$posted&Period=$Period&frommonth=$frommonth&fromstatsmonth=$fromstatsmonth&tomonth=$tomonth&tostatsmonth=$tostatsmonth&fromday=$fromday&fromstatsday_sday=$fromstatsday_sday&fromstatsmonth_sday=$fromstatsmonth_sday&today=$today&tostatsday_sday=$tostatsday_sday&tostatsmonth_sday=$tostatsmonth_sday&dsttype=$dsttype&srctype=$srctype&clidtype=$clidtype&channel=$channel&resulttype=$resulttype&dst=$dst&src=$src&clid=$clid&terminatecauseid=$terminatecauseid&choose_calltype=$choose_calltype&entercustomer=$entercustomer&enterprovider=$enterprovider&entertrunk=$entertrunk";
+									?>">
+					<?php echo gettext ( "Previous" ); ?> </a> - <?php } ?><?php echo ($current_page + 1); ?> / <?php echo $nb_record_max; ?>
+					<?php if ($current_page < $nb_record_max - 1) { ?>
+					- <a href="<?php echo $PHP_SELF?>?s=1&t=0&order=<?php echo $order?>&sens=<?php echo $sens?>&current_page=<?php echo ($current_page + 1)?><?php
+									if (! is_null ( $letter ) && ($letter != "")) {
+										echo "&letter=$letter";
+									}
+									echo "&entercustomer_num=$entercustomer_num&posted=$posted&Period=$Period&frommonth=$frommonth&fromstatsmonth=$fromstatsmonth&tomonth=$tomonth&tostatsmonth=$tostatsmonth&fromday=$fromday&fromstatsday_sday=$fromstatsday_sday&fromstatsmonth_sday=$fromstatsmonth_sday&today=$today&tostatsday_sday=$tostatsday_sday&tostatsmonth_sday=$tostatsmonth_sday&dsttype=$dsttype&srctype=$srctype&clidtype=$clidtype&channel=$channel&resulttype=$resulttype&dst=$dst&src=$src&clid=$clid&terminatecauseid=$terminatecauseid&choose_calltype=$choose_calltype&entercustomer=$entercustomer&enterprovider=$enterprovider&entertrunk=$entertrunk";
+									?>">
+					<?php echo gettext ( "Next" ); ?></a> <img src="<?php echo Images_Path; ?>/fleche-d.gif" width="5" height="10"> </SPAN> 
+					<?php } ?>
+                  </TD>
+		</TABLE>
+		</TD>
+	</TR>
+</table>
+
+
+<!-- ** ** ** ** ** Part to display the GRAPHIC ** ** ** ** ** -->
+<br>
+
+<?php
+if (is_array ( $list_total_day ) && count ( $list_total_day ) > 0) {
+	
+	$mmax = 0;
+	$totalcall == 0;
+	$totalminutes = 0;
+	$totalsuccess = 0;
+	$totalfail = 0;
+	foreach ( $list_total_day as $data ) {
+		if ($mmax < $data [1])
+			$mmax = $data [1];
+		$totalcall += $data [3];
+		$totalminutes += $data [1];
+		$totalcost += $data [2];
+		$totalbuycost += $data [4];
+		$totalsuccess += $data [5];
+	}
+	$max_fail = 0;	
+?>
+
+<?php 
+$profit = $totalcost - $totalbuycost;
+$rand_num = rand(1,4);
+
+// Show the donate button only 25% of the page display
+if ($profit > 500 && $rand_num==4 && SHOW_DONATION) {
+?>
+<center>
+<table align="center" width="50%" bgcolor="white" cellpadding="5" cellspacing="5" style="border: solid 1px">
+	<tr>
+		<td align="center"> 
+		
+			<center>
+				<b><font color="#A00000"><?php echo gettext("Thanks to A2Billing, you have made a profit of over 500 euro !");?></font></b><BR>
+					<?php echo gettext("Support A2Billing by clicking on the Donate button bellow :");?>  
+				
+				<form action="https://www.paypal.com/cgi-bin/webscr" method="post">
+					<input type="hidden" name="cmd" value="_s-xclick">
+					<input type="hidden" name="lc" value="US">
+					<input type="hidden" name="country" value="USA">
+					<input type="hidden" name="hosted_button_id" value="3769548">
+					<input type="image" src="https://www.paypal.com/en_US/ES/i/btn/btn_donateCC_LG.gif" border="0" name="submit" alt="Make Donation with PayPal">
+					<img alt="" border="0" src="https://www.paypal.com/en_US/i/scr/pixel.gif" width="1" height="1">
+				</form>		
+			</center>		
+		</td>
+	</tr>
+</table>
+</center>
+<br>
+<?php } ?>
+
+<!-- END TITLE GLOBAL MINUTES //-->
+
+<table border="0" cellspacing="0" cellpadding="0" width="95%">
+	<tbody>
+		<tr>
+			<td bgcolor="#000000">
+			<table border="0" cellspacing="1" cellpadding="2" width="100%">
+				<tbody>
+					<tr>
+						<td align="center" class="bgcolor_019"></td>
+						<td class="bgcolor_020" align="center" colspan="10"><font
+							class="fontstyle_003"><?php echo gettext ( "TRAFFIC SUMMARY" ); ?></font></td>
+					</tr>
+					<tr class="bgcolor_019">
+						<td align="center" class="bgcolor_020"><font class="fontstyle_003"><?php echo gettext ( "DATE" ); ?></font></td>
+						<td align="center"><font class="fontstyle_003"><acronym
+							title="<?php echo gettext ( "DURATION" ); ?>"><?php	echo gettext ( "DUR" );	?></acronym></font></td>
+						<td align="center"><font class="fontstyle_003"><?php echo gettext ( "GRAPHIC" ); ?></font></td>
+						<td align="center"><font class="fontstyle_003"><?php echo gettext ( "CALLS" ); ?></font></td>
+						<td align="center"><font class="fontstyle_003"><acronym
+							title="<?php echo gettext ( "AVERAGE LENGTH OF CALL" );	?>"><?php echo gettext ( "ALOC" );	?></acronym></font></td>
+						<td align="center"><font class="fontstyle_003"><acronym
+							title="<?php echo gettext ( "ANSWER SEIZE RATIO" );	?>"><?php echo gettext ( "ASR" ); ?></acronym></font></td>
+						<td align="center"><font class="fontstyle_003"><?php echo gettext ( "SELL" );	?></font></td>
+						<td align="center"><font class="fontstyle_003"><?php echo gettext ( "BUY" );	?></font></td>
+						<td align="center"><font class="fontstyle_003"><?php echo gettext ( "PROFIT" );	?></font></td>
+						<td align="center"><font class="fontstyle_003"><?php echo gettext ( "MARGIN" );	?></font></td>
+						<td align="center"><font class="fontstyle_003"><?php echo gettext ( "MARKUP" );	?></font></td>
+
+						<!-- LOOP -->
+	<?php
+	$i = 0;
+	$j = 0;
+	foreach ( $list_total_day as $data ) {
+		$i = ($i + 1) % 2;
+		$tmc = $data [1] / $data [3];
+		
+		if ((! isset ( $resulttype )) || ($resulttype == "min")) {
+			$tmc = sprintf ( "%02d", intval ( $tmc / 60 ) ) . ":" . sprintf ( "%02d", intval ( $tmc % 60 ) );
+		} else {
+			
+			$tmc = intval ( $tmc );
+		}
+		
+		if ((! isset ( $resulttype )) || ($resulttype == "min")) {
+			$minutes = sprintf ( "%02d", intval ( $data [1] / 60 ) ) . ":" . sprintf ( "%02d", intval ( $data [1] % 60 ) );
+		} else {
+			$minutes = $data [1];
+		}
+		if ($mmax > 0)
+			$widthbar = intval ( ($data [1] / $mmax) * 150 );
+		?>
+		</tr>
+					<tr>
+						<td align="right" class="sidenav" nowrap="nowrap"><font
+							class="fontstyle_003"><?php
+		echo $data [0]?></font></td>
+						<td bgcolor="<?php
+		echo $FG_TABLE_ALTERNATE_ROW_COLOR [$i]?>"
+							align="right" nowrap="nowrap"><font class="fontstyle_006"><?php
+		echo $minutes?> </font></td>
+						<td bgcolor="<?php
+		echo $FG_TABLE_ALTERNATE_ROW_COLOR [$i]?>"
+							align="left" nowrap="nowrap" width="<?php
+		echo $widthbar + 40?>">
+						<table cellspacing="0" cellpadding="0">
+							<tbody>
+								<tr>
+									<td bgcolor="#e22424"><img
+										src="<?php
+		echo Images_Path;
+		?>/spacer.gif"
+										width="<?php echo $widthbar?>" height="6"></td>
+								</tr>
+							</tbody>
+						</table>
+						</td>
+						<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR [$i]?>"
+							align="right" nowrap="nowrap"><font class="fontstyle_006"><?php echo $data [3]?></font></td>
+						<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR [$i]?>"
+							align="right" nowrap="nowrap"><font class="fontstyle_006"><?php echo $tmc?> </font></td>
+						<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR [$i]?>"
+							align="right" nowrap="nowrap"><font class="fontstyle_006"><?php display_2dec_percentage ( $data [5] * 100/ ($data [3]) )?> </font></td>
+						<!-- SELL -->
+						<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR [$i]?>"
+							align="right" nowrap="nowrap"><font class="fontstyle_006"><?php display_2bill ( $data [2] )?>
+						</font></td>
+						<!-- BUY -->
+						<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR [$i]?>"
+							align="right" nowrap="nowrap"><font class="fontstyle_006"><?php display_2bill ( $data [4] )?>
+						</font></td>
+						<!-- PROFIT -->
+						<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR [$i]?>"
+							align="right" nowrap="nowrap"><font class="fontstyle_006"><?php display_2bill ( $data [2] - $data [4] )?>
+						</font></td>
+						<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR [$i]?>"
+							align="right" nowrap="nowrap"><font class="fontstyle_006"><?php
+							if ($data [2] != 0) {
+								display_2dec_percentage ( (($data [2] - $data [4]) / $data [2]) * 100 );
+							} else {
+								echo "NULL";
+							}
+							?>
+						</font></td>
+						<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR [$i]?>"
+							align="right" nowrap="nowrap"><font class="fontstyle_006"><?php
+							if ($data [4] != 0) {
+								display_2dec_percentage ( (($data [2] - $data [4]) / $data [4]) * 100 );
+							} else {
+								echo "NULL";
+							}
+							?>
+						</font></td>
+			     <?php
+					$j ++;
+				}
+				
+				if ((! isset ( $resulttype )) || ($resulttype == "min")) {
+					$total_tmc = sprintf ( "%02d", intval ( ($totalminutes / $totalcall) / 60 ) ) . ":" . sprintf ( "%02d", intval ( ($totalminutes / $totalcall) % 60 ) );
+					$totalminutes = sprintf ( "%02d", intval ( $totalminutes / 60 ) ) . ":" . sprintf ( "%02d", intval ( $totalminutes % 60 ) );
+				} else {
+					$total_tmc = intval ( $totalminutes / $totalcall );
+				}
+				
+				?>                   	
+				</tr>
+					<!-- END DETAIL -->
+
+					<!-- END LOOP -->
+
+					<!-- TOTAL -->
+					<tr bgcolor="bgcolor_019">
+						<td align="right" nowrap="nowrap"><font class="fontstyle_003"><?php
+						echo gettext ( "TOTAL" );
+						?></font></td>
+						<td align="center" nowrap="nowrap" colspan="2"><font
+							class="fontstyle_003"><?php echo $totalminutes?> </font></td>
+						<td align="center" nowrap="nowrap"><font class="fontstyle_003"><?php echo $totalcall?></font></td>
+						<td align="center" nowrap="nowrap"><font class="fontstyle_003"><?php echo $total_tmc?></font></td>
+						<td align="center" nowrap="nowrap"><font class="fontstyle_003"><?php display_2dec_percentage ( $totalsuccess*100 / $totalcall )?> </font></td>
+						<td align="center" nowrap="nowrap"><font class="fontstyle_003"><?php display_2bill ( $totalcost )?></font></td>
+						<td align="center" nowrap="nowrap"><font class="fontstyle_003"><?php display_2bill ( $totalbuycost )?></font></td>
+						<td align="center" nowrap="nowrap"><font class="fontstyle_003"><?php display_2bill ( $totalcost - $totalbuycost )?></font></td>
+						<td align="center" nowrap="nowrap"><font class="fontstyle_003"><?php
+							if ($totalcost != 0) {
+								display_2dec_percentage ( (($totalcost - $totalbuycost) / $totalcost) * 100 );
+							} else {
+								echo "NULL";
+							}
+							?></font></td>
+						<td align="center" nowrap="nowrap"><font class="fontstyle_003"><?php
+							if ($totalbuycost != 0) {
+								display_2dec_percentage ( (($totalcost - $totalbuycost) / $totalbuycost) * 100 );
+							} else {
+								echo "NULL";
+							}
+							?></font></td>
+					</tr>
+					<!-- END TOTAL -->
+
+				</tbody>
+			</table>
+			<!-- END ARRAY GLOBAL //--></td>
+		</tr>
+	</tbody>
+</table>
+
+<br>
+<!-- SECTION EXPORT //--> &nbsp; &nbsp; 
+<a href="export_csv.php?var_export=<?php echo $FG_EXPORT_SESSION_VAR?>&var_export_type=type_csv" target="_blank"><img src="<?php echo Images_Path; ?>/excel.gif" border="0" height="30" /><?php echo gettext ( "Export CSV" ); ?></a> 
+- &nbsp; &nbsp;
+<a href="export_csv.php?var_export=<?php echo $FG_EXPORT_SESSION_VAR?>&var_export_type=type_xml" target="_blank"><img src="<?php echo Images_Path; ?>/icons_xml.gif" border="0" height="32" /><?php echo gettext ( "Export XML" ); ?></a>
+
+<?php } else { ?>
+<center>
+<h3><?php echo gettext ( "No calls in your selection");?>.</h3>
+<?php  } ?>
+</center>
+
+<?php
+
+$smarty->display('footer.tpl');
+
diff -rupN a2billing.orig/admin/Public/templates/default/main.tpl a2billing/admin/Public/templates/default/main.tpl
--- a2billing.orig/admin/Public/templates/default/main.tpl	2012-09-18 06:38:22.000000000 -0300
+++ a2billing/admin/Public/templates/default/main.tpl	2012-09-20 14:09:25.081341712 -0300
@@ -175,7 +175,9 @@
 		<ul>
 			<li><ul>
 					<li><a href="call-log-customers.php?nodisplay=1&posted=1&section=5">{php} echo gettext("CDRs");{/php}</a></li>
+                                        <li><a href="call-log-customers-history.php?nodisplay=1&posted=1&section=5">{php} echo "CDRs History";{/php}</a></li>
 					<li><a href="call-count-reporting.php?nodisplay=1&posted=1&section=5">{php} echo gettext("Call Count");{/php}</a></li>
+					<li><a href="call-count-reporting-history.php?nodisplay=1&posted=1&section=5">{php} echo gettext("Call Count History");{/php}</a></li>
 					<li><a href="A2B_trunk_report.php?section=5">{php} echo gettext("Trunk");{/php}</a></li>
 					<li><a href="call-dnid.php?nodisplay=1&posted=1&section=5">{php} echo gettext("DNID");{/php}</a></li>
 					<li><a href="call-pnl-report.php?section=5">{php} echo gettext("PNL");{/php}</a></li>
diff -rupN a2billing.orig/agent/lib/Misc.php a2billing/agent/lib/Misc.php
--- a2billing.orig/agent/lib/Misc.php	2012-09-18 06:38:22.000000000 -0300
+++ a2billing/agent/lib/Misc.php	2012-09-20 14:09:25.091341739 -0300
@@ -5,10 +5,10 @@
 /**
  * This file is part of A2Billing (http://www.a2billing.net/)
  *
- * A2Billing, Commercial Open Source Telecom Billing platform,
+ * A2Billing, Commercial Open Source Telecom Billing platform,   
  * powered by Star2billing S.L. <http://www.star2billing.com/>
- *
- * @copyright   Copyright (C) 2004-2012 - Star2billing S.L.
+ * 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
  * @author      Belaid Arezqui <areski@gmail.com>
  * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
  * @package     A2Billing
@@ -27,8 +27,8 @@
  *
  * You should have received a copy of the GNU Affero General Public License
  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
- *
- *
+ * 
+ * 
 **/
 
 
@@ -59,9 +59,9 @@ function a2b_decrypt($text, $key) {
  */
 function a2b_mail($to, $subject, $mail_content, $from = 'root@localhost', $fromname = '', $contenttype = 'multipart/alternative')
 {
-
+	
 	$mail = new PHPMailer(true);
-
+	
 	if (SMTP_SERVER) {
 		$mail->Mailer = "smtp";
 	} else {
@@ -85,7 +85,7 @@ function a2b_mail($to, $subject, $mail_c
 	$mail->AltBody = $mail_content; // Plain text body (for mail clients that cannot read 	HTML)
 	// if ContentType = multipart/alternative -> HTML will be send
 	$mail->ContentType = $contenttype;
-
+	
 	if (strpos($to, ',') > 0) {
 		foreach (explode(',', $to) as $toemail){
             $mail->AddAddress($toemail);
@@ -93,7 +93,7 @@ function a2b_mail($to, $subject, $mail_c
 	} else {
 	    $mail->AddAddress($to);
 	}
-
+	
 	try {
 		$mail->Send();
 	} catch (phpmailerException $e) {
@@ -236,26 +236,11 @@ function sanitize_data($input) {
 		}
 	} else {
 
-		// remove whitespaces (not a must though)
+		// remove whitespaces (not a must though)  
 		$input = trim($input);
 
 		$input = str_replace('--', '', $input);
 		$input = str_replace(';', '', $input);
-		$input = str_replace('#', '', $input);
-		$input = str_replace('/*', '', $input);
-
-		#injection sql
-		$input = str_ireplace('HAVING', '', $input);
-		$input = str_ireplace('UNION', '', $input);
-		$input = str_ireplace('SUBSTRING', '', $input);
-		$input = str_ireplace('ASCII', '', $input);
-		$input = str_ireplace('SHA1', '', $input);
-		$input = str_ireplace('MD5', '', $input);
-		$input = str_ireplace('SCRIPT', '', $input);
-		$input = str_ireplace('ROW_COUNT', '', $input);
-		$input = str_ireplace('SELECT', '', $input);
-		$input = str_ireplace('UPDATE', '', $input);
-		#$input = str_ireplace('DELETE', '', $input);
 
 		if (!(stripos($input, ' or 1') === FALSE)) {
 			return false;
@@ -268,7 +253,7 @@ function sanitize_data($input) {
 			$input = stripslashes($input);
 		}
 		$input = cleanInput($input);
-
+		
 		$output = addslashes($input);
 	}
 
@@ -351,7 +336,7 @@ function display_dateformat($mydate) {
  */
 function display_date_timestamp($timestamp){
 	echo date("m/d/Y H:i:s", $timestamp);
-}
+}	
 
 /*
  * function display_vm_callerid
@@ -359,7 +344,7 @@ function display_date_timestamp($timesta
 function display_vm_callerid($callerid_string){
 	$arr_spli = preg_split("/ /", $callerid_string);
 	echo str_replace('"',"", $arr_spli[0]);
-}
+}	
 
 
 
@@ -469,7 +454,7 @@ function linkonmonitorfile($value) {
 		}
 	}
 	if (!$find_record) return false;
-
+	
 	$myfile = base64_encode($myfile);
 	echo "<a target=_blank href=\"call-log-customers.php?download=file&file=" . $myfile . "\">";
 	echo '<img src="' . Images_Path . '/stock-mic.png" height="18" /></a>';
@@ -490,7 +475,7 @@ function linkonmonitorfile_customer($val
 		}
 	}
 	if (!$find_record) return false;
-
+	
 	$myfile = base64_encode($myfile);
 	echo "<a target=_blank href=\"call-history.php?download=file&file=" . $myfile . "\">";
 	echo '<img src="' . Images_Path . '/stock-mic.png" height="18" /></a>';
@@ -641,7 +626,7 @@ function MDP_NUMERIC($chrs = LEN_CARDNUM
     for($i = 0; $i < $chrs; $i++){
         $myrand .= mt_rand(0,9);
     }
-
+    
     return $myrand;
 }
 
@@ -884,11 +869,11 @@ function get_timezones($handle = null, $
 		$handle = DbConnect();
 	}
 	$instance_table = new Table();
-	if (!is_null($clause))
-		$clause = 'WHERE '.$clause;
+	if (!is_null($clause)) 
+		$clause = 'WHERE '.$clause; 
 	$QUERY = "SELECT id, gmttime, gmtzone, gmtoffset FROM cc_timezone $clause ORDER by id";
 	$result = $instance_table->SQLExec($handle, $QUERY, 1, 300);
-
+	
 	if (is_array($result)) {
 		$num_cur = count($result);
 		for ($i = 0; $i < $num_cur; $i++) {
@@ -904,13 +889,13 @@ function get_timezones($handle = null, $
 }
 
 function display_GMT($currDate, $number, $fulldate = 1)
-{
+{	
 	$timezone_list = get_timezones(null, "gmttime = '".SERVER_GMT."'");
 	foreach ($timezone_list as $key => $timezone_list_val) {
 		$server_offset = $timezone_list_val[3];
 		break;
 	}
-
+	
 	$date_time_array = getdate(strtotime($currDate));
 	$hours = $date_time_array['hours'];
 	$minutes = $date_time_array['minutes'];
@@ -919,7 +904,6 @@ function display_GMT($currDate, $number,
 	$day = $date_time_array['mday'];
 	$year = $date_time_array['year'];
 	$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
-
 	$timestamp = $timestamp - ($server_offset - $number);
 	/*
 	if ($fulldate == 1) {
@@ -929,7 +913,7 @@ function display_GMT($currDate, $number,
 	}
 	return $gmdate;
 	*/
-
+	
 	if ($fulldate == 1) {
 		$date = date("Y-m-d H:i:s", $timestamp);
 	} else {
@@ -1030,7 +1014,7 @@ function get_db_languages($handle = null
  */
 
 function archive_data($condition, $entity = "")
-{
+{	
 	$handle = DbConnect();
 	$instance_table = new Table();
 	if (!empty ($entity)) {
@@ -1073,7 +1057,7 @@ function do_field($sql, $fld, $dbfld) {
 	$fldtype = $fld . 'type';
 	global $$fld;
 	global $$fldtype;
-
+	
 	if ($$fld) {
 		if (strpos($sql, 'WHERE') > 0) {
 			$sql = "$sql AND ";
@@ -1114,7 +1098,7 @@ function currencies_update_yahoo ($DBHan
 	$strong_currency = 'EUR';
 	$url = "http://download.finance.yahoo.com/d/quotes.csv?s=";
 	$return = "";
-
+	
 	$QUERY = "SELECT id, currency, basecurrency FROM cc_currencies ORDER BY id";
 	$old_currencies = $instance_table->SQLExec($DBHandle, $QUERY);
 
@@ -1172,7 +1156,7 @@ function currencies_update_yahoo ($DBHan
 				return gettext("At least one of the entries in the CSV file isn't a number.") . ' ' . gettext('Currency update ABORTED.');
 			}
 		}
-
+		
 		// Find base_currency's value in $strong_currency to help avoid Yahoo's
 		// early truncation,  and therefore win back a lot of accuracy
 		$base_value = $currencies[$index_base_currency];
@@ -1250,7 +1234,7 @@ function generate_invoice_reference() {
 	$invoice_conf_table = new Table('cc_invoice_conf', 'value');
 	$conf_clause = "key_val = 'count_$year'";
 	$result = $invoice_conf_table->Get_list($handle, $conf_clause, 0);
-
+	
 	if (is_array($result) && !empty ($result[0][0])) {
 		$count = $result[0][0];
 		if (!is_numeric($count)) {
@@ -1339,13 +1323,13 @@ function mt_get()
     list($usec, $sec) = explode(" ", microtime());
     return ((float)$usec + (float)$sec);
 }
-
+ 
 // mt_start: starts the microtime counter
 function mt_start()
 {
     global $mt_time; $mt_time = mt_get();
 }
-
+ 
 // mt_end: calculates the elapsed time
 function mt_end($len=4)
 {
@@ -1376,8 +1360,8 @@ function open_url($url)
     $string = ob_get_contents();
 
     ob_end_clean();
-
-    return $string;
+   
+    return $string;    
 }
 
 
@@ -1387,22 +1371,22 @@ function open_url($url)
 function retrieve_rates_callplan($callplan_id, $DBHandle)
 {
     $instance_table = new Table();
-
+    
     $QUERY = "SELECT DISTINCT cc_ratecard.destination, cc_ratecard.dialprefix, cc_ratecard.buyrate, cc_ratecard.rateinitial, cc_ratecard.startdate, cc_ratecard.stopdate, cc_ratecard.initblock, " .
     		"cc_ratecard.connectcharge, cc_ratecard.id_trunk , cc_ratecard.idtariffplan , cc_ratecard.id FROM cc_tariffgroup RIGHT JOIN cc_tariffgroup_plan ON cc_tariffgroup_plan.idtariffgroup=cc_tariffgroup.id " .
     		"INNER JOIN cc_tariffplan ON (cc_tariffplan.id=cc_tariffgroup_plan.idtariffplan ) LEFT JOIN cc_ratecard ON cc_ratecard.idtariffplan=cc_tariffplan.id WHERE cc_tariffgroup.id= '$callplan_id' " .
     		"AND cc_ratecard.rateinitial = (SELECT min(c1.rateinitial) FROM cc_tariffgroup RIGHT JOIN cc_tariffgroup_plan ON cc_tariffgroup_plan.idtariffgroup=cc_tariffgroup.id " .
     		"INNER JOIN cc_tariffplan ON (cc_tariffplan.id=cc_tariffgroup_plan.idtariffplan ) LEFT JOIN cc_ratecard AS c1 ON c1.idtariffplan=cc_tariffplan.id WHERE cc_tariffgroup.id= '$callplan_id' " .
     		"AND cc_ratecard.dialprefix=c1.dialprefix) ORDER BY destination ASC";
-
+	
 	$result = $instance_table -> SQLExec ($DBHandle, $QUERY, 1, 3600); // cached for 1hour
-
+	
 	if (!is_array($result)) {
 	    return false;
 	}
-
+	
 	return $result;
-
+	
 }
 
 /*
@@ -1412,16 +1396,16 @@ function check_cp()
 {
 	$randn = rand(1, 10);
 	$ret_val = ($randn == 5)? 1 : 0;
-
+	
 	$pos_star = strpos(COPYRIGHT, 'star2billing');
 	if ($pos_star === false) {
 		return $ret_val;
 	}
 	$pageURL = get_curPageURL();
     $pos = strpos($pageURL, 'phpsysinfo');
-
+    
     if ($pos === false) {
-
+        
         $footer_content = file_get_contents("templates/default/footer.tpl");
 
         $pos_copyright = strpos($footer_content, '$COPYRIGHT');
@@ -1489,7 +1473,7 @@ function addRealMonth($timeStamp)
 
 
 function Display_Login_Button ($DBHandle, $id) {
-
+	
 	$inst_table = new Table("cc_card", "useralias, uipass");
 	$FG_TABLE_CLAUSE = "id = $id";
 	$list_card_info = $inst_table -> Get_list ($DBHandle, $FG_TABLE_CLAUSE);
@@ -1515,3 +1499,22 @@ function Display_Login_Button ($DBHandle
 }
 
 
+function date_add_hour($tmpdate, $hour = 0) {
+	
+	$second = $hour * 60 * 60 ;
+	$date_time_array = getdate(strtotime($tmpdate));
+	
+
+	$hours = $date_time_array['hours'];
+	$minutes = $date_time_array['minutes'];
+	$seconds = $date_time_array['seconds'];
+	$month = $date_time_array['mon'];
+	$day = $date_time_array['mday'];
+	$year = $date_time_array['year'];
+	
+	$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
+
+	$timestamp = $timestamp + $second;
+
+	return $timestamp;
+}
diff -rupN a2billing.orig/AGI/lib/Misc.php a2billing/AGI/lib/Misc.php
--- a2billing.orig/AGI/lib/Misc.php	2012-09-18 06:38:22.000000000 -0300
+++ a2billing/AGI/lib/Misc.php	2012-09-20 14:09:25.091341739 -0300
@@ -5,10 +5,10 @@
 /**
  * This file is part of A2Billing (http://www.a2billing.net/)
  *
- * A2Billing, Commercial Open Source Telecom Billing platform,
+ * A2Billing, Commercial Open Source Telecom Billing platform,   
  * powered by Star2billing S.L. <http://www.star2billing.com/>
- *
- * @copyright   Copyright (C) 2004-2012 - Star2billing S.L.
+ * 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
  * @author      Belaid Arezqui <areski@gmail.com>
  * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
  * @package     A2Billing
@@ -27,8 +27,8 @@
  *
  * You should have received a copy of the GNU Affero General Public License
  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
- *
- *
+ * 
+ * 
 **/
 
 
@@ -59,9 +59,9 @@ function a2b_decrypt($text, $key) {
  */
 function a2b_mail($to, $subject, $mail_content, $from = 'root@localhost', $fromname = '', $contenttype = 'multipart/alternative')
 {
-
+	
 	$mail = new PHPMailer(true);
-
+	
 	if (SMTP_SERVER) {
 		$mail->Mailer = "smtp";
 	} else {
@@ -85,7 +85,7 @@ function a2b_mail($to, $subject, $mail_c
 	$mail->AltBody = $mail_content; // Plain text body (for mail clients that cannot read 	HTML)
 	// if ContentType = multipart/alternative -> HTML will be send
 	$mail->ContentType = $contenttype;
-
+	
 	if (strpos($to, ',') > 0) {
 		foreach (explode(',', $to) as $toemail){
             $mail->AddAddress($toemail);
@@ -93,7 +93,7 @@ function a2b_mail($to, $subject, $mail_c
 	} else {
 	    $mail->AddAddress($to);
 	}
-
+	
 	try {
 		$mail->Send();
 	} catch (phpmailerException $e) {
@@ -236,26 +236,11 @@ function sanitize_data($input) {
 		}
 	} else {
 
-		// remove whitespaces (not a must though)
+		// remove whitespaces (not a must though)  
 		$input = trim($input);
 
 		$input = str_replace('--', '', $input);
 		$input = str_replace(';', '', $input);
-		$input = str_replace('#', '', $input);
-		$input = str_replace('/*', '', $input);
-
-		#injection sql
-		$input = str_ireplace('HAVING', '', $input);
-		$input = str_ireplace('UNION', '', $input);
-		$input = str_ireplace('SUBSTRING', '', $input);
-		$input = str_ireplace('ASCII', '', $input);
-		$input = str_ireplace('SHA1', '', $input);
-		$input = str_ireplace('MD5', '', $input);
-		$input = str_ireplace('SCRIPT', '', $input);
-		$input = str_ireplace('ROW_COUNT', '', $input);
-		$input = str_ireplace('SELECT', '', $input);
-		$input = str_ireplace('UPDATE', '', $input);
-		#$input = str_ireplace('DELETE', '', $input);
 
 		if (!(stripos($input, ' or 1') === FALSE)) {
 			return false;
@@ -268,7 +253,7 @@ function sanitize_data($input) {
 			$input = stripslashes($input);
 		}
 		$input = cleanInput($input);
-
+		
 		$output = addslashes($input);
 	}
 
@@ -351,7 +336,7 @@ function display_dateformat($mydate) {
  */
 function display_date_timestamp($timestamp){
 	echo date("m/d/Y H:i:s", $timestamp);
-}
+}	
 
 /*
  * function display_vm_callerid
@@ -359,7 +344,7 @@ function display_date_timestamp($timesta
 function display_vm_callerid($callerid_string){
 	$arr_spli = preg_split("/ /", $callerid_string);
 	echo str_replace('"',"", $arr_spli[0]);
-}
+}	
 
 
 
@@ -469,7 +454,7 @@ function linkonmonitorfile($value) {
 		}
 	}
 	if (!$find_record) return false;
-
+	
 	$myfile = base64_encode($myfile);
 	echo "<a target=_blank href=\"call-log-customers.php?download=file&file=" . $myfile . "\">";
 	echo '<img src="' . Images_Path . '/stock-mic.png" height="18" /></a>';
@@ -490,7 +475,7 @@ function linkonmonitorfile_customer($val
 		}
 	}
 	if (!$find_record) return false;
-
+	
 	$myfile = base64_encode($myfile);
 	echo "<a target=_blank href=\"call-history.php?download=file&file=" . $myfile . "\">";
 	echo '<img src="' . Images_Path . '/stock-mic.png" height="18" /></a>';
@@ -641,7 +626,7 @@ function MDP_NUMERIC($chrs = LEN_CARDNUM
     for($i = 0; $i < $chrs; $i++){
         $myrand .= mt_rand(0,9);
     }
-
+    
     return $myrand;
 }
 
@@ -884,11 +869,11 @@ function get_timezones($handle = null, $
 		$handle = DbConnect();
 	}
 	$instance_table = new Table();
-	if (!is_null($clause))
-		$clause = 'WHERE '.$clause;
+	if (!is_null($clause)) 
+		$clause = 'WHERE '.$clause; 
 	$QUERY = "SELECT id, gmttime, gmtzone, gmtoffset FROM cc_timezone $clause ORDER by id";
 	$result = $instance_table->SQLExec($handle, $QUERY, 1, 300);
-
+	
 	if (is_array($result)) {
 		$num_cur = count($result);
 		for ($i = 0; $i < $num_cur; $i++) {
@@ -904,13 +889,13 @@ function get_timezones($handle = null, $
 }
 
 function display_GMT($currDate, $number, $fulldate = 1)
-{
+{	
 	$timezone_list = get_timezones(null, "gmttime = '".SERVER_GMT."'");
 	foreach ($timezone_list as $key => $timezone_list_val) {
 		$server_offset = $timezone_list_val[3];
 		break;
 	}
-
+	
 	$date_time_array = getdate(strtotime($currDate));
 	$hours = $date_time_array['hours'];
 	$minutes = $date_time_array['minutes'];
@@ -919,7 +904,6 @@ function display_GMT($currDate, $number,
 	$day = $date_time_array['mday'];
 	$year = $date_time_array['year'];
 	$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
-
 	$timestamp = $timestamp - ($server_offset - $number);
 	/*
 	if ($fulldate == 1) {
@@ -929,7 +913,7 @@ function display_GMT($currDate, $number,
 	}
 	return $gmdate;
 	*/
-
+	
 	if ($fulldate == 1) {
 		$date = date("Y-m-d H:i:s", $timestamp);
 	} else {
@@ -1030,7 +1014,7 @@ function get_db_languages($handle = null
  */
 
 function archive_data($condition, $entity = "")
-{
+{	
 	$handle = DbConnect();
 	$instance_table = new Table();
 	if (!empty ($entity)) {
@@ -1073,7 +1057,7 @@ function do_field($sql, $fld, $dbfld) {
 	$fldtype = $fld . 'type';
 	global $$fld;
 	global $$fldtype;
-
+	
 	if ($$fld) {
 		if (strpos($sql, 'WHERE') > 0) {
 			$sql = "$sql AND ";
@@ -1114,7 +1098,7 @@ function currencies_update_yahoo ($DBHan
 	$strong_currency = 'EUR';
 	$url = "http://download.finance.yahoo.com/d/quotes.csv?s=";
 	$return = "";
-
+	
 	$QUERY = "SELECT id, currency, basecurrency FROM cc_currencies ORDER BY id";
 	$old_currencies = $instance_table->SQLExec($DBHandle, $QUERY);
 
@@ -1172,7 +1156,7 @@ function currencies_update_yahoo ($DBHan
 				return gettext("At least one of the entries in the CSV file isn't a number.") . ' ' . gettext('Currency update ABORTED.');
 			}
 		}
-
+		
 		// Find base_currency's value in $strong_currency to help avoid Yahoo's
 		// early truncation,  and therefore win back a lot of accuracy
 		$base_value = $currencies[$index_base_currency];
@@ -1250,7 +1234,7 @@ function generate_invoice_reference() {
 	$invoice_conf_table = new Table('cc_invoice_conf', 'value');
 	$conf_clause = "key_val = 'count_$year'";
 	$result = $invoice_conf_table->Get_list($handle, $conf_clause, 0);
-
+	
 	if (is_array($result) && !empty ($result[0][0])) {
 		$count = $result[0][0];
 		if (!is_numeric($count)) {
@@ -1339,13 +1323,13 @@ function mt_get()
     list($usec, $sec) = explode(" ", microtime());
     return ((float)$usec + (float)$sec);
 }
-
+ 
 // mt_start: starts the microtime counter
 function mt_start()
 {
     global $mt_time; $mt_time = mt_get();
 }
-
+ 
 // mt_end: calculates the elapsed time
 function mt_end($len=4)
 {
@@ -1376,8 +1360,8 @@ function open_url($url)
     $string = ob_get_contents();
 
     ob_end_clean();
-
-    return $string;
+   
+    return $string;    
 }
 
 
@@ -1387,22 +1371,22 @@ function open_url($url)
 function retrieve_rates_callplan($callplan_id, $DBHandle)
 {
     $instance_table = new Table();
-
+    
     $QUERY = "SELECT DISTINCT cc_ratecard.destination, cc_ratecard.dialprefix, cc_ratecard.buyrate, cc_ratecard.rateinitial, cc_ratecard.startdate, cc_ratecard.stopdate, cc_ratecard.initblock, " .
     		"cc_ratecard.connectcharge, cc_ratecard.id_trunk , cc_ratecard.idtariffplan , cc_ratecard.id FROM cc_tariffgroup RIGHT JOIN cc_tariffgroup_plan ON cc_tariffgroup_plan.idtariffgroup=cc_tariffgroup.id " .
     		"INNER JOIN cc_tariffplan ON (cc_tariffplan.id=cc_tariffgroup_plan.idtariffplan ) LEFT JOIN cc_ratecard ON cc_ratecard.idtariffplan=cc_tariffplan.id WHERE cc_tariffgroup.id= '$callplan_id' " .
     		"AND cc_ratecard.rateinitial = (SELECT min(c1.rateinitial) FROM cc_tariffgroup RIGHT JOIN cc_tariffgroup_plan ON cc_tariffgroup_plan.idtariffgroup=cc_tariffgroup.id " .
     		"INNER JOIN cc_tariffplan ON (cc_tariffplan.id=cc_tariffgroup_plan.idtariffplan ) LEFT JOIN cc_ratecard AS c1 ON c1.idtariffplan=cc_tariffplan.id WHERE cc_tariffgroup.id= '$callplan_id' " .
     		"AND cc_ratecard.dialprefix=c1.dialprefix) ORDER BY destination ASC";
-
+	
 	$result = $instance_table -> SQLExec ($DBHandle, $QUERY, 1, 3600); // cached for 1hour
-
+	
 	if (!is_array($result)) {
 	    return false;
 	}
-
+	
 	return $result;
-
+	
 }
 
 /*
@@ -1412,16 +1396,16 @@ function check_cp()
 {
 	$randn = rand(1, 10);
 	$ret_val = ($randn == 5)? 1 : 0;
-
+	
 	$pos_star = strpos(COPYRIGHT, 'star2billing');
 	if ($pos_star === false) {
 		return $ret_val;
 	}
 	$pageURL = get_curPageURL();
     $pos = strpos($pageURL, 'phpsysinfo');
-
+    
     if ($pos === false) {
-
+        
         $footer_content = file_get_contents("templates/default/footer.tpl");
 
         $pos_copyright = strpos($footer_content, '$COPYRIGHT');
@@ -1489,7 +1473,7 @@ function addRealMonth($timeStamp)
 
 
 function Display_Login_Button ($DBHandle, $id) {
-
+	
 	$inst_table = new Table("cc_card", "useralias, uipass");
 	$FG_TABLE_CLAUSE = "id = $id";
 	$list_card_info = $inst_table -> Get_list ($DBHandle, $FG_TABLE_CLAUSE);
@@ -1515,3 +1499,22 @@ function Display_Login_Button ($DBHandle
 }
 
 
+function date_add_hour($tmpdate, $hour = 0) {
+	
+	$second = $hour * 60 * 60 ;
+	$date_time_array = getdate(strtotime($tmpdate));
+	
+
+	$hours = $date_time_array['hours'];
+	$minutes = $date_time_array['minutes'];
+	$seconds = $date_time_array['seconds'];
+	$month = $date_time_array['mon'];
+	$day = $date_time_array['mday'];
+	$year = $date_time_array['year'];
+	
+	$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
+
+	$timestamp = $timestamp + $second;
+
+	return $timestamp;
+}
Binary files a2billing.orig/common/cust_ui_locale/es_ES/LC_MESSAGES/messages.mo and a2billing/common/cust_ui_locale/es_ES/LC_MESSAGES/messages.mo differ
diff -rupN a2billing.orig/common/cust_ui_locale/es_ES/LC_MESSAGES/messages.po a2billing/common/cust_ui_locale/es_ES/LC_MESSAGES/messages.po
--- a2billing.orig/common/cust_ui_locale/es_ES/LC_MESSAGES/messages.po	2012-09-18 06:38:22.000000000 -0300
+++ a2billing/common/cust_ui_locale/es_ES/LC_MESSAGES/messages.po	2012-09-20 14:09:25.101341747 -0300
@@ -1,5 +1,5 @@
 # A2Billing Customer Panel - PO File.
-# Copyright (C) 2004-2012 A2BILLING
+# Copyright (C) 2004-2009 A2BILLING
 # This file is distributed under the same license as the PACKAGE package.
 # ARESKI <areski@gmail.com>.
 #
@@ -8,8 +8,8 @@ msgstr ""
 "Project-Id-Version: \n"
 "Report-Msgid-Bugs-To: \n"
 "POT-Creation-Date: 2011-02-18 00:40+0100\n"
-"PO-Revision-Date: 2009-04-23 16:29-0400\n"
-"Last-Translator: Ivan Žilić Schmidt <ivan@zilic.net>\n"
+"PO-Revision-Date: 2012-09-19 09:54-0300\n"
+"Last-Translator: Sebastián Moreno <smoreno@inconcertcc.com>\n"
 "Language-Team: ARESKI <areski@gmail.com>\n"
 "MIME-Version: 1.0\n"
 "Content-Type: text/plain; charset=utf-8\n"
@@ -20,17 +20,21 @@ msgstr ""
 msgid "Your notification settings has successfully been updated."
 msgstr "Su transacción fue exitosa."
 
-#: A2B_recurring_payment.php:140 A2B_recurring_payment.php:146
+#: A2B_recurring_payment.php:140
+#: A2B_recurring_payment.php:146
 msgid "Reccurring payment : automated refill"
 msgstr ""
 
-#: A2B_recurring_payment.php:156 iridium_threed.php:315
+#: A2B_recurring_payment.php:156
+#: iridium_threed.php:315
 #: checkout_process.php:357
 msgid "CUSTOMER REFILL"
 msgstr "RELLENO DE CLIENTES"
 
-#: A2B_recurring_payment.php:157 iridium_threed.php:317
-#: lib/Form/Class.FormBO.php:840 lib/Form/Class.FormBO.php:949
+#: A2B_recurring_payment.php:157
+#: iridium_threed.php:317
+#: lib/Form/Class.FormBO.php:840
+#: lib/Form/Class.FormBO.php:949
 #: checkout_process.php:358
 msgid "Invoice for refill"
 msgstr "Factura por relleno"
@@ -39,8 +43,10 @@ msgstr "Factura por relleno"
 msgid "Automated Refill : recurring payment"
 msgstr ""
 
-#: A2B_recurring_payment.php:194 iridium_threed.php:387
-#: lib/Form/Class.FormBO.php:996 checkout_process.php:392
+#: A2B_recurring_payment.php:194
+#: iridium_threed.php:387
+#: lib/Form/Class.FormBO.php:996
+#: checkout_process.php:392
 msgid "AUTOMATICALY GENERATED COMMISSION!"
 msgstr "COMISIÓN GENERADA AUTOMÁTICAMENTE!"
 
@@ -48,22 +54,27 @@ msgstr "COMISIÓN GENERADA AUTOMÁTICAME
 msgid "CAMPAIGN"
 msgstr "CAMPAÑA"
 
-#: A2B_entity_phonenumber.php:116 lib/interface/constants.php:15
+#: A2B_entity_phonenumber.php:116
+#: lib/interface/constants.php:15
 msgid "INFO"
 msgstr "INFORMACIÓN"
 
-#: A2B_entity_phonenumber.php:119 form_data/FG_var_invoice.inc:70
-#: form_data/FG_var_campaign.inc:72 form_data/FG_var_ticket.inc:60
+#: A2B_entity_phonenumber.php:119
+#: form_data/FG_var_invoice.inc:70
+#: form_data/FG_var_campaign.inc:72
+#: form_data/FG_var_ticket.inc:60
 #: form_data/FG_var_phonenumber.inc:65
 #, fuzzy
 msgid "STATUS"
 msgstr "ESTADO"
 
-#: A2B_entity_phonenumber.php:122 lib/Form/Class.ViewHandler.inc.php:196
+#: A2B_entity_phonenumber.php:122
+#: lib/Form/Class.ViewHandler.inc.php:196
 msgid "ACTION"
 msgstr "ACCIÓN"
 
-#: A2B_entity_phonenumber.php:137 lib/interface/constants.php:328
+#: A2B_entity_phonenumber.php:137
+#: lib/interface/constants.php:328
 #: lib/interface/constants.php:346
 msgid "EXPIRED"
 msgstr "EXPIRADO"
@@ -253,7 +264,9 @@ msgstr "El simulador encontró una tarif
 msgid "We found several destinations:"
 msgstr "Hemos encontrado varios destinos:"
 
-#: simulator.php:209 form_data/FG_var_did.inc:67 form_data/FG_var_did.inc:122
+#: simulator.php:209
+#: form_data/FG_var_did.inc:67
+#: form_data/FG_var_did.inc:122
 #: form_data/FG_var_ratecard.inc:56
 msgid "DESTINATION"
 msgstr "DESTINO"
@@ -262,7 +275,8 @@ msgstr "DESTINO"
 msgid "CallTime available"
 msgstr "Tiempo de llamado  disponible"
 
-#: simulator.php:216 call-history.php:380
+#: simulator.php:216
+#: call-history.php:380
 msgid "Minutes"
 msgstr "Minutos"
 
@@ -294,22 +308,26 @@ msgstr "Título"
 msgid "Priority"
 msgstr "Prioridad"
 
-#: A2B_support.php:150 lib/interface/constants.php:267
+#: A2B_support.php:150
+#: lib/interface/constants.php:267
 #: A2B_entity_ratecard.php:97
 msgid "NONE"
 msgstr "NINGUNO"
 
-#: A2B_support.php:151 lib/interface/constants.php:268
+#: A2B_support.php:151
+#: lib/interface/constants.php:268
 #: lib/Class.Notification.php:109
 msgid "LOW"
 msgstr "BAJO"
 
-#: A2B_support.php:152 lib/interface/constants.php:269
+#: A2B_support.php:152
+#: lib/interface/constants.php:269
 #: lib/Class.Notification.php:106
 msgid "MEDIUM"
 msgstr "MEDIO"
 
-#: A2B_support.php:153 lib/interface/constants.php:270
+#: A2B_support.php:153
+#: lib/interface/constants.php:270
 #: lib/Class.Notification.php:104
 msgid "HIGH"
 msgstr "ALTO"
@@ -318,9 +336,14 @@ msgstr "ALTO"
 msgid "Component"
 msgstr "Componente"
 
-#: A2B_support.php:179 A2B_invoice_view.php:215 A2B_receipt_detail.php:138
-#: card-history.php:76 A2B_billing_preview.php:184 A2B_billing_preview.php:277
-#: A2B_receipt_preview_detail.php:216 A2B_receipt_view.php:201
+#: A2B_support.php:179
+#: A2B_invoice_view.php:215
+#: A2B_receipt_detail.php:138
+#: card-history.php:76
+#: A2B_billing_preview.php:184
+#: A2B_billing_preview.php:277
+#: A2B_receipt_preview_detail.php:216
+#: A2B_receipt_view.php:201
 msgid "Description"
 msgstr "Descripcion"
 
@@ -328,15 +351,18 @@ msgstr "Descripcion"
 msgid "CREATE"
 msgstr "CREAR"
 
-#: iridium_threed.php:331 checkout_process.php:365
+#: iridium_threed.php:331
+#: checkout_process.php:365
 msgid "Refill ONLINE"
 msgstr ""
 
-#: form_data/FG_var_did.inc:60 lib/interface/constants.php:89
+#: form_data/FG_var_did.inc:60
+#: lib/interface/constants.php:89
 msgid "Active"
 msgstr "Activo"
 
-#: form_data/FG_var_did.inc:61 lib/interface/constants.php:88
+#: form_data/FG_var_did.inc:61
+#: lib/interface/constants.php:88
 msgid "Inactive"
 msgstr "Inactivo"
 
@@ -349,17 +375,22 @@ msgstr ""
 msgid "Validated"
 msgstr "Fecha de Llamada"
 
-#: form_data/FG_var_did.inc:68 templates/default/main.tpl:62
+#: form_data/FG_var_did.inc:68
+#: templates/default/main.tpl:62
 msgid "DID"
 msgstr "DID"
 
-#: form_data/FG_var_did.inc:69 form_data/FG_var_did.inc:132
-#: form_data/FG_var_callerid.inc:49 form_data/FG_var_callerid.inc:91
-#: lib/interface/constants.php:342 lib/interface/constants.php:367
+#: form_data/FG_var_did.inc:69
+#: form_data/FG_var_did.inc:132
+#: form_data/FG_var_callerid.inc:49
+#: form_data/FG_var_callerid.inc:91
+#: lib/interface/constants.php:342
+#: lib/interface/constants.php:367
 msgid "ACTIVATED"
 msgstr "ACTIVADO"
 
-#: form_data/FG_var_did.inc:70 form_data/FG_var_did.inc:141
+#: form_data/FG_var_did.inc:70
+#: form_data/FG_var_did.inc:141
 #: form_data/FG_var_ticket.inc:58
 msgid "PRIORITY"
 msgstr "PRIORIDAD"
@@ -368,8 +399,10 @@ msgstr "PRIORIDAD"
 msgid "USED MINUTE"
 msgstr "MINUTOS USADOS"
 
-#: form_data/FG_var_did.inc:72 form_data/FG_var_signup.inc:229
-#: form_data/FG_var_card.inc:102 userinfo.php:116
+#: form_data/FG_var_did.inc:72
+#: form_data/FG_var_signup.inc:229
+#: form_data/FG_var_card.inc:102
+#: userinfo.php:116
 msgid "COUNTRY"
 msgstr "PAIS"
 
@@ -386,7 +419,8 @@ msgstr "No hay destinos creados"
 msgid "Enter here the phonenumber you want to call or the SIP/IAX/H323 peer to reach (ie: 347894999 or SIP/jeremy@182.212.1.45). To call SIP/IAX/H323 peer, you need to enable the voip_call bellow (voip_call = Yes) "
 msgstr "Ingrese aquí el número telefónico al quie quiere llamar o el peer SIP/IAX/H323 (Ejemplo: 347894999 o SIP/jeremy@182.212.1.45). Para llamar a un peer SIP/IAX/H323, necesita habilitar la opción voip_call debajo (voip_call = yes) "
 
-#: form_data/FG_var_did.inc:138 form_data/FG_var_callerid.inc:97
+#: form_data/FG_var_did.inc:138
+#: form_data/FG_var_callerid.inc:97
 msgid "Choose if you want to activate this card"
 msgstr "Elija si quiere actigar esta tarjeta"
 
@@ -398,45 +432,66 @@ msgstr "VOIP_CALL"
 msgid "Choose if you want to not use the trunk and let the asterisk call directly the destination (ie, Destination : SIP/jeremy@182.212.1.45)"
 msgstr "Elija si quiere no usar el trunk y dejar a Asterisk llamar al destino directamente (Ejemplo:Destino : SIP/jeremy@182.212.1.45)"
 
-#: form_data/FG_var_did.inc:169 form_data/FG_var_campaign.inc:295
-#: form_data/FG_var_speeddial.inc:118 form_data/FG_var_phonebook.inc:109
-#: form_data/FG_var_ticket.inc:80 form_data/FG_var_phonenumber.inc:144
-#: form_data/FG_var_callerid.inc:116 lib/Form/Class.FormHandler.inc.php:554
+#: form_data/FG_var_did.inc:169
+#: form_data/FG_var_campaign.inc:295
+#: form_data/FG_var_speeddial.inc:118
+#: form_data/FG_var_phonebook.inc:109
+#: form_data/FG_var_ticket.inc:80
+#: form_data/FG_var_phonenumber.inc:144
+#: form_data/FG_var_callerid.inc:116
+#: lib/Form/Class.FormHandler.inc.php:554
 msgid "If you really want remove this"
 msgstr "Si usted realmente quiere elimiar esto"
 
-#: form_data/FG_var_did.inc:169 form_data/FG_var_campaign.inc:295
-#: form_data/FG_var_speeddial.inc:118 form_data/FG_var_phonebook.inc:109
-#: form_data/FG_var_ticket.inc:80 form_data/FG_var_phonenumber.inc:144
+#: form_data/FG_var_did.inc:169
+#: form_data/FG_var_campaign.inc:295
+#: form_data/FG_var_speeddial.inc:118
+#: form_data/FG_var_phonebook.inc:109
+#: form_data/FG_var_ticket.inc:80
+#: form_data/FG_var_phonenumber.inc:144
 #: form_data/FG_var_callerid.inc:116
 msgid "click on the delete button."
 msgstr "Haga click en el botón Eliminar"
 
-#: form_data/FG_var_did.inc:170 form_data/FG_var_campaign.inc:296
-#: form_data/FG_var_speeddial.inc:119 form_data/FG_var_phonebook.inc:110
-#: form_data/FG_var_ticket.inc:81 form_data/FG_var_phonenumber.inc:145
-#: form_data/FG_var_callerid.inc:117 lib/Form/Class.FormHandler.inc.php:557
+#: form_data/FG_var_did.inc:170
+#: form_data/FG_var_campaign.inc:296
+#: form_data/FG_var_speeddial.inc:119
+#: form_data/FG_var_phonebook.inc:110
+#: form_data/FG_var_ticket.inc:81
+#: form_data/FG_var_phonenumber.inc:145
+#: form_data/FG_var_callerid.inc:117
+#: lib/Form/Class.FormHandler.inc.php:557
 msgid "you can add easily a new"
 msgstr "Puede fácilmente agregar un nuevo"
 
-#: form_data/FG_var_did.inc:170 form_data/FG_var_campaign.inc:296
-#: form_data/FG_var_speeddial.inc:119 form_data/FG_var_phonebook.inc:110
-#: form_data/FG_var_ticket.inc:81 form_data/FG_var_phonenumber.inc:145
-#: form_data/FG_var_callerid.inc:117 lib/Form/Class.FormHandler.inc.php:557
+#: form_data/FG_var_did.inc:170
+#: form_data/FG_var_campaign.inc:296
+#: form_data/FG_var_speeddial.inc:119
+#: form_data/FG_var_phonebook.inc:110
+#: form_data/FG_var_ticket.inc:81
+#: form_data/FG_var_phonenumber.inc:145
+#: form_data/FG_var_callerid.inc:117
+#: lib/Form/Class.FormHandler.inc.php:557
 msgid "Fill the following fields and confirm by clicking on the button add."
 msgstr "Llene los siguientes campos y confirme haciendo click en el botón agregar"
 
-#: form_data/FG_var_did.inc:174 form_data/FG_var_campaign.inc:300
-#: form_data/FG_var_speeddial.inc:124 form_data/FG_var_phonebook.inc:114
-#: form_data/FG_var_ticket.inc:85 form_data/FG_var_callerid.inc:123
+#: form_data/FG_var_did.inc:174
+#: form_data/FG_var_campaign.inc:300
+#: form_data/FG_var_speeddial.inc:124
+#: form_data/FG_var_phonebook.inc:114
+#: form_data/FG_var_ticket.inc:85
+#: form_data/FG_var_callerid.inc:123
 #: lib/Form/Class.FormHandler.inc.php:559
 #: lib/Form/Class.FormHandler.inc.php:560
 msgid "Your new"
 msgstr "Su nuevo"
 
-#: form_data/FG_var_did.inc:174 form_data/FG_var_campaign.inc:300
-#: form_data/FG_var_speeddial.inc:124 form_data/FG_var_phonebook.inc:114
-#: form_data/FG_var_ticket.inc:85 form_data/FG_var_callerid.inc:123
+#: form_data/FG_var_did.inc:174
+#: form_data/FG_var_campaign.inc:300
+#: form_data/FG_var_speeddial.inc:124
+#: form_data/FG_var_phonebook.inc:114
+#: form_data/FG_var_ticket.inc:85
+#: form_data/FG_var_callerid.inc:123
 msgid "has been inserted."
 msgstr "Ha sido insertado. "
 
@@ -448,18 +503,22 @@ msgstr "Configure los valores para crear
 msgid "REFERENCE"
 msgstr "REFERENCIA"
 
-#: form_data/FG_var_invoice.inc:68 form_data/FG_var_receipt.inc:67
-#: form_data/FG_var_phonenumber.inc:64 call-history.php:259
+#: form_data/FG_var_invoice.inc:68
+#: form_data/FG_var_receipt.inc:67
+#: form_data/FG_var_phonenumber.inc:64
+#: call-history.php:259
 #: call-history.php:592
 msgid "DATE"
 msgstr "FECHA"
 
-#: form_data/FG_var_invoice.inc:69 form_data/FG_var_receipt.inc:68
+#: form_data/FG_var_invoice.inc:69
+#: form_data/FG_var_receipt.inc:68
 #: form_data/FG_var_ticket.inc:55
 msgid "TITLE"
 msgstr "TÍTULO"
 
-#: form_data/FG_var_invoice.inc:71 form_data/FG_var_receipt.inc:69
+#: form_data/FG_var_invoice.inc:71
+#: form_data/FG_var_receipt.inc:69
 msgid "AMOUNT INCL VAT"
 msgstr "Monto c/IVA"
 
@@ -479,7 +538,8 @@ msgstr "IDIOMA"
 msgid "CALL PLAN"
 msgstr "PLAN DE LLAMADOS"
 
-#: form_data/FG_var_signup.inc:175 form_data/FG_var_card.inc:53
+#: form_data/FG_var_signup.inc:175
+#: form_data/FG_var_card.inc:53
 msgid "LASTNAME"
 msgstr "APELLIDOS"
 
@@ -487,7 +547,8 @@ msgstr "APELLIDOS"
 msgid "Insert your lastname"
 msgstr "Ingrese sus apellidos"
 
-#: form_data/FG_var_signup.inc:184 form_data/FG_var_card.inc:62
+#: form_data/FG_var_signup.inc:184
+#: form_data/FG_var_card.inc:62
 msgid "FIRSTNAME"
 msgstr "NOMBRE"
 
@@ -495,7 +556,8 @@ msgstr "NOMBRE"
 msgid "Insert your firstname"
 msgstr "Ingrese su nombre"
 
-#: form_data/FG_var_signup.inc:192 userinfo.php:107
+#: form_data/FG_var_signup.inc:192
+#: userinfo.php:107
 msgid "EMAIL"
 msgstr "EMAIL"
 
@@ -503,7 +565,8 @@ msgstr "EMAIL"
 msgid "Insert your email"
 msgstr "Ingrese e-mail"
 
-#: form_data/FG_var_signup.inc:199 form_data/FG_var_card.inc:72
+#: form_data/FG_var_signup.inc:199
+#: form_data/FG_var_card.inc:72
 #: userinfo.php:112
 msgid "ADDRESS"
 msgstr "DIRECCIÓN"
@@ -512,7 +575,8 @@ msgstr "DIRECCIÓN"
 msgid "Insert your address"
 msgstr "Ingrese su Dirección"
 
-#: form_data/FG_var_signup.inc:208 form_data/FG_var_card.inc:82
+#: form_data/FG_var_signup.inc:208
+#: form_data/FG_var_card.inc:82
 #: userinfo.php:114
 msgid "CITY"
 msgstr "CIUDAD"
@@ -522,7 +586,8 @@ msgstr "CIUDAD"
 msgid "Insert your city"
 msgstr "Ingrese la Ciudad"
 
-#: form_data/FG_var_signup.inc:217 form_data/FG_var_card.inc:92
+#: form_data/FG_var_signup.inc:217
+#: form_data/FG_var_card.inc:92
 msgid "STATE/PROVINCE"
 msgstr "ESTADO/PROVINCIA"
 
@@ -531,7 +596,8 @@ msgstr "ESTADO/PROVINCIA"
 msgid "Insert your state"
 msgstr "Ingrese el Estado"
 
-#: form_data/FG_var_signup.inc:239 form_data/FG_var_card.inc:113
+#: form_data/FG_var_signup.inc:239
+#: form_data/FG_var_card.inc:113
 msgid "ZIP/POSTAL CODE"
 msgstr "CODIGO POSTAL"
 
@@ -539,11 +605,13 @@ msgstr "CODIGO POSTAL"
 msgid "Insert your zipcode"
 msgstr "Ingrese el código postal"
 
-#: form_data/FG_var_signup.inc:257 form_data/FG_var_card.inc:122
+#: form_data/FG_var_signup.inc:257
+#: form_data/FG_var_card.inc:122
 msgid "TIMEZONE"
 msgstr "ZONA HORARIA"
 
-#: form_data/FG_var_signup.inc:268 form_data/FG_var_phonenumber.inc:61
+#: form_data/FG_var_signup.inc:268
+#: form_data/FG_var_phonenumber.inc:61
 #: call-history.php:324
 msgid "PHONENUMBER"
 msgstr "NÚMERO TELEFÓNICO"
@@ -628,7 +696,8 @@ msgstr "Gracias por registrarse con noso
 msgid "Your card number is "
 msgstr "Su número de tarjeta es"
 
-#: form_data/FG_var_signup.inc:430 activate.php:111
+#: form_data/FG_var_signup.inc:430
+#: activate.php:111
 #: signup_confirmation.php:121
 msgid "Your password is "
 msgstr "Su password es"
@@ -691,15 +760,18 @@ msgstr "Elija si quiere activar la notif
 msgid "Customer can enable the voicemail for this card."
 msgstr "Elija si quiere activar la notificación por e-mail para esta tarjeta"
 
-#: form_data/FG_var_card.inc:169 form_data/FG_var_notify.inc:114
+#: form_data/FG_var_card.inc:169
+#: form_data/FG_var_notify.inc:114
 msgid "you can add easily update your information clicking on the button."
 msgstr ""
 
-#: form_data/FG_var_card.inc:172 form_data/FG_var_notify.inc:117
+#: form_data/FG_var_card.inc:172
+#: form_data/FG_var_notify.inc:117
 msgid "Your record has been updated."
 msgstr "Su registro ha sido actualizado."
 
-#: form_data/FG_var_voucher.inc:45 A2B_entity_voucher.php:116
+#: form_data/FG_var_voucher.inc:45
+#: A2B_entity_voucher.php:116
 msgid "VOUCHER"
 msgstr "VOUCHER"
 
@@ -715,9 +787,12 @@ msgstr "Ningún voucher ha diso usado!"
 msgid "Add CAMPAIGN"
 msgstr "Agregar CAMPAÑA"
 
-#: form_data/FG_var_campaign.inc:68 form_data/FG_var_speeddial.inc:53
-#: form_data/FG_var_speeddial.inc:90 form_data/FG_var_phonebook.inc:65
-#: form_data/FG_var_phonebook.inc:81 form_data/FG_var_phonenumber.inc:62
+#: form_data/FG_var_campaign.inc:68
+#: form_data/FG_var_speeddial.inc:53
+#: form_data/FG_var_speeddial.inc:90
+#: form_data/FG_var_phonebook.inc:65
+#: form_data/FG_var_phonebook.inc:81
+#: form_data/FG_var_phonenumber.inc:62
 #: form_data/FG_var_phonenumber.inc:101
 msgid "NAME"
 msgstr "NOMBRE"
@@ -730,7 +805,8 @@ msgstr "FECHA DE INICIO"
 msgid "EXPIRATIONDATE"
 msgstr "FECHA DE EXPIRACIÓN"
 
-#: form_data/FG_var_campaign.inc:71 A2B_entity_sipiax_info.php:88
+#: form_data/FG_var_campaign.inc:71
+#: A2B_entity_sipiax_info.php:88
 msgid "CARD"
 msgstr "TARJETA"
 
@@ -771,7 +847,8 @@ msgstr "FECHA DE INICIO"
 msgid "Insert the starting date"
 msgstr "Ingrese la fecha de inicio"
 
-#: form_data/FG_var_campaign.inc:148 form_data/FG_var_campaign.inc:157
+#: form_data/FG_var_campaign.inc:148
+#: form_data/FG_var_campaign.inc:157
 #, fuzzy
 msgid "Please respect the format YYYY-MM-DD HH:MM:SS. For instance, '2004-12-31 00:00:00'"
 msgstr "Por favor respete el formato YYYY-MM-DD HH:MM:SS. Por ejemplo,'2004-12-31 00:00:00'"
@@ -804,7 +881,8 @@ msgstr "HORARIO DE COMIENZO DIARIO"
 msgid "Insert the daily starting time"
 msgstr "Ingrese el horario de inicio diario"
 
-#: form_data/FG_var_campaign.inc:175 form_data/FG_var_campaign.inc:184
+#: form_data/FG_var_campaign.inc:175
+#: form_data/FG_var_campaign.inc:184
 #, fuzzy
 msgid "Please respect the format HH:MM:SS. For instance, '00:00:00'"
 msgstr "Por favor respete el formato YYYY-MM-DD HH:MM:SS. Por ejemplo,'2004-12-31 00:00:00'"
@@ -821,7 +899,8 @@ msgstr "Ingrese el horario de parada dia
 msgid "MONDAY"
 msgstr "LUNES"
 
-#: form_data/FG_var_campaign.inc:192 form_data/FG_var_campaign.inc:201
+#: form_data/FG_var_campaign.inc:192
+#: form_data/FG_var_campaign.inc:201
 #: form_data/FG_var_campaign.inc:210
 msgid "Choose if you want to enable the campaign callback for the monday"
 msgstr "Elija si quiere activar la campaña callback el lunes"
@@ -866,12 +945,15 @@ msgstr "DOMINGO"
 msgid "Choose if you want to enable the campaign callback for the sunday"
 msgstr "Elija si quiere activar la campaña callback el domingo"
 
-#: form_data/FG_var_campaign.inc:249 form_data/FG_var_payment.inc:53
-#: form_data/FG_var_phonebook.inc:66 form_data/FG_var_phonebook.inc:90
+#: form_data/FG_var_campaign.inc:249
+#: form_data/FG_var_payment.inc:53
+#: form_data/FG_var_phonebook.inc:66
+#: form_data/FG_var_phonebook.inc:90
 msgid "DESCRIPTION"
 msgstr "DESCRIPCIÓN"
 
-#: form_data/FG_var_campaign.inc:255 form_data/FG_var_phonebook.inc:96
+#: form_data/FG_var_campaign.inc:255
+#: form_data/FG_var_phonebook.inc:96
 msgid "Insert the description"
 msgstr "Ingrese la descripción"
 
@@ -879,9 +961,12 @@ msgstr "Ingrese la descripción"
 msgid "PHONE BOOK"
 msgstr "AGENDA"
 
-#: form_data/FG_var_campaign.inc:294 form_data/FG_var_speeddial.inc:117
-#: form_data/FG_var_phonebook.inc:108 form_data/FG_var_phonenumber.inc:143
-#: form_data/FG_var_callerid.inc:115 lib/Form/Class.FormHandler.inc.php:553
+#: form_data/FG_var_campaign.inc:294
+#: form_data/FG_var_speeddial.inc:117
+#: form_data/FG_var_phonebook.inc:108
+#: form_data/FG_var_phonenumber.inc:143
+#: form_data/FG_var_callerid.inc:115
+#: lib/Form/Class.FormHandler.inc.php:553
 msgid "You can modify, through the following form, the different properties of your"
 msgstr "Usted puede modificar a través del siguiente formulario las diferentes propiedades de su"
 
@@ -893,11 +978,13 @@ msgstr "Agregue un"
 msgid "Setup those values to create the new"
 msgstr "Configure los valores para crear el nuevo"
 
-#: form_data/FG_var_speeddial.inc:51 form_data/FG_var_speeddial.inc:80
+#: form_data/FG_var_speeddial.inc:51
+#: form_data/FG_var_speeddial.inc:80
 msgid "SPEEDDIAL"
 msgstr "DISCADO RAPIDO"
 
-#: form_data/FG_var_speeddial.inc:52 form_data/FG_var_speeddial.inc:100
+#: form_data/FG_var_speeddial.inc:52
+#: form_data/FG_var_speeddial.inc:100
 #: userinfo.php:108
 msgid "PHONE"
 msgstr "TELÉFONO"
@@ -930,7 +1017,8 @@ msgstr "Una vez que haya completado el f
 msgid "payment"
 msgstr "Pago"
 
-#: form_data/FG_var_payment.inc:50 form_data/FG_var_receipt.inc:65
+#: form_data/FG_var_payment.inc:50
+#: form_data/FG_var_receipt.inc:65
 #: form_data/FG_var_ticket.inc:54
 msgid "ID"
 msgstr "ID"
@@ -971,7 +1059,8 @@ msgstr "Cuenta"
 msgid "THERE IS NO RECEIPT CREATED!"
 msgstr "NO HAY RECIBO CREADO!"
 
-#: form_data/FG_var_phonebook.inc:38 form_data/FG_var_phonenumber.inc:91
+#: form_data/FG_var_phonebook.inc:38
+#: form_data/FG_var_phonenumber.inc:91
 #: templates/default/main.tpl:114
 msgid "Phone Book"
 msgstr "Agenda"
@@ -992,7 +1081,8 @@ msgstr "NINGUNA AGENDA CREADA!"
 msgid "Insert the provider name"
 msgstr "Ingrese el nombre del proveedor"
 
-#: form_data/FG_var_phonebook.inc:113 lib/Form/Class.SearchHandler.inc.php:379
+#: form_data/FG_var_phonebook.inc:113
+#: lib/Form/Class.SearchHandler.inc.php:379
 #: lib/Form/Class.SearchHandler.inc.php:394
 #: lib/Form/Class.SearchHandler.inc.php:410
 #: lib/Form/Class.SearchHandler.inc.php:426
@@ -1004,7 +1094,8 @@ msgstr "Ingrese el nombre del proveedor"
 msgid "Add"
 msgstr "Agregue un"
 
-#: form_data/FG_var_phonebook.inc:118 form_data/FG_var_ticket.inc:88
+#: form_data/FG_var_phonebook.inc:118
+#: form_data/FG_var_ticket.inc:88
 #: form_data/FG_var_phonenumber.inc:153
 msgid "Click 'Confirm Data' to continue"
 msgstr "Haga click en \"Confirmar Información\" para seguir"
@@ -1053,7 +1144,8 @@ msgstr "FECHA DE CREACIÓN"
 msgid "COMPONENT"
 msgstr "COMPONENTE"
 
-#: form_data/FG_var_ticket.inc:59 lib/interface/constants.php:276
+#: form_data/FG_var_ticket.inc:59
+#: lib/interface/constants.php:276
 msgid "VIEWED"
 msgstr "VISTO"
 
@@ -1069,7 +1161,8 @@ msgstr "Agregar NÚMERO TELEFÓNICO"
 msgid "PHONEBOOK"
 msgstr "AGENDA"
 
-#: form_data/FG_var_phonenumber.inc:63 form_data/FG_var_phonenumber.inc:110
+#: form_data/FG_var_phonenumber.inc:63
+#: form_data/FG_var_phonenumber.inc:110
 #: lib/interface/constants.php:410
 msgid "AMOUNT"
 msgstr "CANTIDAD"
@@ -1078,7 +1171,8 @@ msgstr "CANTIDAD"
 msgid "No phone numbers have been created"
 msgstr "Ningún número telefónico ha sido creado"
 
-#: form_data/FG_var_phonenumber.inc:82 templates/default/main.tpl:115
+#: form_data/FG_var_phonenumber.inc:82
+#: templates/default/main.tpl:115
 msgid "Phone Number"
 msgstr "Número Telefónico"
 
@@ -1118,11 +1212,13 @@ msgstr "Agregar Número Telefónico"
 msgid "Your new phone number has been inserted."
 msgstr "Su nuevo número telefónico fue insertado."
 
-#: form_data/FG_var_callerid.inc:39 call-history.php:131
+#: form_data/FG_var_callerid.inc:39
+#: call-history.php:131
 msgid "CallerID"
 msgstr "CallerID"
 
-#: form_data/FG_var_callerid.inc:48 form_data/FG_var_callerid.inc:81
+#: form_data/FG_var_callerid.inc:48
+#: form_data/FG_var_callerid.inc:81
 msgid "CALLERID"
 msgstr "IDENTIFICADOR DE LLAMADA"
 
@@ -1179,15 +1275,21 @@ msgid "Errors have occured during the pr
 msgstr "Han ocurrido errores al procesar su formulario."
 
 #: lib/customer.defines.php:123
-msgid "Please make the following corrections:\\n\\n"
-msgstr "Por favor haga las siguientes correcciones:\\n\\n"
+msgid ""
+"Please make the following corrections:\\n"
+"\\n"
+msgstr ""
+"Por favor haga las siguientes correcciones:\\n"
+"\\n"
 
 #: lib/customer.defines.php:124
 msgid "* The 'Review Text' must have at least"
 msgstr "* El texto de su revisión debe tener al menos"
 
-#: lib/customer.defines.php:124 lib/customer.defines.php:136
-#: lib/customer.defines.php:137 lib/customer.defines.php:150
+#: lib/customer.defines.php:124
+#: lib/customer.defines.php:136
+#: lib/customer.defines.php:137
+#: lib/customer.defines.php:150
 msgid "characters"
 msgstr "caracteres"
 
@@ -1195,7 +1297,8 @@ msgstr "caracteres"
 msgid "You must rate the product for your review."
 msgstr "Usted debe valorar el producto para su revisión."
 
-#: lib/customer.defines.php:126 lib/customer.defines.php:128
+#: lib/customer.defines.php:126
+#: lib/customer.defines.php:128
 msgid "Please select a payment method for your order."
 msgstr "Por favor seleccione una forma de pago para su orden."
 
@@ -1207,11 +1310,13 @@ msgstr "Este formulario ya ha sido envia
 msgid "Credit Card"
 msgstr "Tarjeta de Crédito"
 
-#: lib/customer.defines.php:131 lib/customer.defines.php:141
+#: lib/customer.defines.php:131
+#: lib/customer.defines.php:141
 msgid "Credit Card Test Info"
 msgstr "Información de prueba de la Tarjeta de Crédito"
 
-#: lib/customer.defines.php:131 lib/customer.defines.php:141
+#: lib/customer.defines.php:131
+#: lib/customer.defines.php:141
 msgid "Expiry: Any"
 msgstr ""
 
@@ -1231,11 +1336,13 @@ msgstr "Número de Tarjeta de Crédito"
 msgid "Credit Card Expiry Date"
 msgstr "Fecha de vencimiento de la Tarjeta de Crédito"
 
-#: lib/customer.defines.php:136 lib/customer.defines.php:149
+#: lib/customer.defines.php:136
+#: lib/customer.defines.php:149
 msgid "* The owner's name of the credit card must be at least"
 msgstr "*El nombre del propietario de la Tarjeta de Crédito debe ser por lo menos"
 
-#: lib/customer.defines.php:137 lib/customer.defines.php:150
+#: lib/customer.defines.php:137
+#: lib/customer.defines.php:150
 msgid "* The credit card number must be at least"
 msgstr "*EL número de la Tarjeta de Crédito debe ser por lo menos"
 
@@ -1283,27 +1390,34 @@ msgstr "No se pudo abrir el archivo budd
 msgid "Impossible to write to the file"
 msgstr "Imposible escribir en el archivo"
 
-#: lib/customer.smarty.php:103 lib/admin.smarty.php:68 lib/agent.smarty.php:69
+#: lib/customer.smarty.php:103
+#: lib/admin.smarty.php:68
+#: lib/agent.smarty.php:69
 msgid "This option is not available on the Demo!"
 msgstr "Está opción no está disponible en Demo!"
 
-#: lib/epayment/methods/iridium.php:607 checkout_success.php:70
+#: lib/epayment/methods/iridium.php:607
+#: checkout_success.php:70
 msgid "We are sorry your transaction is failed. Please try later or check your provided information."
 msgstr "Lo sentimos, su transaccón falló. Por favor intente luego o revise la información proporcionada."
 
-#: lib/epayment/methods/iridium.php:611 checkout_success.php:74
+#: lib/epayment/methods/iridium.php:611
+#: checkout_success.php:74
 msgid "We are sorry your transaction is denied. Please try later or check your provided information."
 msgstr "Lo sentimos, su transaccón fue denegada. Por favor intente luego o revise la información proporcionada."
 
-#: lib/epayment/methods/iridium.php:620 checkout_success.php:82
+#: lib/epayment/methods/iridium.php:620
+#: checkout_success.php:82
 msgid "Your transaction is in progress."
 msgstr "Su transacción está en proceso."
 
-#: lib/epayment/methods/iridium.php:624 checkout_success.php:86
+#: lib/epayment/methods/iridium.php:624
+#: checkout_success.php:86
 msgid "Your transaction was successful."
 msgstr "Su transacción fue exitosa."
 
-#: lib/support/classes/ticket.php:79 lib/support/classes/ticket.php:233
+#: lib/support/classes/ticket.php:79
+#: lib/support/classes/ticket.php:233
 msgid "(AGENT)"
 msgstr "(AGENTE)"
 
@@ -1311,8 +1425,10 @@ msgstr "(AGENTE)"
 msgid "(ADMINISTRATOR) "
 msgstr "(ADMINISTRADOR)"
 
-#: lib/support/classes/ticket.php:370 lib/interface/constants.php:277
-#: lib/interface/constants.php:325 lib/interface/constants.php:343
+#: lib/support/classes/ticket.php:370
+#: lib/interface/constants.php:277
+#: lib/interface/constants.php:325
+#: lib/interface/constants.php:343
 msgid "NEW"
 msgstr "NUEVO"
 
@@ -1332,7 +1448,8 @@ msgstr "CERRADO"
 msgid "INVALID"
 msgstr "INVALIDO"
 
-#: lib/Class.SOAP-function.php:851 lib/Form/Class.FormBO.php:287
+#: lib/Class.SOAP-function.php:851
+#: lib/Form/Class.FormBO.php:287
 msgid "CREATION CARD REFILL"
 msgstr ""
 
@@ -1415,13 +1532,17 @@ msgstr "Exportar XML"
 #: lib/Form/Class.FormHandler.EditForm.inc.php:780
 #: lib/Form/Class.FormHandler.DelForm.inc.php:161
 #: lib/Form/Class.FormHandler.AddForm.inc.php:158
-#: CC_entity_edit_speeddial.php:298 CC_entity_edit_speeddial.php:508
-#: CC_entity_edit_speeddial.php:800 CC_entity_edit_speeddial.php:1046
-#: card-history.php:418 CC_entity_edit_did_destination.php:407
+#: CC_entity_edit_speeddial.php:298
+#: CC_entity_edit_speeddial.php:508
+#: CC_entity_edit_speeddial.php:800
+#: CC_entity_edit_speeddial.php:1046
+#: card-history.php:418
+#: CC_entity_edit_did_destination.php:407
 #: CC_entity_edit_did_destination.php:626
 #: CC_entity_edit_did_destination.php:944
 #: CC_entity_edit_did_destination.php:1066
-#: CC_entity_edit_did_destination.php:1208 call-history.php:525
+#: CC_entity_edit_did_destination.php:1208
+#: call-history.php:525
 msgid "No data found !!!"
 msgstr "No se encontraron resultados !!!"
 
@@ -1430,21 +1551,24 @@ msgid "LIST "
 msgstr "LISTA"
 
 #: lib/Form/Class.FormHandler.EditForm.inc.php:333
-#: lib/interface/constants.php:64 CC_entity_edit_did_destination.php:739
+#: lib/interface/constants.php:64
+#: CC_entity_edit_did_destination.php:739
 msgid "No"
 msgstr "No"
 
 #: lib/Form/Class.FormHandler.EditForm.inc.php:353
 #: lib/Form/Class.FormHandler.EditForm.inc.php:509
 #: lib/Form/Class.FormHandler.EditForm.inc.php:632
-#: CC_entity_edit_speeddial.php:452 CC_entity_edit_speeddial.php:642
+#: CC_entity_edit_speeddial.php:452
+#: CC_entity_edit_speeddial.php:642
 #: CC_entity_edit_did_destination.php:773
 msgid "Add a new"
 msgstr "Agregar un nuevo"
 
 #: lib/Form/Class.FormHandler.EditForm.inc.php:440
 #: lib/Form/Class.FormHandler.EditForm.inc.php:567
-#: CC_entity_edit_speeddial.php:564 CC_entity_edit_speeddial.php:733
+#: CC_entity_edit_speeddial.php:564
+#: CC_entity_edit_speeddial.php:733
 #: CC_entity_edit_did_destination.php:680
 #: CC_entity_edit_did_destination.php:875
 msgid "LIST"
@@ -1483,12 +1607,15 @@ msgstr "Resumen de los llamados cargados
 msgid "SUMMARY OF CHARGE"
 msgstr "RESUMEN DE CARGOS"
 
-#: lib/Form/Class.FormBO.php:715 A2B_billing_preview.php:230
+#: lib/Form/Class.FormBO.php:715
+#: A2B_billing_preview.php:230
 msgid "Summary of the charge charged since the last billing."
 msgstr ""
 
-#: lib/Form/Class.FormBO.php:721 lib/Form/Class.FormBO.php:751
-#: A2B_billing_preview.php:107 A2B_billing_preview.php:116
+#: lib/Form/Class.FormBO.php:721
+#: lib/Form/Class.FormBO.php:751
+#: A2B_billing_preview.php:107
+#: A2B_billing_preview.php:116
 #: A2B_receipt_preview_detail.php:77
 #, fuzzy
 msgid "CHARGE :"
@@ -1510,8 +1637,10 @@ msgstr ""
 msgid "Invoice for POSTPAID"
 msgstr "Factura para POSTPAGO"
 
-#: lib/Form/Class.FormBO.php:836 lib/Form/Class.FormBO.php:838
-#: lib/Form/Class.FormBO.php:945 lib/Form/Class.FormBO.php:947
+#: lib/Form/Class.FormBO.php:836
+#: lib/Form/Class.FormBO.php:838
+#: lib/Form/Class.FormBO.php:945
+#: lib/Form/Class.FormBO.php:947
 msgid "REFILL"
 msgstr "RELLENO"
 
@@ -1520,51 +1649,63 @@ msgstr "RELLENO"
 msgid "From :"
 msgstr "Desde:"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:195
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:195
 msgid "January"
 msgstr "Enero"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:196
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:196
 msgid "February"
 msgstr "Febrero"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:197
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:197
 msgid "March"
 msgstr "Marzo"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:198
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:198
 msgid "April"
 msgstr "Abril"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:199
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:199
 msgid "May"
 msgstr "Mayo"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:200
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:200
 msgid "June"
 msgstr "Junio"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:201
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:201
 msgid "July"
 msgstr "Julio"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:202
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:202
 msgid "August"
 msgstr "Agosto"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:203
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:203
 msgid "September"
 msgstr "Septiembre"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:204
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:204
 msgid "October"
 msgstr "Octubre"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:205
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:205
 msgid "November"
 msgstr "Noviembre"
 
-#: lib/Form/Class.SearchHandler.inc.php:35 lib/interface/constants.php:206
+#: lib/Form/Class.SearchHandler.inc.php:35
+#: lib/interface/constants.php:206
 msgid "December"
 msgstr "Diciembre"
 
@@ -1573,19 +1714,23 @@ msgstr "Diciembre"
 msgid "To :"
 msgstr "Hasta:"
 
-#: lib/Form/Class.SearchHandler.inc.php:213 call-history.php:329
+#: lib/Form/Class.SearchHandler.inc.php:213
+#: call-history.php:329
 msgid "Exact"
 msgstr "Exacto"
 
-#: lib/Form/Class.SearchHandler.inc.php:214 call-history.php:330
+#: lib/Form/Class.SearchHandler.inc.php:214
+#: call-history.php:330
 msgid "Begins with"
 msgstr "Empieza con"
 
-#: lib/Form/Class.SearchHandler.inc.php:215 call-history.php:331
+#: lib/Form/Class.SearchHandler.inc.php:215
+#: call-history.php:331
 msgid "Contains"
 msgstr "Contiene"
 
-#: lib/Form/Class.SearchHandler.inc.php:216 call-history.php:332
+#: lib/Form/Class.SearchHandler.inc.php:216
+#: call-history.php:332
 msgid "Ends with"
 msgstr "Acaba con"
 
@@ -1597,7 +1742,8 @@ msgstr "Hay"
 msgid "selected, use the option below if you are willing to make a batch updated of the selected cards."
 msgstr "seleccionado, use el botón debajo si desea hacer un update de todas las tarjetas seleccionadas."
 
-#: lib/Form/Class.SearchHandler.inc.php:356 templates/default/main.tpl:70
+#: lib/Form/Class.SearchHandler.inc.php:356
+#: templates/default/main.tpl:70
 msgid "RATECARD"
 msgstr "RATECARD"
 
@@ -1665,7 +1811,8 @@ msgstr "UMBRAL DE CARGO DE DESCONEXION"
 msgid " BATCH UPDATE RATECARD "
 msgstr "ACTUALIZAR LOTE DE RATECARD"
 
-#: lib/Form/Class.FormHandler.DelForm.inc.php:46 checkout_success.php:55
+#: lib/Form/Class.FormHandler.DelForm.inc.php:46
+#: checkout_success.php:55
 msgid "Message"
 msgstr "Mensaje"
 
@@ -1853,13 +2000,13 @@ msgstr "8 caracteres alfanuméricos"
 msgid "(at least 6 Alphanumeric characters)"
 msgstr "(por lo menos 6 caracteres Alfanuméricos)"
 
-#: lib/Form/Class.FormHandler.inc.php:1059
-#, php-format
-msgid "(PERCENT FORMAT WITH/WITHOUT DECIMAL, use '.' for decimal and don't use '%' character. e.g.: 12.4 )"
-msgstr "(FORMATO NUMÉRICO PORCENTUAL CON/SIN DECIMAL, use '.'para decimal y no use '%', por ejemplo: 12.4)"
+msgid "(PERCENT FORMAT WITH/WITHOUT DECIMAL, use . for decimal and don't use % character. e.g.: 12.4 )"
+msgstr "(FORMATO NUMÉRICO PORCENTUAL CON/SIN DECIMAL, use . para decimal y no use %, por ejemplo: 12.4)"
 
+#: lib/Form/Class.FormHandler.inc.php:1059
 #: lib/Form/Class.FormHandler.inc.php:1737
 #: CC_entity_edit_did_destination.php:233
+#, php-format
 msgid "error deletion"
 msgstr "Error en la eliminación"
 
@@ -1895,7 +2042,8 @@ msgstr "Elija una ratecard"
 msgid "Create a new "
 msgstr "Crear un nuevo"
 
-#: lib/Misc.php:523 lib/Class.Notification.php:140
+#: lib/Misc.php:523
+#: lib/Class.Notification.php:140
 msgid "UNKNOWN"
 msgstr "DESCONOCIDO"
 
@@ -1903,11 +2051,13 @@ msgstr "DESCONOCIDO"
 msgid "First"
 msgstr "Primero"
 
-#: lib/Misc.php:723 A2B_entity_did.php:459
+#: lib/Misc.php:723
+#: A2B_entity_did.php:459
 msgid "Prev"
 msgstr "Previo"
 
-#: lib/Misc.php:724 A2B_entity_did.php:429
+#: lib/Misc.php:724
+#: A2B_entity_did.php:429
 msgid "Next"
 msgstr "Siguiente"
 
@@ -1935,7 +2085,10 @@ msgstr "Ese tipo de archivos no está pe
 msgid "Can't find our base_currency in cc_currencies."
 msgstr "No se encuentra base_currency in cc_currencies."
 
-#: lib/Misc.php:1130 lib/Misc.php:1153 lib/Misc.php:1157 lib/Misc.php:1167
+#: lib/Misc.php:1130
+#: lib/Misc.php:1153
+#: lib/Misc.php:1157
+#: lib/Misc.php:1167
 msgid "Currency update ABORTED."
 msgstr "Actualización de monedas ABORTADA."
 
@@ -1969,28 +2122,34 @@ msgstr ""
 msgid "WARNING"
 msgstr "ESPERANDO"
 
-#: lib/interface/constants.php:18 lib/interface/constants.php:72
+#: lib/interface/constants.php:18
+#: lib/interface/constants.php:72
 #, fuzzy
 msgid "ERROR"
 msgstr "PÁGINA de ERROR"
 
-#: lib/interface/constants.php:24 lib/interface/constants.php:38
+#: lib/interface/constants.php:24
+#: lib/interface/constants.php:38
 msgid "ENGLISH"
 msgstr "INGLÉS"
 
-#: lib/interface/constants.php:25 lib/interface/constants.php:39
+#: lib/interface/constants.php:25
+#: lib/interface/constants.php:39
 msgid "SPANISH"
 msgstr "ESPAÑOL"
 
-#: lib/interface/constants.php:26 lib/interface/constants.php:40
+#: lib/interface/constants.php:26
+#: lib/interface/constants.php:40
 msgid "FRENCH"
 msgstr "FRANCES"
 
-#: lib/interface/constants.php:27 lib/interface/constants.php:41
+#: lib/interface/constants.php:27
+#: lib/interface/constants.php:41
 msgid "RUSSIAN"
 msgstr "RUSO"
 
-#: lib/interface/constants.php:28 lib/interface/constants.php:42
+#: lib/interface/constants.php:28
+#: lib/interface/constants.php:42
 msgid "BRAZILIAN"
 msgstr ""
 
@@ -2020,7 +2179,8 @@ msgstr "(AGENTE)"
 msgid "CUSTOMERS AND AGENTS"
 msgstr ""
 
-#: lib/interface/constants.php:63 A2B_entity_did.php:413
+#: lib/interface/constants.php:63
+#: A2B_entity_did.php:413
 msgid "Yes"
 msgstr "Si"
 
@@ -2044,7 +2204,8 @@ msgstr "Fijo por mes"
 msgid "Only dialout rate"
 msgstr "Sólo tarifa de discado "
 
-#: lib/interface/constants.php:113 lib/interface/constants.php:122
+#: lib/interface/constants.php:113
+#: lib/interface/constants.php:122
 msgid "Free"
 msgstr "Gratis"
 
@@ -2060,11 +2221,13 @@ msgstr "Fijo"
 msgid "Dial"
 msgstr "Discar"
 
-#: lib/interface/constants.php:128 lib/interface/constants.php:375
+#: lib/interface/constants.php:128
+#: lib/interface/constants.php:375
 msgid "INDIVIDUAL ACCESS"
 msgstr "ACCESO INDIVIDUAL"
 
-#: lib/interface/constants.php:129 lib/interface/constants.php:374
+#: lib/interface/constants.php:129
+#: lib/interface/constants.php:374
 msgid "SIMULTANEOUS ACCESS"
 msgstr "ACCESO SIMULTÁNEO"
 
@@ -2080,32 +2243,39 @@ msgstr "TARJETA POSTPAGO"
 msgid "NO EXPIRATION"
 msgstr "SIN EXPIRACIÓN"
 
-#: lib/interface/constants.php:147 lib/interface/constants.php:386
+#: lib/interface/constants.php:147
+#: lib/interface/constants.php:386
 msgid "EXPIRE DATE"
 msgstr "FECHA DE VENCIMIENTO"
 
-#: lib/interface/constants.php:148 lib/interface/constants.php:387
+#: lib/interface/constants.php:148
+#: lib/interface/constants.php:387
 msgid "EXPIRE DAYS SINCE FIRST USE"
 msgstr "EXPIRA x DÍAS DESPUÉS DEL PRIMER USO"
 
-#: lib/interface/constants.php:149 lib/interface/constants.php:388
+#: lib/interface/constants.php:149
+#: lib/interface/constants.php:388
 msgid "EXPIRE DAYS SINCE CREATION"
 msgstr "EXPIRA x DÍAS DESPUÉS DE SU CREACIÓN"
 
-#: lib/interface/constants.php:156 lib/interface/constants.php:167
+#: lib/interface/constants.php:156
+#: lib/interface/constants.php:167
 msgid "OPEN"
 msgstr "ABIERTO"
 
-#: lib/interface/constants.php:157 lib/interface/constants.php:168
+#: lib/interface/constants.php:157
+#: lib/interface/constants.php:168
 msgid "CLOSE"
 msgstr "CERRAR"
 
-#: lib/interface/constants.php:175 lib/interface/constants.php:189
+#: lib/interface/constants.php:175
+#: lib/interface/constants.php:189
 #: lib/interface/constants.php:212
 msgid "UNPAID"
 msgstr "Impago"
 
-#: lib/interface/constants.php:176 lib/interface/constants.php:188
+#: lib/interface/constants.php:176
+#: lib/interface/constants.php:188
 #: lib/interface/constants.php:215
 msgid "PAID"
 msgstr "PAGADO"
@@ -2127,7 +2297,8 @@ msgstr ""
 msgid "SENT-PAID"
 msgstr ""
 
-#: lib/interface/constants.php:222 CC_entity_edit_speeddial.php:1080
+#: lib/interface/constants.php:222
+#: CC_entity_edit_speeddial.php:1080
 #: CC_entity_edit_did_destination.php:1240
 msgid "New"
 msgstr "Nuevo"
@@ -2210,7 +2381,8 @@ msgstr "OCUPADO"
 msgid "NOANSWER"
 msgstr "SIN RESPUESTA"
 
-#: lib/interface/constants.php:298 lib/interface/constants.php:341
+#: lib/interface/constants.php:298
+#: lib/interface/constants.php:341
 #: lib/interface/constants.php:366
 msgid "CANCEL"
 msgstr "CANCELAR"
@@ -2235,30 +2407,37 @@ msgstr "TORTURA"
 msgid "INVALIDARGS"
 msgstr ""
 
-#: lib/interface/constants.php:323 lib/interface/constants.php:355
+#: lib/interface/constants.php:323
+#: lib/interface/constants.php:355
 #, fuzzy
 msgid "ACTIVE"
 msgstr "ACTIVADO"
 
-#: lib/interface/constants.php:324 lib/interface/constants.php:341
-#: lib/interface/constants.php:356 lib/interface/constants.php:366
+#: lib/interface/constants.php:324
+#: lib/interface/constants.php:341
+#: lib/interface/constants.php:356
+#: lib/interface/constants.php:366
 #: lib/interface/constants.php:433
 msgid "CANCELLED"
 msgstr "CANCELADO"
 
-#: lib/interface/constants.php:326 lib/interface/constants.php:344
+#: lib/interface/constants.php:326
+#: lib/interface/constants.php:344
 msgid "WAITING-MAILCONFIRMATION"
 msgstr "ESPERANDO CONFIRMACIÓN DE EMAIL"
 
-#: lib/interface/constants.php:327 lib/interface/constants.php:345
+#: lib/interface/constants.php:327
+#: lib/interface/constants.php:345
 msgid "RESERVED"
 msgstr "RESERADO"
 
-#: lib/interface/constants.php:329 lib/interface/constants.php:347
+#: lib/interface/constants.php:329
+#: lib/interface/constants.php:347
 msgid "SUSPENDED FOR UNDERPAYMENT"
 msgstr ""
 
-#: lib/interface/constants.php:330 lib/interface/constants.php:348
+#: lib/interface/constants.php:330
+#: lib/interface/constants.php:348
 msgid "SUSPENDED FOR LITIGATION"
 msgstr "SUSPENDIDO POR LITIGIO"
 
@@ -2267,7 +2446,8 @@ msgstr "SUSPENDIDO POR LITIGIO"
 msgid "WAITING SUBSCRIPTION PAYMENT"
 msgstr "DESCRIPCIÓN"
 
-#: lib/interface/constants.php:344 lib/interface/constants.php:430
+#: lib/interface/constants.php:344
+#: lib/interface/constants.php:430
 msgid "WAITING"
 msgstr "ESPERANDO"
 
@@ -2380,7 +2560,8 @@ msgstr "Error: Tarjeta Inactiva"
 msgid "Error : Card is actually in use!!!"
 msgstr "Error: La tarjeta está actualmente en uso!!!"
 
-#: lib/Class.A2Billing.php:3337 lib/Class.A2Billing.php:3345
+#: lib/Class.A2Billing.php:3337
+#: lib/Class.A2Billing.php:3345
 #: lib/Class.A2Billing.php:3353
 msgid "Error : Card have expired!!!"
 msgstr "Error: La Tarjeta  ha Expirado"
@@ -2588,8 +2769,11 @@ msgstr "Forma de pago"
 msgid "Amount"
 msgstr "Monto"
 
-#: checkout_confirmation.php:166 A2B_invoice_view.php:217
-#: A2B_invoice_view.php:274 A2B_billing_preview.php:279 userinfo.php:250
+#: checkout_confirmation.php:166
+#: A2B_invoice_view.php:217
+#: A2B_invoice_view.php:274
+#: A2B_billing_preview.php:279
+#: userinfo.php:250
 #: userinfo.php:276
 msgid "VAT"
 msgstr "IVA"
@@ -2647,7 +2831,8 @@ msgstr "Estacion Voip"
 msgid "Remove this Speed Dial"
 msgstr "Borrar este Marcador Rápido"
 
-#: CC_entity_edit_speeddial.php:1061 CC_entity_edit_did_destination.php:1223
+#: CC_entity_edit_speeddial.php:1061
+#: CC_entity_edit_did_destination.php:1223
 msgid "Delete"
 msgstr "Borrar"
 
@@ -2655,7 +2840,8 @@ msgstr "Borrar"
 msgid "Deletetion"
 msgstr "Eliminación"
 
-#: CC_entity_edit_speeddial.php:1080 CC_entity_edit_did_destination.php:1240
+#: CC_entity_edit_speeddial.php:1080
+#: CC_entity_edit_did_destination.php:1240
 msgid "Inserted"
 msgstr "Insertado"
 
@@ -2697,7 +2883,9 @@ msgstr "Prioridad"
 msgid "INVOICE"
 msgstr "FACTURA"
 
-#: A2B_invoice_view.php:163 A2B_invoice_view.php:180 A2B_receipt_view.php:155
+#: A2B_invoice_view.php:163
+#: A2B_invoice_view.php:180
+#: A2B_receipt_view.php:155
 msgid "VAT nr."
 msgstr "VAT nr."
 
@@ -2713,12 +2901,19 @@ msgstr "fax"
 msgid "mail"
 msgstr "mail"
 
-#: A2B_invoice_view.php:190 A2B_invoice_view.php:214
-#: A2B_receipt_detail.php:118 A2B_receipt_detail.php:137 card-history.php:75
-#: A2B_billing_preview.php:162 A2B_billing_preview.php:183
-#: A2B_billing_preview.php:255 A2B_billing_preview.php:276
-#: A2B_receipt_preview_detail.php:215 call-history.php:130
-#: A2B_receipt_view.php:179 A2B_receipt_view.php:200
+#: A2B_invoice_view.php:190
+#: A2B_invoice_view.php:214
+#: A2B_receipt_detail.php:118
+#: A2B_receipt_detail.php:137
+#: card-history.php:75
+#: A2B_billing_preview.php:162
+#: A2B_billing_preview.php:183
+#: A2B_billing_preview.php:255
+#: A2B_billing_preview.php:276
+#: A2B_receipt_preview_detail.php:215
+#: call-history.php:130
+#: A2B_receipt_view.php:179
+#: A2B_receipt_view.php:200
 msgid "Date"
 msgstr "FECHA"
 
@@ -2726,28 +2921,35 @@ msgstr "FECHA"
 msgid "Invoice number"
 msgstr "Número de factura"
 
-#: A2B_invoice_view.php:199 A2B_receipt_view.php:185
+#: A2B_invoice_view.php:199
+#: A2B_receipt_view.php:185
 msgid "Client Account Number"
 msgstr "Número de cuenta de cliente"
 
-#: A2B_invoice_view.php:216 A2B_billing_preview.php:278
+#: A2B_invoice_view.php:216
+#: A2B_billing_preview.php:278
 msgid "Cost excl. VAT"
 msgstr "Costo sin IVA"
 
-#: A2B_invoice_view.php:218 A2B_billing_preview.php:280
+#: A2B_invoice_view.php:218
+#: A2B_billing_preview.php:280
 msgid "Cost incl. VAT"
 msgstr "Costo con IVA"
 
-#: A2B_invoice_view.php:267 A2B_billing_preview.php:327
+#: A2B_invoice_view.php:267
+#: A2B_billing_preview.php:327
 msgid "Subtotal excl. VAT:"
 msgstr "Subtotal sin IVA:"
 
-#: A2B_invoice_view.php:280 A2B_billing_preview.php:340
+#: A2B_invoice_view.php:280
+#: A2B_billing_preview.php:340
 msgid "Total incl. VAT:"
 msgstr "Total con IVA:"
 
-#: A2B_receipt_detail.php:90 A2B_receipt_detail.php:97
-#: A2B_receipt_preview_detail.php:169 A2B_receipt_preview_detail.php:176
+#: A2B_receipt_detail.php:90
+#: A2B_receipt_detail.php:97
+#: A2B_receipt_preview_detail.php:169
+#: A2B_receipt_preview_detail.php:176
 msgid "Page"
 msgstr ""
 
@@ -2755,18 +2957,22 @@ msgstr ""
 msgid "RECEIPT DETAIL"
 msgstr "DETALLE DE RECIBO"
 
-#: A2B_receipt_detail.php:139 A2B_billing_preview.php:185
-#: A2B_receipt_preview_detail.php:217 call-history.php:137
+#: A2B_receipt_detail.php:139
+#: A2B_billing_preview.php:185
+#: A2B_receipt_preview_detail.php:217
+#: call-history.php:137
 #: A2B_receipt_view.php:202
 msgid "Cost"
 msgstr "Costo"
 
-#: A2B_receipt_detail.php:175 A2B_receipt_preview_detail.php:254
+#: A2B_receipt_detail.php:175
+#: A2B_receipt_preview_detail.php:254
 #, fuzzy
 msgid "Total Page"
 msgstr "Total:"
 
-#: A2B_receipt_detail.php:182 A2B_receipt_preview_detail.php:260
+#: A2B_receipt_detail.php:182
+#: A2B_receipt_preview_detail.php:260
 #, fuzzy
 msgid "Total Receipt :"
 msgstr "Total:"
@@ -2779,71 +2985,123 @@ msgstr "Historia de la tarjeta"
 msgid "SELECT BY MONTH"
 msgstr "SELECCIONAR POR MES"
 
-#: card-history.php:213 card-history.php:264 call-history.php:264
+#: card-history.php:213
+#: card-history.php:264
+#: call-history.php:264
 msgid "FROM"
 msgstr "DESDE"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "JANUARY"
 msgstr "ENERO"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "FEBRUARY"
 msgstr "FEBREO"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "MARCH"
 msgstr "MARZO"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "APRIL"
 msgstr "ABRIL"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "MAY"
 msgstr "MAYO"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "JUNE"
 msgstr "JUNIO"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "JULY"
 msgstr "JULIO"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "AUGUST"
 msgstr "AGOSTO"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "SEPTEMBER"
 msgstr "SEPTIEMBRE"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "OCTOBER"
 msgstr "OCTUBRE"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "NOVEMBER"
 msgstr "NOVIEMBRE"
 
-#: card-history.php:217 card-history.php:238 card-history.php:277
-#: card-history.php:305 call-history.php:277 call-history.php:305
+#: card-history.php:217
+#: card-history.php:238
+#: card-history.php:277
+#: card-history.php:305
+#: call-history.php:277
+#: call-history.php:305
 msgid "DECEMBER"
 msgstr "DICIEMBRE"
 
-#: card-history.php:233 card-history.php:292 call-history.php:292
+#: card-history.php:233
+#: card-history.php:292
+#: call-history.php:292
 msgid "TO"
 msgstr "Hasta"
 
@@ -2851,7 +3109,8 @@ msgstr "Hasta"
 msgid "SELECT BY DAY"
 msgstr "SELECCIONAR POR DÍA"
 
-#: card-history.php:326 call-history.php:407
+#: card-history.php:326
+#: call-history.php:407
 msgid "Search"
 msgstr "Buscar"
 
@@ -2946,11 +3205,13 @@ msgstr ""
 msgid "PREVIEW NEXT RECEIPT"
 msgstr "VISTA PREVIA DE FACTURA"
 
-#: A2B_billing_preview.php:169 A2B_billing_preview.php:262
+#: A2B_billing_preview.php:169
+#: A2B_billing_preview.php:262
 msgid "Client number"
 msgstr "Número de cliente"
 
-#: A2B_billing_preview.php:221 A2B_receipt_view.php:238
+#: A2B_billing_preview.php:221
+#: A2B_receipt_view.php:238
 msgid "Total:"
 msgstr "Total:"
 
@@ -3014,7 +3275,8 @@ msgstr "SIP"
 msgid "Username"
 msgstr "Nombre"
 
-#: A2B_entity_sipiax_info.php:118 templates/default/index.tpl:61
+#: A2B_entity_sipiax_info.php:118
+#: templates/default/index.tpl:61
 #, fuzzy
 msgid "Password"
 msgstr "Contraseña antigua"
@@ -3049,7 +3311,9 @@ msgstr "Ingrese el número de teléfono
 msgid "Speed Dial code"
 msgstr "CÓdigo de Discado Rápido"
 
-#: A2B_entity_speeddial.php:109 call-history.php:133 A2B_entity_did.php:415
+#: A2B_entity_speeddial.php:109
+#: call-history.php:133
+#: A2B_entity_did.php:415
 msgid "Destination"
 msgstr "Destino"
 
@@ -3230,7 +3494,8 @@ msgstr "NO LLAMAR"
 msgid "DID_VOIP"
 msgstr ""
 
-#: call-history.php:119 templates/default/main.tpl:78
+#: call-history.php:119
+#: templates/default/main.tpl:78
 msgid "CALLBACK"
 msgstr "CALLBACK"
 
@@ -3370,23 +3635,28 @@ msgstr "Lo sentimos, la activación ya h
 msgid "Welcome! Your account has been successfully activated. Thank you!"
 msgstr "Bienvenido! Su cuenta ha sido activada. Muchas gracias!"
 
-#: activate.php:105 signup_confirmation.php:115
+#: activate.php:105
+#: signup_confirmation.php:115
 msgid "Thank you for registering with us !"
 msgstr "Muchas gracias por registrarse con nosotros!"
 
-#: activate.php:106 signup_confirmation.php:116
+#: activate.php:106
+#: signup_confirmation.php:116
 msgid "An email confirming your information has been sent to"
 msgstr "Su información para login ha sido enviada por email a "
 
-#: activate.php:108 signup_confirmation.php:118
+#: activate.php:108
+#: signup_confirmation.php:118
 msgid "Your cardnumber is "
 msgstr "Su número de tarjeta es"
 
-#: activate.php:109 signup_confirmation.php:119
+#: activate.php:109
+#: signup_confirmation.php:119
 msgid "To login to your account :"
 msgstr "Para ingresar a su cuenta:"
 
-#: activate.php:110 signup_confirmation.php:120
+#: activate.php:110
+#: signup_confirmation.php:120
 msgid "Your card alias (login) is "
 msgstr "Su alias (login) es"
 
@@ -3499,7 +3769,8 @@ msgstr ""
 msgid "Forgot your password ?"
 msgstr "Olvidó la contraseña?"
 
-#: templates/default/index.tpl:95 templates/default/index.tpl:98
+#: templates/default/index.tpl:95
+#: templates/default/index.tpl:98
 msgid "Click here"
 msgstr ""
 
@@ -3634,7 +3905,9 @@ msgstr "Si libera este DID no será cobr
 msgid "Add phone number"
 msgstr "Agregar Número Telefónico"
 
-#: A2B_entity_did.php:433 A2B_entity_did.php:462 A2B_entity_did.php:485
+#: A2B_entity_did.php:433
+#: A2B_entity_did.php:462
+#: A2B_entity_did.php:485
 msgid "Ok"
 msgstr "Ok"
 
@@ -3706,6 +3979,30 @@ msgstr "El voucher debe ser un número!"
 msgid "USE VOUCHER"
 msgstr "USA VOUCHER"
 
+msgid "CALL - REAL TIME"
+msgstr "LLAMADAS - ACTUAL"
+
+msgid "CALL - HISTORY"
+msgstr "LLAMADAS - HISTÓRICO"
+
+msgid "This section presents historical information except the last two days."
+msgstr "Esta sección presenta información histórica excepto los dos últimos días."
+
+msgid "This sections presents information only the last two days."
+msgstr "Esta sección presenta unicamente información de los dos últimos días."
+
+msgid "CDR TO DOWNLOAD"
+msgstr "DESCARGA REGISTRO DE LLAMADAS"
+
+msgid "CDR Date"
+msgstr "Fecha - Registro de llamadas"
+
+msgid "File to Download"
+msgstr "Archivo para descarga"
+
+msgid "CDR File"
+msgstr "Archivo"
+
 #~ msgid "Source"
 #~ msgstr "Origen"
 
diff -rupN a2billing.orig/common/lib/Misc.php a2billing/common/lib/Misc.php
--- a2billing.orig/common/lib/Misc.php	2012-09-18 06:38:22.000000000 -0300
+++ a2billing/common/lib/Misc.php	2012-09-20 14:09:25.091341739 -0300
@@ -5,10 +5,10 @@
 /**
  * This file is part of A2Billing (http://www.a2billing.net/)
  *
- * A2Billing, Commercial Open Source Telecom Billing platform,
+ * A2Billing, Commercial Open Source Telecom Billing platform,   
  * powered by Star2billing S.L. <http://www.star2billing.com/>
- *
- * @copyright   Copyright (C) 2004-2012 - Star2billing S.L.
+ * 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
  * @author      Belaid Arezqui <areski@gmail.com>
  * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
  * @package     A2Billing
@@ -27,8 +27,8 @@
  *
  * You should have received a copy of the GNU Affero General Public License
  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
- *
- *
+ * 
+ * 
 **/
 
 
@@ -59,9 +59,9 @@ function a2b_decrypt($text, $key) {
  */
 function a2b_mail($to, $subject, $mail_content, $from = 'root@localhost', $fromname = '', $contenttype = 'multipart/alternative')
 {
-
+	
 	$mail = new PHPMailer(true);
-
+	
 	if (SMTP_SERVER) {
 		$mail->Mailer = "smtp";
 	} else {
@@ -85,7 +85,7 @@ function a2b_mail($to, $subject, $mail_c
 	$mail->AltBody = $mail_content; // Plain text body (for mail clients that cannot read 	HTML)
 	// if ContentType = multipart/alternative -> HTML will be send
 	$mail->ContentType = $contenttype;
-
+	
 	if (strpos($to, ',') > 0) {
 		foreach (explode(',', $to) as $toemail){
             $mail->AddAddress($toemail);
@@ -93,7 +93,7 @@ function a2b_mail($to, $subject, $mail_c
 	} else {
 	    $mail->AddAddress($to);
 	}
-
+	
 	try {
 		$mail->Send();
 	} catch (phpmailerException $e) {
@@ -236,26 +236,11 @@ function sanitize_data($input) {
 		}
 	} else {
 
-		// remove whitespaces (not a must though)
+		// remove whitespaces (not a must though)  
 		$input = trim($input);
 
 		$input = str_replace('--', '', $input);
 		$input = str_replace(';', '', $input);
-		$input = str_replace('#', '', $input);
-		$input = str_replace('/*', '', $input);
-
-		#injection sql
-		$input = str_ireplace('HAVING', '', $input);
-		$input = str_ireplace('UNION', '', $input);
-		$input = str_ireplace('SUBSTRING', '', $input);
-		$input = str_ireplace('ASCII', '', $input);
-		$input = str_ireplace('SHA1', '', $input);
-		$input = str_ireplace('MD5', '', $input);
-		$input = str_ireplace('SCRIPT', '', $input);
-		$input = str_ireplace('ROW_COUNT', '', $input);
-		$input = str_ireplace('SELECT', '', $input);
-		$input = str_ireplace('UPDATE', '', $input);
-		#$input = str_ireplace('DELETE', '', $input);
 
 		if (!(stripos($input, ' or 1') === FALSE)) {
 			return false;
@@ -268,7 +253,7 @@ function sanitize_data($input) {
 			$input = stripslashes($input);
 		}
 		$input = cleanInput($input);
-
+		
 		$output = addslashes($input);
 	}
 
@@ -351,7 +336,7 @@ function display_dateformat($mydate) {
  */
 function display_date_timestamp($timestamp){
 	echo date("m/d/Y H:i:s", $timestamp);
-}
+}	
 
 /*
  * function display_vm_callerid
@@ -359,7 +344,7 @@ function display_date_timestamp($timesta
 function display_vm_callerid($callerid_string){
 	$arr_spli = preg_split("/ /", $callerid_string);
 	echo str_replace('"',"", $arr_spli[0]);
-}
+}	
 
 
 
@@ -469,7 +454,7 @@ function linkonmonitorfile($value) {
 		}
 	}
 	if (!$find_record) return false;
-
+	
 	$myfile = base64_encode($myfile);
 	echo "<a target=_blank href=\"call-log-customers.php?download=file&file=" . $myfile . "\">";
 	echo '<img src="' . Images_Path . '/stock-mic.png" height="18" /></a>';
@@ -490,7 +475,7 @@ function linkonmonitorfile_customer($val
 		}
 	}
 	if (!$find_record) return false;
-
+	
 	$myfile = base64_encode($myfile);
 	echo "<a target=_blank href=\"call-history.php?download=file&file=" . $myfile . "\">";
 	echo '<img src="' . Images_Path . '/stock-mic.png" height="18" /></a>';
@@ -641,7 +626,7 @@ function MDP_NUMERIC($chrs = LEN_CARDNUM
     for($i = 0; $i < $chrs; $i++){
         $myrand .= mt_rand(0,9);
     }
-
+    
     return $myrand;
 }
 
@@ -884,11 +869,11 @@ function get_timezones($handle = null, $
 		$handle = DbConnect();
 	}
 	$instance_table = new Table();
-	if (!is_null($clause))
-		$clause = 'WHERE '.$clause;
+	if (!is_null($clause)) 
+		$clause = 'WHERE '.$clause; 
 	$QUERY = "SELECT id, gmttime, gmtzone, gmtoffset FROM cc_timezone $clause ORDER by id";
 	$result = $instance_table->SQLExec($handle, $QUERY, 1, 300);
-
+	
 	if (is_array($result)) {
 		$num_cur = count($result);
 		for ($i = 0; $i < $num_cur; $i++) {
@@ -904,13 +889,13 @@ function get_timezones($handle = null, $
 }
 
 function display_GMT($currDate, $number, $fulldate = 1)
-{
+{	
 	$timezone_list = get_timezones(null, "gmttime = '".SERVER_GMT."'");
 	foreach ($timezone_list as $key => $timezone_list_val) {
 		$server_offset = $timezone_list_val[3];
 		break;
 	}
-
+	
 	$date_time_array = getdate(strtotime($currDate));
 	$hours = $date_time_array['hours'];
 	$minutes = $date_time_array['minutes'];
@@ -919,7 +904,6 @@ function display_GMT($currDate, $number,
 	$day = $date_time_array['mday'];
 	$year = $date_time_array['year'];
 	$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
-
 	$timestamp = $timestamp - ($server_offset - $number);
 	/*
 	if ($fulldate == 1) {
@@ -929,7 +913,7 @@ function display_GMT($currDate, $number,
 	}
 	return $gmdate;
 	*/
-
+	
 	if ($fulldate == 1) {
 		$date = date("Y-m-d H:i:s", $timestamp);
 	} else {
@@ -1030,7 +1014,7 @@ function get_db_languages($handle = null
  */
 
 function archive_data($condition, $entity = "")
-{
+{	
 	$handle = DbConnect();
 	$instance_table = new Table();
 	if (!empty ($entity)) {
@@ -1073,7 +1057,7 @@ function do_field($sql, $fld, $dbfld) {
 	$fldtype = $fld . 'type';
 	global $$fld;
 	global $$fldtype;
-
+	
 	if ($$fld) {
 		if (strpos($sql, 'WHERE') > 0) {
 			$sql = "$sql AND ";
@@ -1114,7 +1098,7 @@ function currencies_update_yahoo ($DBHan
 	$strong_currency = 'EUR';
 	$url = "http://download.finance.yahoo.com/d/quotes.csv?s=";
 	$return = "";
-
+	
 	$QUERY = "SELECT id, currency, basecurrency FROM cc_currencies ORDER BY id";
 	$old_currencies = $instance_table->SQLExec($DBHandle, $QUERY);
 
@@ -1172,7 +1156,7 @@ function currencies_update_yahoo ($DBHan
 				return gettext("At least one of the entries in the CSV file isn't a number.") . ' ' . gettext('Currency update ABORTED.');
 			}
 		}
-
+		
 		// Find base_currency's value in $strong_currency to help avoid Yahoo's
 		// early truncation,  and therefore win back a lot of accuracy
 		$base_value = $currencies[$index_base_currency];
@@ -1250,7 +1234,7 @@ function generate_invoice_reference() {
 	$invoice_conf_table = new Table('cc_invoice_conf', 'value');
 	$conf_clause = "key_val = 'count_$year'";
 	$result = $invoice_conf_table->Get_list($handle, $conf_clause, 0);
-
+	
 	if (is_array($result) && !empty ($result[0][0])) {
 		$count = $result[0][0];
 		if (!is_numeric($count)) {
@@ -1339,13 +1323,13 @@ function mt_get()
     list($usec, $sec) = explode(" ", microtime());
     return ((float)$usec + (float)$sec);
 }
-
+ 
 // mt_start: starts the microtime counter
 function mt_start()
 {
     global $mt_time; $mt_time = mt_get();
 }
-
+ 
 // mt_end: calculates the elapsed time
 function mt_end($len=4)
 {
@@ -1376,8 +1360,8 @@ function open_url($url)
     $string = ob_get_contents();
 
     ob_end_clean();
-
-    return $string;
+   
+    return $string;    
 }
 
 
@@ -1387,22 +1371,22 @@ function open_url($url)
 function retrieve_rates_callplan($callplan_id, $DBHandle)
 {
     $instance_table = new Table();
-
+    
     $QUERY = "SELECT DISTINCT cc_ratecard.destination, cc_ratecard.dialprefix, cc_ratecard.buyrate, cc_ratecard.rateinitial, cc_ratecard.startdate, cc_ratecard.stopdate, cc_ratecard.initblock, " .
     		"cc_ratecard.connectcharge, cc_ratecard.id_trunk , cc_ratecard.idtariffplan , cc_ratecard.id FROM cc_tariffgroup RIGHT JOIN cc_tariffgroup_plan ON cc_tariffgroup_plan.idtariffgroup=cc_tariffgroup.id " .
     		"INNER JOIN cc_tariffplan ON (cc_tariffplan.id=cc_tariffgroup_plan.idtariffplan ) LEFT JOIN cc_ratecard ON cc_ratecard.idtariffplan=cc_tariffplan.id WHERE cc_tariffgroup.id= '$callplan_id' " .
     		"AND cc_ratecard.rateinitial = (SELECT min(c1.rateinitial) FROM cc_tariffgroup RIGHT JOIN cc_tariffgroup_plan ON cc_tariffgroup_plan.idtariffgroup=cc_tariffgroup.id " .
     		"INNER JOIN cc_tariffplan ON (cc_tariffplan.id=cc_tariffgroup_plan.idtariffplan ) LEFT JOIN cc_ratecard AS c1 ON c1.idtariffplan=cc_tariffplan.id WHERE cc_tariffgroup.id= '$callplan_id' " .
     		"AND cc_ratecard.dialprefix=c1.dialprefix) ORDER BY destination ASC";
-
+	
 	$result = $instance_table -> SQLExec ($DBHandle, $QUERY, 1, 3600); // cached for 1hour
-
+	
 	if (!is_array($result)) {
 	    return false;
 	}
-
+	
 	return $result;
-
+	
 }
 
 /*
@@ -1412,16 +1396,16 @@ function check_cp()
 {
 	$randn = rand(1, 10);
 	$ret_val = ($randn == 5)? 1 : 0;
-
+	
 	$pos_star = strpos(COPYRIGHT, 'star2billing');
 	if ($pos_star === false) {
 		return $ret_val;
 	}
 	$pageURL = get_curPageURL();
     $pos = strpos($pageURL, 'phpsysinfo');
-
+    
     if ($pos === false) {
-
+        
         $footer_content = file_get_contents("templates/default/footer.tpl");
 
         $pos_copyright = strpos($footer_content, '$COPYRIGHT');
@@ -1489,7 +1473,7 @@ function addRealMonth($timeStamp)
 
 
 function Display_Login_Button ($DBHandle, $id) {
-
+	
 	$inst_table = new Table("cc_card", "useralias, uipass");
 	$FG_TABLE_CLAUSE = "id = $id";
 	$list_card_info = $inst_table -> Get_list ($DBHandle, $FG_TABLE_CLAUSE);
@@ -1515,3 +1499,22 @@ function Display_Login_Button ($DBHandle
 }
 
 
+function date_add_hour($tmpdate, $hour = 0) {
+	
+	$second = $hour * 60 * 60 ;
+	$date_time_array = getdate(strtotime($tmpdate));
+	
+
+	$hours = $date_time_array['hours'];
+	$minutes = $date_time_array['minutes'];
+	$seconds = $date_time_array['seconds'];
+	$month = $date_time_array['mon'];
+	$day = $date_time_array['mday'];
+	$year = $date_time_array['year'];
+	
+	$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
+
+	$timestamp = $timestamp + $second;
+
+	return $timestamp;
+}
diff -rupN a2billing.orig/Cronjobs/a2billing_archive_data_cront.php a2billing/Cronjobs/a2billing_archive_data_cront.php
--- a2billing.orig/Cronjobs/a2billing_archive_data_cront.php	2012-09-18 06:38:22.000000000 -0300
+++ a2billing/Cronjobs/a2billing_archive_data_cront.php	2012-09-20 14:09:40.701364634 -0300
@@ -6,10 +6,10 @@
 /**
  * This file is part of A2Billing (http://www.a2billing.net/)
  *
- * A2Billing, Commercial Open Source Telecom Billing platform,
+ * A2Billing, Commercial Open Source Telecom Billing platform,   
  * powered by Star2billing S.L. <http://www.star2billing.com/>
- *
- * @copyright   Copyright (C) 2004-2012 - Star2billing S.L.
+ * 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
  * @author      Belaid Arezqui <areski@gmail.com>
  * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
  * @package     A2Billing
@@ -28,8 +28,8 @@
  *
  * You should have received a copy of the GNU Affero General Public License
  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
- *
- *
+ * 
+ * 
 **/
 
 /***************************************************************************
@@ -41,7 +41,7 @@
  *
 	crontab -e
 	0 12 * * * php /usr/local/a2billing/Cronjobs/a2billing_archive_data_cront.php
-
+	
 	field	 allowed values
 	-----	 --------------
 	minute	 		0-59
@@ -50,28 +50,26 @@
 	month	 		1-12 (or names, see below)
 	day of week	 	0-7 (0 or 7 is Sun, or use names)
 
-
+	
 ****************************************************************************/
 
 set_time_limit(0);
 error_reporting(E_ALL ^ (E_NOTICE | E_WARNING));
 
 include (dirname(__FILE__) . "/lib/admin.defines.php");
+require_once ("lib/iam_csvdump.php");
 include (dirname(__FILE__) . "/lib/ProcessHandler.php");
 
 if (!defined('PID')) {
-	define("PID", "/var/run/a2billing/a2billing_archive_data_cront_pid.php");
+	define("PID", "/var/www/html/billing/a2billing_archive_data_cront_pid.php");
 }
 
 // CHECK IF THE CRONT PROCESS IS ALREADY RUNNING
-
-$pH= new ProcessHandler();
-if ($pH->isActive()) {
-        die(); // Already running!
-        } else {
-                $pH->activate();
-                }
-
+if (ProcessHandler :: isActive()) {
+	die(); // Already running!
+} else {
+	ProcessHandler :: activate();
+}
 
 $A2B = new A2Billing();
 $A2B->load_conf($agi, NULL, 0, $idconfig);
@@ -87,25 +85,180 @@ if (!$A2B->DbConnect()) {
 $A2B = new A2Billing();
 $A2B->load_conf($agi, NULL, 0, $idconfig);
 
-$instance_table = new Table();
+$DBHandle = DbConnect();
 
-$prior_x_month = $A2B->config["backup"]['archive_call_prior_x_month'];
-
-if ($A2B->config["database"]['dbtype'] == "postgres") {
-    $condition = "CURRENT_TIMESTAMP - interval '$prior_x_month months' > starttime";
+// Verifico que exista la tabla cc_call_archive, si no existe la creo.
+$Query = "CREATE TABLE IF NOT EXISTS cc_call_archive (id bigint(20) NOT NULL auto_increment ,sessionid varchar(40) collate utf8_bin NOT NULL ,uniqueid varchar(30) collate utf8_bin NOT NULL, ";
+$Query .= "card_id bigint(20) NOT NULL , nasipaddress varchar(30) collate utf8_bin NOT NULL , starttime timestamp NOT NULL default CURRENT_TIMESTAMP , ";
+$Query .= "stoptime timestamp NOT NULL default '0000-00-00 00:00:00' , sessiontime int(11) default NULL, calledstation varchar(50) collate utf8_bin NOT NULL , ";
+$Query .= "sessionbill float default NULL , id_tariffgroup int(11) default NULL , id_tariffplan int(11) default NULL , id_ratecard int(11) default NULL , ";
+$Query .= "id_trunk int(11) default NULL , sipiax int(11) default '0' ,  src varchar(40) collate utf8_bin NOT NULL ,  id_did int(11) default NULL , ";
+$Query .= "buycost decimal(15,5) default '0.00000' ,  id_card_package_offer int(11) default '0' ,  real_sessiontime int(11) default NULL , ";
+$Query .= "dnid varchar(40) collate utf8_bin NOT NULL , terminatecauseid int(1) default '1' , destination int(11) default '0' ," ;
+$Query .= "PRIMARY KEY  (id),  KEY starttime (starttime),  KEY calledstation (calledstation),  KEY terminatecauseid ";
+$Query .= "(terminatecauseid)) ENGINE=MyISAM AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_bin";
+
+$res = $DBHandle -> Execute($Query);
+
+// PRIMERO REALIZO EL RENAME DE LA cc_call PARA PASAR TODO A UNA TABLA TEMPORAL 
+write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [Comienzo el switch (REANME) de la tabla de tiempo real]");
+$actual_date = date("YmdHis");
+$temp_table = "cc_call_tmp_".$actual_date;
+
+$Query = "DROP TABLE IF EXISTS cc_call_vacia";
+$res = $DBHandle -> Execute($Query);
+
+$Query = "CREATE TABLE cc_call_vacia (id bigint(20) NOT NULL auto_increment ,sessionid varchar(40) collate utf8_bin NOT NULL ,uniqueid varchar(30) collate utf8_bin NOT NULL, ";
+$Query .= "card_id bigint(20) NOT NULL , nasipaddress varchar(30) collate utf8_bin NOT NULL , starttime timestamp NOT NULL default CURRENT_TIMESTAMP , ";
+$Query .= "stoptime timestamp NOT NULL default '0000-00-00 00:00:00' , sessiontime int(11) default NULL, calledstation varchar(50) collate utf8_bin NOT NULL , ";
+$Query .= "sessionbill float default NULL , id_tariffgroup int(11) default NULL , id_tariffplan int(11) default NULL , id_ratecard int(11) default NULL , ";
+$Query .= "id_trunk int(11) default NULL , sipiax int(11) default '0' ,  src varchar(40) collate utf8_bin NOT NULL ,  id_did int(11) default NULL , ";
+$Query .= "buycost decimal(15,5) default '0.00000' ,  id_card_package_offer int(11) default '0' ,  real_sessiontime int(11) default NULL , ";
+$Query .= "dnid varchar(40) collate utf8_bin NOT NULL , terminatecauseid int(1) default '1' , destination int(11) default '0' ," ;
+$Query .= "PRIMARY KEY  (id),  KEY starttime (starttime),  KEY calledstation (calledstation),  KEY terminatecauseid ";
+$Query .= "(terminatecauseid)) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8 COLLATE=utf8_bin";
+
+$res = $DBHandle -> Execute($Query);
+if  ($res) {
+	$Query = "RENAME TABLE cc_call TO $temp_table , cc_call_vacia TO cc_call;";
+	$res = $DBHandle -> Execute($Query);
+	if ($res) {
+		write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [Comienzo copia de datos desde Temporal a cc_call_archive.]");
+		//-------------------------COPIA DATOS A LA HISTORICA -------------------------------------------
+		$Query = "INSERT INTO cc_call_archive (sessionid, uniqueid, card_id, nasipaddress, starttime, stoptime, sessiontime, calledstation, sessionbill, ";
+		$Query .= "id_tariffgroup, id_tariffplan, id_ratecard, id_trunk, sipiax, src, id_did, buycost, id_card_package_offer, real_sessiontime, dnid, ";
+		$Query .= "terminatecauseid, destination) ";
+		$Query .= "(SELECT sessionid, uniqueid, card_id, nasipaddress, starttime, stoptime, sessiontime, calledstation, sessionbill, ";
+		$Query .= "id_tariffgroup, id_tariffplan, id_ratecard, id_trunk, sipiax, src, id_did, buycost, id_card_package_offer, real_sessiontime, dnid, ";
+		$Query .= "terminatecauseid, destination ";
+		$Query .= "FROM $temp_table)";
+		
+		$res = $DBHandle -> Execute($Query);
+		
+		if ($res) {
+			//-------------------------GENERO ARCHIVO CON INFO DEL DIA -------------------------------------------
+			$dumpfile = new iam_csvdump;
+			
+			//Obtengo offset del server respecto a UTC
+			$timezone_list = get_timezones(null, "gmttime = '".SERVER_GMT."'");
+			foreach ($timezone_list as $key => $timezone_list_val) {
+				$server_offset = $timezone_list_val[3];
+				break;
+			}
+			
+			//Verifico si existe la carpeta destino, sino la creo
+			$dirname = "/var/www/html/billing/customer_cdr/";
+			if (!file_exists($filename)) {
+				mkdir("$dirname");
+				chmod("$dirname", 0777);
+			}
+			
+			// Obtengo accounts
+			$Query = "SELECT cc.id,ct.gmtoffset, cc.currency FROM cc_card cc LEFT JOIN cc_timezone AS ct ON ct.id = cc.id_timezone";
+			$res = $DBHandle -> Execute($Query);
+			if ($res) {
+				$num = $res -> RecordCount();
+				for($i=0;$i<$num;$i++) {				
+					$cards [] =$res -> fetchRow();
+				}
+				foreach ($cards as $datarow){
+					
+					$card_id = $datarow ['0'];
+					$gmtoffset_card = $datarow ['1'];
+					$currency_card = $datarow ['2'];
+					write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [Comienzo generacion de archivo CDR para ACCOUNT: $card_id]");
+					
+					//Verifico si existe la carpeta destino para el customer, sino la creo
+					$dirname_customer = "$dirname".$card_id."/";
+					if (!file_exists($dirname_customer)) {
+						mkdir("$dirname_customer");
+						chmod("$dirname_customer", 0777);
+					}
+					$date_offset = (-($server_offset - $gmtoffset_card)) / 60 / 60 ;						
+					
+					//Dia actual 
+					$actual_day = date("Y-m-d");
+					
+					//Resto dos dias para obtener la fecha inicial a generar
+					$menos2day = - 48;
+					$timestamp =$dumpfile->date_add_hour ($actual_day,$menos2day);
+					$initial_day_tmp = date("Y-m-d", $timestamp);
+					
+					//Sumo el offset para obtener fecha y hora inicial.
+					$timestamp =$dumpfile->date_add_hour ($initial_day_tmp,-$date_offset);
+					$initial_day = date("Y-m-d H:i:s", $timestamp);
+
+					$initial_day_file = date("Ymd", $timestamp);
+					
+					$timestamp = $dumpfile->date_add_hour($initial_day, 24);
+					$end_day = date("Y-m-d H:i:s", $timestamp);
+					
+
+					$Query = "SELECT t1.starttime as DATE , t1.src as CALLERID , t1.calledstation as PHONENUMBER, t3.destination as Destination,  t4.buyrate, t4.rateinitial, ";
+					$Query .= "t1.sessiontime AS Duration, t2.trunkcode as trunkcode, ";
+					$Query .= "CASE t1.terminatecauseid WHEN 1 THEN 'ANSWER' WHEN 2 THEN 'BUSY' WHEN '3' THEN 'NOANSWER' WHEN 4 THEN 'CANCEL' WHEN 5 THEN 'CONGESTION'  ";
+					$Query .= "WHEN 6 THEN 'CHANUNAVAIL' WHEN 7 THEN 'DONTCALL' WHEN 8 THEN 'TORTURE' WHEN 9 THEN 'INVALIDARGS' END,  ";
+					$Query .= "t1.buycost, t1.sessionbill, case when t1.sessionbill!=0 then ((t1.sessionbill-t1.buycost)/t1.sessionbill)*100 else 0 end as margin, ";
+					$Query .= "case when t1.buycost!=0 then ((t1.sessionbill-t1.buycost)/t1.buycost)*100 else 0 end as markup ";
+					$Query .= "FROM cc_call_archive t1  ";
+					$Query .= "LEFT OUTER JOIN cc_trunk t2 ON t1.id_trunk = t2.id_trunk  ";
+					$Query .= "LEFT OUTER JOIN cc_ratecard t4 ON t1.id_ratecard = t4.id ";
+					$Query .= "LEFT OUTER JOIN cc_prefix t3 on t1.destination = t3.prefix ";
+					$Query .= "WHERE t1.starttime >= ('$initial_day') and t1.starttime <= ('$end_day') and t1.card_id='$card_id' ORDER BY t1.starttime ASC";		
+
+					$file_name =  $dirname_customer.$card_id."_".$initial_day_file;
+					write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [file_name -> $file_name]");
+					
+					write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [initial_day -> $initial_day]");
+					write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [end_day -> $end_day]");
+					
+					$header = '"Date","CallerID","PhoneNumber","Destination","BuyRate","RateInitial","Duration","TrunkCode","TerminateCause","BuyCost","SessionBill","Margin","Markup"';
+					$dumpfile->dump_job($Query, $file_name, "csv", DBNAME, USER, PASS, HOST, DB_TYPE, $header, $gmtoffset_card,$currency_card);
+					
+					//Dia actual 
+					$actual_day = date("Y-m-d");
+					
+					//------------------- BORRO ARCHIVO CDR DE 35 DIAS HACIA ATRAS --------------------------------------		
+					$menos36day = - 864; // 864 horas = 36 dias					
+					//Resto 36 dias para obtener el nombre del archivo a borrar
+					$timestamp =$dumpfile->date_add_hour ($actual_day,$menos36day);
+					$day_tmp = date("Ymd", $timestamp);
+					write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [Borro archivo CDR de mas de 35 dias para ACCOUNT: $card_id.]");
+					$nom_archive = 	$dirname_customer.$card_id."_".$day_tmp.".zip";
+					write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [nom_archive -> $nom_archive]");
+					unlink($nom_archive);
+				
+					//------------------- BORRO INFO DE 35 DIAS HACIA ATRAS DE LA TABLA HISTORICA ------------------------
+					$menos35day = - 840; // 840 horas = 35 dias
+					//Resto 35 dias para obtener fecha a partir de la cual debo borrar
+					$timestamp =$dumpfile->date_add_hour ($actual_day,$menos35day);
+					$day_tmp = date("Ymd", $timestamp);
+					//Sumo el offset para obtener fecha y hora inicial.
+					$timestamp =$dumpfile->date_add_hour ($day_tmp,-$date_offset);
+					$initial_day = date("Y-m-d H:i:s", $timestamp);
+										
+					write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [Borro informacion anterior a 35 dias para ACCOUNT: $card_id.]");
+					$Query = "DELETE FROM cc_call_archive where starttime < ('$initial_day') and card_id='$card_id'; " ;
+					$res = $DBHandle -> Execute($Query);
+				}
+			}
+			write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [Borro tabla temporal.]");
+			//-------------------------BORRO TEMPORAL ------------------------------------------------------------
+			$Query = "DROP TABLE IF EXISTS $temp_table";
+			$res = $DBHandle -> Execute($Query);
+			
+			
+			
+		} else {
+			write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [NO SE PUDO INSERTAR DATOS EN LA HISTORICA.]");
+		}
+	} else {
+		write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [NO SE PUDO HACER EL RENAME.]");
+	}
 } else {
-    $condition = "DATE_SUB(NOW(),INTERVAL $prior_x_month MONTH) > starttime";
+	write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . " [NO SE PUDO CREAR LA TEMPORAL.]");
 }
 
-$value = "SELECT sessionid, uniqueid, card_id, nasipaddress, starttime, stoptime, sessiontime, calledstation, sessionbill, id_tariffgroup, id_tariffplan, id_ratecard, id_trunk, sipiax, src, id_did, buycost, id_card_package_offer, real_sessiontime, dnid, terminatecauseid, destination FROM cc_call WHERE $condition";
-$func_fields = "sessionid, uniqueid, card_id, nasipaddress, starttime, stoptime, sessiontime, calledstation, sessionbill, id_tariffgroup, id_tariffplan, id_ratecard, id_trunk, sipiax, src, id_did, buycost, id_card_package_offer, real_sessiontime, dnid, terminatecauseid, destination";
-$func_table = 'cc_call_archive';
-$id_name = "";
-$subquery = true;
-$result = $instance_table->Add_table($A2B->DBHandle, $value, $func_fields, $func_table, $id_name, $subquery);
-
-$fun_table = "cc_call";
-$result = $instance_table->Delete_table($A2B->DBHandle, $condition, $fun_table);
 write_log(LOGFILE_CRONT_ARCHIVE_DATA, basename(__FILE__) . ' line:' . __LINE__ . "[#### ARCHIVING DATA END ####]");
 
 
diff -rupN a2billing.orig/Cronjobs/lib/Misc.php a2billing/Cronjobs/lib/Misc.php
--- a2billing.orig/Cronjobs/lib/Misc.php	2012-09-18 06:38:22.000000000 -0300
+++ a2billing/Cronjobs/lib/Misc.php	2012-09-20 14:09:25.091341739 -0300
@@ -5,10 +5,10 @@
 /**
  * This file is part of A2Billing (http://www.a2billing.net/)
  *
- * A2Billing, Commercial Open Source Telecom Billing platform,
+ * A2Billing, Commercial Open Source Telecom Billing platform,   
  * powered by Star2billing S.L. <http://www.star2billing.com/>
- *
- * @copyright   Copyright (C) 2004-2012 - Star2billing S.L.
+ * 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
  * @author      Belaid Arezqui <areski@gmail.com>
  * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
  * @package     A2Billing
@@ -27,8 +27,8 @@
  *
  * You should have received a copy of the GNU Affero General Public License
  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
- *
- *
+ * 
+ * 
 **/
 
 
@@ -59,9 +59,9 @@ function a2b_decrypt($text, $key) {
  */
 function a2b_mail($to, $subject, $mail_content, $from = 'root@localhost', $fromname = '', $contenttype = 'multipart/alternative')
 {
-
+	
 	$mail = new PHPMailer(true);
-
+	
 	if (SMTP_SERVER) {
 		$mail->Mailer = "smtp";
 	} else {
@@ -85,7 +85,7 @@ function a2b_mail($to, $subject, $mail_c
 	$mail->AltBody = $mail_content; // Plain text body (for mail clients that cannot read 	HTML)
 	// if ContentType = multipart/alternative -> HTML will be send
 	$mail->ContentType = $contenttype;
-
+	
 	if (strpos($to, ',') > 0) {
 		foreach (explode(',', $to) as $toemail){
             $mail->AddAddress($toemail);
@@ -93,7 +93,7 @@ function a2b_mail($to, $subject, $mail_c
 	} else {
 	    $mail->AddAddress($to);
 	}
-
+	
 	try {
 		$mail->Send();
 	} catch (phpmailerException $e) {
@@ -236,26 +236,11 @@ function sanitize_data($input) {
 		}
 	} else {
 
-		// remove whitespaces (not a must though)
+		// remove whitespaces (not a must though)  
 		$input = trim($input);
 
 		$input = str_replace('--', '', $input);
 		$input = str_replace(';', '', $input);
-		$input = str_replace('#', '', $input);
-		$input = str_replace('/*', '', $input);
-
-		#injection sql
-		$input = str_ireplace('HAVING', '', $input);
-		$input = str_ireplace('UNION', '', $input);
-		$input = str_ireplace('SUBSTRING', '', $input);
-		$input = str_ireplace('ASCII', '', $input);
-		$input = str_ireplace('SHA1', '', $input);
-		$input = str_ireplace('MD5', '', $input);
-		$input = str_ireplace('SCRIPT', '', $input);
-		$input = str_ireplace('ROW_COUNT', '', $input);
-		$input = str_ireplace('SELECT', '', $input);
-		$input = str_ireplace('UPDATE', '', $input);
-		#$input = str_ireplace('DELETE', '', $input);
 
 		if (!(stripos($input, ' or 1') === FALSE)) {
 			return false;
@@ -268,7 +253,7 @@ function sanitize_data($input) {
 			$input = stripslashes($input);
 		}
 		$input = cleanInput($input);
-
+		
 		$output = addslashes($input);
 	}
 
@@ -351,7 +336,7 @@ function display_dateformat($mydate) {
  */
 function display_date_timestamp($timestamp){
 	echo date("m/d/Y H:i:s", $timestamp);
-}
+}	
 
 /*
  * function display_vm_callerid
@@ -359,7 +344,7 @@ function display_date_timestamp($timesta
 function display_vm_callerid($callerid_string){
 	$arr_spli = preg_split("/ /", $callerid_string);
 	echo str_replace('"',"", $arr_spli[0]);
-}
+}	
 
 
 
@@ -469,7 +454,7 @@ function linkonmonitorfile($value) {
 		}
 	}
 	if (!$find_record) return false;
-
+	
 	$myfile = base64_encode($myfile);
 	echo "<a target=_blank href=\"call-log-customers.php?download=file&file=" . $myfile . "\">";
 	echo '<img src="' . Images_Path . '/stock-mic.png" height="18" /></a>';
@@ -490,7 +475,7 @@ function linkonmonitorfile_customer($val
 		}
 	}
 	if (!$find_record) return false;
-
+	
 	$myfile = base64_encode($myfile);
 	echo "<a target=_blank href=\"call-history.php?download=file&file=" . $myfile . "\">";
 	echo '<img src="' . Images_Path . '/stock-mic.png" height="18" /></a>';
@@ -641,7 +626,7 @@ function MDP_NUMERIC($chrs = LEN_CARDNUM
     for($i = 0; $i < $chrs; $i++){
         $myrand .= mt_rand(0,9);
     }
-
+    
     return $myrand;
 }
 
@@ -884,11 +869,11 @@ function get_timezones($handle = null, $
 		$handle = DbConnect();
 	}
 	$instance_table = new Table();
-	if (!is_null($clause))
-		$clause = 'WHERE '.$clause;
+	if (!is_null($clause)) 
+		$clause = 'WHERE '.$clause; 
 	$QUERY = "SELECT id, gmttime, gmtzone, gmtoffset FROM cc_timezone $clause ORDER by id";
 	$result = $instance_table->SQLExec($handle, $QUERY, 1, 300);
-
+	
 	if (is_array($result)) {
 		$num_cur = count($result);
 		for ($i = 0; $i < $num_cur; $i++) {
@@ -904,13 +889,13 @@ function get_timezones($handle = null, $
 }
 
 function display_GMT($currDate, $number, $fulldate = 1)
-{
+{	
 	$timezone_list = get_timezones(null, "gmttime = '".SERVER_GMT."'");
 	foreach ($timezone_list as $key => $timezone_list_val) {
 		$server_offset = $timezone_list_val[3];
 		break;
 	}
-
+	
 	$date_time_array = getdate(strtotime($currDate));
 	$hours = $date_time_array['hours'];
 	$minutes = $date_time_array['minutes'];
@@ -919,7 +904,6 @@ function display_GMT($currDate, $number,
 	$day = $date_time_array['mday'];
 	$year = $date_time_array['year'];
 	$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
-
 	$timestamp = $timestamp - ($server_offset - $number);
 	/*
 	if ($fulldate == 1) {
@@ -929,7 +913,7 @@ function display_GMT($currDate, $number,
 	}
 	return $gmdate;
 	*/
-
+	
 	if ($fulldate == 1) {
 		$date = date("Y-m-d H:i:s", $timestamp);
 	} else {
@@ -1030,7 +1014,7 @@ function get_db_languages($handle = null
  */
 
 function archive_data($condition, $entity = "")
-{
+{	
 	$handle = DbConnect();
 	$instance_table = new Table();
 	if (!empty ($entity)) {
@@ -1073,7 +1057,7 @@ function do_field($sql, $fld, $dbfld) {
 	$fldtype = $fld . 'type';
 	global $$fld;
 	global $$fldtype;
-
+	
 	if ($$fld) {
 		if (strpos($sql, 'WHERE') > 0) {
 			$sql = "$sql AND ";
@@ -1114,7 +1098,7 @@ function currencies_update_yahoo ($DBHan
 	$strong_currency = 'EUR';
 	$url = "http://download.finance.yahoo.com/d/quotes.csv?s=";
 	$return = "";
-
+	
 	$QUERY = "SELECT id, currency, basecurrency FROM cc_currencies ORDER BY id";
 	$old_currencies = $instance_table->SQLExec($DBHandle, $QUERY);
 
@@ -1172,7 +1156,7 @@ function currencies_update_yahoo ($DBHan
 				return gettext("At least one of the entries in the CSV file isn't a number.") . ' ' . gettext('Currency update ABORTED.');
 			}
 		}
-
+		
 		// Find base_currency's value in $strong_currency to help avoid Yahoo's
 		// early truncation,  and therefore win back a lot of accuracy
 		$base_value = $currencies[$index_base_currency];
@@ -1250,7 +1234,7 @@ function generate_invoice_reference() {
 	$invoice_conf_table = new Table('cc_invoice_conf', 'value');
 	$conf_clause = "key_val = 'count_$year'";
 	$result = $invoice_conf_table->Get_list($handle, $conf_clause, 0);
-
+	
 	if (is_array($result) && !empty ($result[0][0])) {
 		$count = $result[0][0];
 		if (!is_numeric($count)) {
@@ -1339,13 +1323,13 @@ function mt_get()
     list($usec, $sec) = explode(" ", microtime());
     return ((float)$usec + (float)$sec);
 }
-
+ 
 // mt_start: starts the microtime counter
 function mt_start()
 {
     global $mt_time; $mt_time = mt_get();
 }
-
+ 
 // mt_end: calculates the elapsed time
 function mt_end($len=4)
 {
@@ -1376,8 +1360,8 @@ function open_url($url)
     $string = ob_get_contents();
 
     ob_end_clean();
-
-    return $string;
+   
+    return $string;    
 }
 
 
@@ -1387,22 +1371,22 @@ function open_url($url)
 function retrieve_rates_callplan($callplan_id, $DBHandle)
 {
     $instance_table = new Table();
-
+    
     $QUERY = "SELECT DISTINCT cc_ratecard.destination, cc_ratecard.dialprefix, cc_ratecard.buyrate, cc_ratecard.rateinitial, cc_ratecard.startdate, cc_ratecard.stopdate, cc_ratecard.initblock, " .
     		"cc_ratecard.connectcharge, cc_ratecard.id_trunk , cc_ratecard.idtariffplan , cc_ratecard.id FROM cc_tariffgroup RIGHT JOIN cc_tariffgroup_plan ON cc_tariffgroup_plan.idtariffgroup=cc_tariffgroup.id " .
     		"INNER JOIN cc_tariffplan ON (cc_tariffplan.id=cc_tariffgroup_plan.idtariffplan ) LEFT JOIN cc_ratecard ON cc_ratecard.idtariffplan=cc_tariffplan.id WHERE cc_tariffgroup.id= '$callplan_id' " .
     		"AND cc_ratecard.rateinitial = (SELECT min(c1.rateinitial) FROM cc_tariffgroup RIGHT JOIN cc_tariffgroup_plan ON cc_tariffgroup_plan.idtariffgroup=cc_tariffgroup.id " .
     		"INNER JOIN cc_tariffplan ON (cc_tariffplan.id=cc_tariffgroup_plan.idtariffplan ) LEFT JOIN cc_ratecard AS c1 ON c1.idtariffplan=cc_tariffplan.id WHERE cc_tariffgroup.id= '$callplan_id' " .
     		"AND cc_ratecard.dialprefix=c1.dialprefix) ORDER BY destination ASC";
-
+	
 	$result = $instance_table -> SQLExec ($DBHandle, $QUERY, 1, 3600); // cached for 1hour
-
+	
 	if (!is_array($result)) {
 	    return false;
 	}
-
+	
 	return $result;
-
+	
 }
 
 /*
@@ -1412,16 +1396,16 @@ function check_cp()
 {
 	$randn = rand(1, 10);
 	$ret_val = ($randn == 5)? 1 : 0;
-
+	
 	$pos_star = strpos(COPYRIGHT, 'star2billing');
 	if ($pos_star === false) {
 		return $ret_val;
 	}
 	$pageURL = get_curPageURL();
     $pos = strpos($pageURL, 'phpsysinfo');
-
+    
     if ($pos === false) {
-
+        
         $footer_content = file_get_contents("templates/default/footer.tpl");
 
         $pos_copyright = strpos($footer_content, '$COPYRIGHT');
@@ -1489,7 +1473,7 @@ function addRealMonth($timeStamp)
 
 
 function Display_Login_Button ($DBHandle, $id) {
-
+	
 	$inst_table = new Table("cc_card", "useralias, uipass");
 	$FG_TABLE_CLAUSE = "id = $id";
 	$list_card_info = $inst_table -> Get_list ($DBHandle, $FG_TABLE_CLAUSE);
@@ -1515,3 +1499,22 @@ function Display_Login_Button ($DBHandle
 }
 
 
+function date_add_hour($tmpdate, $hour = 0) {
+	
+	$second = $hour * 60 * 60 ;
+	$date_time_array = getdate(strtotime($tmpdate));
+	
+
+	$hours = $date_time_array['hours'];
+	$minutes = $date_time_array['minutes'];
+	$seconds = $date_time_array['seconds'];
+	$month = $date_time_array['mon'];
+	$day = $date_time_array['mday'];
+	$year = $date_time_array['year'];
+	
+	$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
+
+	$timestamp = $timestamp + $second;
+
+	return $timestamp;
+}
diff -rupN a2billing.orig/customer/call-history.php a2billing/customer/call-history.php
--- a2billing.orig/customer/call-history.php	2012-09-18 06:38:22.000000000 -0300
+++ a2billing/customer/call-history.php	2012-09-20 14:09:25.111341753 -0300
@@ -8,7 +8,7 @@
  * A2Billing, Commercial Open Source Telecom Billing platform,   
  * powered by Star2billing S.L. <http://www.star2billing.com/>
  * 
- * @copyright   Copyright (C) 2004-2012 - Star2billing S.L. 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
  * @author      Belaid Arezqui <areski@gmail.com>
  * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
  * @package     A2Billing
@@ -100,7 +100,7 @@ if (!isset ($current_page) || ($current_
 }
 
 $FG_DEBUG = 0;
-$FG_TABLE_NAME="cc_call t1";
+$FG_TABLE_NAME="cc_call_archive t1";
 
 // THIS VARIABLE DEFINE THE COLOR OF THE HEAD TABLE
 $FG_TABLE_ALTERNATE_ROW_COLOR[] = "#FFFFFF";
@@ -169,32 +169,90 @@ if ($posted==1) {
 	$SQLcmd = do_field($SQLcmd, 'phonenumber', 'calledstation');
 }
 
+//Obtengo offset del server respecto a UTC
+$timezone_list = get_timezones(null, "gmttime = '".SERVER_GMT."'");
+foreach ($timezone_list as $key => $timezone_list_val) {
+	$server_offset = $timezone_list_val[3];
+	break;
+}
+//Obtengo el offset del account respecto a UTC
+$account_offset = $_SESSION["gmtoffset"];
 
+$date_offset = (-($server_offset - $account_offset)) / 60 / 60;
+	
 $date_clause = '';
 
 normalize_day_of_month($fromstatsday_sday, $fromstatsmonth_sday, 1);
 normalize_day_of_month($tostatsday_sday, $tostatsmonth_sday, 1);
-if ($fromday && isset($fromstatsday_sday) && isset($fromstatsmonth_sday)) $date_clause.=" AND t1.starttime >= ('$fromstatsmonth_sday-$fromstatsday_sday')";
-if ($today && isset($tostatsday_sday) && isset($tostatsmonth_sday)) $date_clause.=" AND t1.starttime <= ('$tostatsmonth_sday-".sprintf("%02d",intval($tostatsday_sday)/*+1*/)." 23:59:59')";
 
-  
+// Calculo fecha maxima a mostrar
+$actual_date = date("Y-m-d");
+//Resto un dias a la fecha actual
+$menos1day = - 24;
+$timestamp = date_add_hour($actual_date,$menos1day);
+$date_tmp = date("Y-m-d", $timestamp);
+//Sumo el offset para obtener fecha y hora inicial.
+$timestamp =date_add_hour ($date_tmp,-$date_offset);
+$max_end_date = date("Y-m-d H:i:s", $timestamp);
+
+// Selecciona fecha de inicio
+if ($fromday && isset($fromstatsday_sday) && isset($fromstatsmonth_sday)) {
+	$date_ini = $fromstatsmonth_sday."-".$fromstatsday_sday;
+	$timestamp = date_add_hour($date_ini,-$date_offset);
+	$init_date = date("Y-m-d H:i:s", $timestamp);
+	$date_clause .=" AND t1.starttime >= ('$init_date')";
+}
+
+// Selecciona fecha de fin
+if ($today && isset($tostatsday_sday) && isset($tostatsmonth_sday)) {
+	$date_fin = $tostatsmonth_sday."-".$tostatsday_sday;
+	$timestamp = date_add_hour($date_fin,24);
+	$date_fin = date("Y-m-d H:i:s", $timestamp);
+	$timestamp = date_add_hour($date_fin,-$date_offset);
+	//fecha fin seleccionada
+	$fin_date = date("Y-m-d H:i:s", $timestamp);
+
+	if ($fin_date > $max_end_date ) {
+		$fin_date = $max_end_date;
+	}
+	
+	$date_clause.= " AND t1.starttime < ('$fin_date')";
+} else {
+	if ($fromday && isset($fromstatsday_sday) && isset($fromstatsmonth_sday)) {		
+		$date_clause.= " AND t1.starttime < ('$max_end_date')";
+	}
+}
+
 if (strpos($SQLcmd, 'WHERE') > 0) {
+	if (strpos($date_clause, 'AND') <= 0) {
+		$date_clause.= " AND t1.starttime < ('$max_end_date')";
+	}
 	$FG_TABLE_CLAUSE = substr($SQLcmd,6).$date_clause;
 } elseif (strpos($date_clause, 'AND') > 0) {
 	$FG_TABLE_CLAUSE = substr($date_clause,5);
 }
 
-
 if (!isset ($FG_TABLE_CLAUSE) || strlen($FG_TABLE_CLAUSE)==0) {
-	$cc_yearmonth = sprintf("%04d-%02d-%02d",date("Y"),date("n"),date("d"));
-	$FG_TABLE_CLAUSE=" t1.starttime >= ('$cc_yearmonth')";
-}
+	$actual_date = date("Y-m-d");
+	
+	//Resto dos dias para obtener la fecha inicial a generar
+	$menos2day = - 48;
+	$timestamp = date_add_hour($actual_date,$menos2day);
+	$initial_date_tmp = date("Y-m-d", $timestamp);
+	
+	//Sumo el offset para obtener fecha y hora inicial.
+	$timestamp =date_add_hour ($initial_date_tmp,-$date_offset);
+	$initial_date = date("Y-m-d H:i:s", $timestamp);
 
+	$timestamp =date_add_hour ($initial_date,24);
+	$end_date = date("Y-m-d H:i:s", $timestamp);
+
+	$FG_TABLE_CLAUSE=" t1.starttime >= ('$initial_date') and t1.starttime <= ('$end_date')";
+}
 
 if (strlen($FG_TABLE_CLAUSE)>0) $FG_TABLE_CLAUSE.=" AND ";
 $FG_TABLE_CLAUSE.="t1.card_id='$customer'";
 
-
 if (isset($choose_calltype) && ($choose_calltype!=-1)) {
 	if (strlen($FG_TABLE_CLAUSE)>0) $FG_TABLE_CLAUSE.=" AND ";
 	$FG_TABLE_CLAUSE .= " t1.sipiax='$choose_calltype' ";
@@ -212,7 +270,12 @@ if (!$nodisplay) {
 }
 $_SESSION["pr_sql_export"] = "SELECT $FG_COL_QUERY FROM $FG_TABLE_NAME WHERE $FG_TABLE_CLAUSE";
 
-$QUERY = "SELECT DATE(t1.starttime) AS day, sum(t1.sessiontime) AS calltime, sum(t1.sessionbill) AS cost, count(*) as nbcall FROM $FG_TABLE_NAME WHERE ".$FG_TABLE_CLAUSE." GROUP BY day ORDER BY day"; //extract(DAY from calldate)
+if ($date_offset < 0) {
+	$off_temp = -$date_offset;
+	$QUERY = "SELECT DATE(DATE_SUB(t1.starttime,INTERVAL $off_temp HOUR)) AS day, sum(t1.sessiontime) AS calltime, sum(t1.sessionbill) AS cost, count(*) as nbcall FROM $FG_TABLE_NAME WHERE ".$FG_TABLE_CLAUSE." GROUP BY day ORDER BY day"; //extract(DAY from calldate)	
+} else {
+	$QUERY = "SELECT DATE(DATE_ADD(t1.starttime,INTERVAL $date_offset HOUR)) AS day, sum(t1.sessiontime) AS calltime, sum(t1.sessionbill) AS cost, count(*) as nbcall FROM $FG_TABLE_NAME WHERE ".$FG_TABLE_CLAUSE." GROUP BY day ORDER BY day"; //extract(DAY from calldate)
+}
 
 if (!$nodisplay) {
 	$res = $DBHandle -> Execute($QUERY);
@@ -242,7 +305,7 @@ if ($nb_record<=$FG_LIMITE_DISPLAY) {
 $smarty->display( 'main.tpl');
 
 // #### HELP SECTION
-echo $CC_help_balance_customer;
+echo $CC_help_balance_customer_calls_history;
 
 ?>
 
@@ -654,6 +717,55 @@ foreach ($list_total_day as $data){
 	  
 </td></tr></table>
 
+<!-- SECTION EXPORT //--> &nbsp; &nbsp; 
+
+ <table border="0" cellspacing="0" cellpadding="0" width="80%"><tr><td align="left" height="30">
+		<table cellspacing="0" cellpadding="1" bgcolor="#000000" width="50%"><tr><td>
+			<table cellspacing="0" cellpadding="0" width="100%">
+				<tr><td class="callhistory_td1" align="left" ><?php echo gettext("CDR TO DOWNLOAD");?></td></tr>
+			</table>
+		</td></tr></table>
+ </td></tr></table>
+
+<table border="0" cellspacing="0" cellpadding="0"  width="80%">
+<tr><td >			
+	<table border="0" cellspacing="1" cellpadding="2" width="50%">
+	<tr>
+		<td align="center" class="callhistory_td3"><?php echo gettext("CDR Date");?></td>
+        <td align="center" class="callhistory_td2"><?php echo gettext("File to Download");?></td>
+	</tr>
+
+	<!-- LOOP -->
+<?php
+    $dir = "/var/www/html/billing/customer_cdr/".$_SESSION["card_id"];
+	$dh = opendir($dir);
+	$files=array();
+    while (($file = readdir($dh)) !== false) {
+		if (is_file($dir.'/'.$file) && $file != "." && $file != ".."){ 
+			if($file!=".DS_Store"){
+				$files[] = $file;
+			}
+		}
+	}
+	closedir($dh);
+	sort($files, SORT_LOCALE_STRING);
+	foreach ($files as $f){
+		$data_date = substr($f,strpos($f, '_') + 1,8);
+		$data_date = substr($data_date,0,4)."-".substr($data_date,4,2)."-".substr($data_date,6,2);
+?>
+			<tr>
+				<td align="right" class="callhistory_td3"> <?php echo "$data_date"?></td>
+				<td align="center" class="callhistory_td2">
+					<a href="export_csv_customer.php?var_file=<?php echo "$f"?>&var_card_id=<?php echo $_SESSION["card_id"]?>" target="_blank"><?php echo gettext ( "CDR File" ); ?></a> 
+				</td>
+			</tr>
+<?php
+	}
+?>
+	</table>
+</td></tr></table>
+- &nbsp; &nbsp;
+
 <?php  } else { ?>
 	<center><h3><?php echo gettext("No calls in your selection");?>.</h3></center>
 <?php  } ?>
diff -rupN a2billing.orig/customer/call.php a2billing/customer/call.php
--- a2billing.orig/customer/call.php	1969-12-31 21:00:00.000000000 -0300
+++ a2billing/customer/call.php	2012-09-20 14:09:25.111341753 -0300
@@ -0,0 +1,658 @@
+<?php
+
+/* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4: */
+
+/**
+ * This file is part of A2Billing (http://www.a2billing.net/)
+ *
+ * A2Billing, Commercial Open Source Telecom Billing platform,   
+ * powered by Star2billing S.L. <http://www.star2billing.com/>
+ * 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
+ * @author      Belaid Arezqui <areski@gmail.com>
+ * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
+ * @package     A2Billing
+ *
+ * Software License Agreement (GNU Affero General Public License)
+ *
+ * This program is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU Affero General Public License as
+ * published by the Free Software Foundation, either version 3 of the
+ * License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Affero General Public License for more details.
+ *
+ * You should have received a copy of the GNU Affero General Public License
+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
+ * 
+ * 
+**/
+
+
+include ("lib/customer.defines.php");
+include ("lib/customer.module.access.php");
+include ("lib/customer.smarty.php");
+
+
+if (! has_rights (ACX_CALL_HISTORY)) { 
+	Header ("HTTP/1.0 401 Unauthorized");
+	Header ("Location: PP_error.php?c=accessdenied");	   
+	die();
+}
+
+getpost_ifset(array('posted', 'Period', 'frommonth', 'fromstatsmonth', 'tomonth', 'tostatsmonth', 'fromday', 'fromstatsday_sday', 'fromstatsmonth_sday', 'today', 'tostatsday_sday', 'tostatsmonth_sday', 'phonenumbertype', 'sourcetype', 'clidtype', 'channel', 'resulttype', 'stitle', 'atmenu', 'current_page', 'order', 'sens', 'phonenumber', 'src', 'clid', 'choose_currency', 'terminatecauseid', 'choose_calltype', 'download', 'file'));
+
+
+if (($download == "file") && $file && $ACXSEERECORDING) {
+	
+	if (strpos($file, '/') !== false) exit;
+	
+	$value_de = base64_decode ( $file );
+	$dl_full = MONITOR_PATH . "/" . $value_de;
+	$dl_name = $value_de;
+	
+	if (! file_exists ( $dl_full )) {
+		echo gettext ( "ERROR: Cannot download file " . $dl_full . ", it does not exist.<br>" );
+		exit ();
+	}
+	
+	header ( "Content-Type: application/octet-stream" );
+	header ( "Content-Disposition: attachment; filename=$dl_name" );
+	header ( "Content-Length: " . filesize ( $dl_full ) );
+	header ( "Accept-Ranges: bytes" );
+	header ( "Pragma: no-cache" );
+	header ( "Expires: 0" );
+	header ( "Cache-Control: must-revalidate, post-check=0, pre-check=0" );
+	header ( "Content-transfer-encoding: binary" );
+	
+	@readfile ( $dl_full );
+	exit ();
+}
+
+
+$QUERY = "SELECT username, credit, lastname, firstname, address, city, state, country, zipcode, phone, email, fax, lastuse, activated, status FROM cc_card WHERE username = '".$_SESSION["pr_login"]."' AND uipass = '".$_SESSION["pr_password"]."'";
+
+$DBHandle_max = DbConnect();
+$numrow = 0;
+$resmax = $DBHandle_max -> Execute($QUERY);
+if ($resmax)
+	$numrow = $resmax -> RecordCount();
+
+if ($numrow == 0) exit();
+$customer_info =$resmax -> fetchRow();
+
+if ($customer_info[14] != "1" && $customer_info[14] != "8") {
+	Header("HTTP/1.0 401 Unauthorized");
+	Header("Location: PP_error.php?c=accessdenied");
+	die();
+}
+
+$customer = $_SESSION["card_id"];
+
+
+$dialstatus_list = Constants::getDialStatusList();
+
+if (!isset ($current_page) || ($current_page == "")) {
+	$current_page=0;
+}
+
+$FG_DEBUG = 0;
+$FG_TABLE_NAME="cc_call t1";
+
+// THIS VARIABLE DEFINE THE COLOR OF THE HEAD TABLE
+$FG_TABLE_ALTERNATE_ROW_COLOR[] = "#FFFFFF";
+$FG_TABLE_ALTERNATE_ROW_COLOR[] = "#F2F8FF";
+
+$yesno = array();
+$yesno["1"] = array( "Yes", "1");
+$yesno["0"] = array( "No", "0");
+
+// 0 = NORMAL CALL ; 1 = VOIP CALL (SIP/IAX) ; 2= DIDCALL + TRUNK ; 3 = VOIP CALL DID ; 4 = CALLBACK call
+$list_calltype = array(); 
+$list_calltype["0"]  = array( gettext("STANDARD"), "0");
+$list_calltype["1"]  = array( gettext("SIP/IAX"), "1");
+$list_calltype["2"]  = array( gettext("DIDCALL"), "2");
+$list_calltype["3"]  = array( gettext("DID_VOIP"), "3");
+$list_calltype["4"]  = array( gettext("CALLBACK"), "4");
+$list_calltype["5"]  = array( gettext("PREDICT"), "5");
+$list_calltype ["6"] = array (gettext("AUTO DIALER"), "6" );
+$list_calltype ["7"] = array (gettext("DID-ALEG"), "7" );
+
+$DBHandle  = DbConnect();
+
+$FG_TABLE_DEFAULT_ORDER = "starttime";
+$FG_TABLE_DEFAULT_SENS = "DESC";
+
+$FG_TABLE_COL = array();
+$FG_TABLE_COL[]=array (gettext("Date"), "starttime", "17%", "center", "SORT", "22", "", "", "", "", "", "");
+$FG_TABLE_COL[]=array (gettext("CallerID"), "source", "14%", "center", "SORT", "30");
+$FG_TABLE_COL[]=array (gettext("PhoneNumber"), "calledstation", "14%", "center", "SORT", "30", "", "", "", "", "", "");
+$FG_TABLE_COL[]=array (gettext("Destination"), "destination", "14%", "center", "SORT", "30", "lie", "cc_prefix", "destination", "prefix='%id'", "%1" );
+$FG_TABLE_COL[]=array (gettext("Duration"), "sessiontime", "10%", "center", "SORT", "30", "", "", "", "", "", "display_minute");
+$FG_TABLE_COL[]=array ('<acronym title="'.gettext("Terminate Cause").'">'.gettext("TC").'</acronym>', "terminatecauseid", "10%", "center", "SORT", "", "list", $dialstatus_list);
+$FG_TABLE_COL[]=array (gettext("CallType"), "sipiax", "12%", "center", "SORT",  "", "list", $list_calltype);
+$FG_TABLE_COL[]=array (gettext("Cost"), "sessionbill", "12%", "center", "SORT", "30", "", "", "", "", "", "display_2bill");
+
+if ($ACXSEERECORDING) {
+	$FG_TABLE_COL [] = array ("", "uniqueid", "1%", "center", "", "30", "", "", "", "", "", "linkonmonitorfile_customer" );
+}
+
+$FG_COL_QUERY = 't1.starttime, t1.src, t1.calledstation, t1.destination, t1.sessiontime, t1.terminatecauseid, t1.sipiax, t1.sessionbill';
+
+if ($ACXSEERECORDING) {
+	$FG_COL_QUERY .= ', t1.uniqueid';
+}
+
+$FG_LIMITE_DISPLAY = 25;
+$FG_NB_TABLE_COL = count($FG_TABLE_COL);
+$FG_EDITION = true;
+$FG_TOTAL_TABLE_COL = $FG_NB_TABLE_COL;
+if ($FG_DELETION || $FG_EDITION) $FG_TOTAL_TABLE_COL++;
+$FG_HTML_TABLE_TITLE = " - ".gettext("Call Logs")." - ";
+$FG_HTML_TABLE_WIDTH = "98%";
+
+
+$instance_table = new Table($FG_TABLE_NAME, $FG_COL_QUERY);
+
+if ( is_null ($order) || is_null($sens) ){
+	$order = $FG_TABLE_DEFAULT_ORDER;
+	$sens  = $FG_TABLE_DEFAULT_SENS;
+}
+
+if ($posted==1) {
+	$SQLcmd = '';
+	$SQLcmd = do_field($SQLcmd, 'src', 'source');
+	$SQLcmd = do_field($SQLcmd, 'phonenumber', 'calledstation');
+}
+
+$date_clause = '';
+  
+//Obtengo offset del server respecto a UTC
+$timezone_list = get_timezones(null, "gmttime = '".SERVER_GMT."'");
+foreach ($timezone_list as $key => $timezone_list_val) {
+	$server_offset = $timezone_list_val[3];
+	break;
+}
+//Obtengo el offset del account respecto a UTC
+$account_offset = $_SESSION["gmtoffset"];
+
+$actual_date = date("Y-m-d H:i:s");
+$date_time_array = getdate(strtotime($actual_date));
+$hours = $date_time_array['hours'];
+$minutes = $date_time_array['minutes'];
+$seconds = $date_time_array['seconds'];
+$month = $date_time_array['mon'];
+$day = $date_time_array['mday'];
+$year = $date_time_array['year'];
+$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
+
+//dia de ayer segun horario del cliente
+$timestamp = $timestamp -($server_offset - $account_offset) - 86400 ;
+$timestamp = date("Y-m-d", $timestamp);
+	
+$date_time_array = getdate(strtotime($timestamp));
+$hours = $date_time_array['hours'];
+$minutes = $date_time_array['minutes'];
+$seconds = $date_time_array['seconds'];
+$month = $date_time_array['mon'];
+$day = $date_time_array['mday'];
+$year = $date_time_array['year'];
+$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
+
+$timestamp = $timestamp  + ($server_offset - $account_offset);
+
+$timestamp = date("Y-m-d H:i:s", $timestamp);
+
+$date_clause= " and t1.starttime >= ('$timestamp')";
+
+//calculo el offset general	
+$date_offset = (-($server_offset - $account_offset)) / 60 / 60 ;
+
+if (strpos($SQLcmd, 'WHERE') > 0) {
+	$FG_TABLE_CLAUSE = substr($SQLcmd,6).$date_clause;
+} else {
+	$FG_TABLE_CLAUSE = substr($date_clause,5);
+}
+
+if (strlen($FG_TABLE_CLAUSE)>0) $FG_TABLE_CLAUSE.=" AND ";
+$FG_TABLE_CLAUSE.="t1.card_id='$customer'";
+
+
+if (isset($choose_calltype) && ($choose_calltype!=-1)) {
+	if (strlen($FG_TABLE_CLAUSE)>0) $FG_TABLE_CLAUSE.=" AND ";
+	$FG_TABLE_CLAUSE .= " t1.sipiax='$choose_calltype' ";
+}
+
+if (!isset($terminatecauseid)) {
+	$terminatecauseid="ANSWER";
+} elseif ($terminatecauseid=="ANSWER") {
+	if (strlen($FG_TABLE_CLAUSE)>0) $FG_TABLE_CLAUSE .= " AND ";
+	$FG_TABLE_CLAUSE .= " (t1.terminatecauseid=1) ";
+}
+
+//CREO TABLA TEMPORAL
+$sql1 = "CREATE TEMPORARY TABLE cc_call_archive_temp (SELECT t1.starttime, t1.src, t1.calledstation, t1.destination, t1.sessiontime, t1.terminatecauseid, ";
+$sql1 .= "t1.sipiax, t1.sessionbill FROM cc_call_archive t1 WHERE ".$FG_TABLE_CLAUSE." )";
+
+$res = $DBHandle -> Execute($sql1);
+
+if (!$nodisplay) {
+	$list = $instance_table -> Get_list_union ($DBHandle, $FG_TABLE_CLAUSE, $order, $sens, null, null, $FG_LIMITE_DISPLAY, $current_page*$FG_LIMITE_DISPLAY, null, null);
+	//$list = $instance_table -> Get_list ($DBHandle, $FG_TABLE_CLAUSE, $order, $sens, null, null, $FG_LIMITE_DISPLAY, $current_page*$FG_LIMITE_DISPLAY);
+}
+
+$_SESSION["pr_sql_export"] = "SELECT $FG_COL_QUERY FROM $FG_TABLE_NAME WHERE $FG_TABLE_CLAUSE";
+
+if ($date_offset < 0) {
+	$off_temp = -$date_offset;
+	$QUERY = "SELECT DATE(DATE_SUB(tbl.starttime,INTERVAL $off_temp HOUR)) AS day, sum(tbl.sessiontime) AS calltime, sum(tbl.sessionbill) AS cost, count(*) as nbcall FROM (";
+} else {
+	$QUERY = "SELECT DATE(DATE_ADD(tbl.starttime,INTERVAL $date_offset HOUR)) AS day, sum(tbl.sessiontime) AS calltime, sum(tbl.sessionbill) AS cost, count(*) as nbcall FROM (";
+}
+$QUERY .= " select t1.starttime, t1.sessiontime,t1.sessionbill FROM $FG_TABLE_NAME WHERE ".$FG_TABLE_CLAUSE;
+$QUERY .= " UNION ALL select t1.starttime, t1.sessiontime,t1.sessionbill FROM cc_call_archive_temp t1 ) tbl ";
+$QUERY .= " GROUP BY day ORDER BY day"; //extract(DAY from calldate)
+
+if (!$nodisplay) {
+	$res = $DBHandle -> Execute($QUERY);
+	if ($res) {
+		$num = $res -> RecordCount();
+		for($i=0;$i<$num;$i++) {				
+			$list_total_day [] =$res -> fetchRow();
+		}
+	}
+
+	$row_temp = 0;
+	$QUERY = "select count(*) from cc_call_archive_temp";
+	$res = $DBHandle -> Execute($QUERY);
+	if ($res) {
+		$row = $res -> fetchRow();
+		$row_temp = $row['0'];
+	}
+
+	if ($FG_DEBUG == 3) echo "<br>Clause : $FG_TABLE_CLAUSE";
+	$nb_record = $instance_table -> Table_count ($DBHandle, $FG_TABLE_CLAUSE);
+	$nb_record = $nb_record + $row_temp;
+	if ($FG_DEBUG >= 1) var_dump ($list);
+}
+
+//Borro tabla temporal
+$sql1 = "DROP TABLE cc_call_archive_temp";
+$res = $DBHandle -> Execute($sql1);
+
+
+if ($nb_record<=$FG_LIMITE_DISPLAY) { 
+	$nb_record_max=1;
+} else { 
+	if ($nb_record % $FG_LIMITE_DISPLAY == 0) {
+		$nb_record_max=(intval($nb_record/$FG_LIMITE_DISPLAY));
+	} else {
+		$nb_record_max=(intval($nb_record/$FG_LIMITE_DISPLAY)+1);
+	}	
+}
+
+
+$smarty->display( 'main.tpl');
+
+// #### HELP SECTION
+echo $CC_help_balance_customer_calls;
+
+?>
+
+
+<!-- ** ** ** ** ** Part for the research ** ** ** ** ** -->
+	<center>
+	<FORM METHOD=POST ACTION="<?php echo $PHP_SELF?>?s=1&t=0&order=<?php echo $order?>&sens=<?php echo $sens?>&current_page=<?php echo $current_page?>&terminatecauseid=<?php echo $terminatecauseid?>">
+		<INPUT TYPE="hidden" NAME="posted" value=1>
+		<INPUT TYPE="hidden" NAME="current_page" value=0>
+		<table class="callhistory_maintable" align="center">
+			
+			
+			<tr>
+				<td  align="left" class="bgcolor_004">
+					<font class="fontstyle_003">&nbsp;&nbsp;<?php echo gettext("PHONENUMBER");?></font>
+				</td>
+				<td  align="left" class="bgcolor_005">
+				<table width="100%" border="0" cellspacing="0" cellpadding="0">
+				<tr><td class="fontstyle_searchoptions">&nbsp;&nbsp;<INPUT TYPE="text" NAME="phonenumber" value="<?php echo $phonenumber?>" class="form_input_text"></td>
+				<td  align="center" class="fontstyle_searchoptions"><input type="radio" NAME="phonenumbertype" value="1" <?php if((!isset($phonenumbertype))||($phonenumbertype==1)){?>checked<?php }?>><?php echo gettext("Exact");?></td>
+				<td  align="center" class="fontstyle_searchoptions"><input type="radio" NAME="phonenumbertype" value="2" <?php if($phonenumbertype==2){?>checked<?php }?>><?php echo gettext("Begins with")?></td>
+				<td  align="center" class="fontstyle_searchoptions"><input type="radio" NAME="phonenumbertype" value="3" <?php if($phonenumbertype==3){?>checked<?php }?>><?php echo gettext("Contains");?></td>
+				<td  align="center" class="fontstyle_searchoptions"><input type="radio" NAME="phonenumbertype" value="4" <?php if($phonenumbertype==4){?>checked<?php }?>><?php echo gettext("Ends with");?></td>
+				</tr></table></td>
+			</tr>		
+			<!-- Select Calltype: -->
+			<tr>
+			  <td class="bgcolor_002" align="left" ><font class="fontstyle_003">&nbsp;&nbsp;<?php echo gettext("CALL TYPE"); ?></font></td>
+			  <td class="bgcolor_003" align="center">
+			  <table width="100%" border="0" cellspacing="0" cellpadding="0">
+								<tr>
+					<td  class="fontstyle_searchoptions">
+					<select NAME="choose_calltype" size="1" class="form_input_select" >
+						<option value='-1' <?php if (($choose_calltype==-1) || (!isset($choose_calltype))){?>selected<?php } ?>><?php echo gettext('ALL CALLS') ?>
+								</option>
+							<?php
+								foreach($list_calltype as $key => $cur_value) {
+							?>
+								<option value='<?php echo $cur_value[1] ?>' <?php if ($choose_calltype==$cur_value[1]){?>selected<?php } ?>><?php echo gettext($cur_value[0]) ?>
+								</option>
+							<?php 	} ?>
+						</select>
+					</td>
+				</tr>				
+				</table>
+			  </td>
+			  </tr>
+	
+			<!-- Select Option : to show just the Answered Calls or all calls, Result type, currencies... -->
+			<tr>
+			  <td class="bgcolor_002" align="left" ><font class="fontstyle_003">&nbsp;&nbsp;<?php echo gettext("OPTIONS"); ?></font></td>
+			  <td class="bgcolor_003" align="center">
+			  <table width="100%" border="0" cellspacing="0" cellpadding="0">
+				<tr>
+					<td width="20%"  class="fontstyle_searchoptions">
+						<?php echo gettext("SHOW");?> :  						
+				   </td>
+				   <td width="80%"  class="fontstyle_searchoptions">				   		
+				 <?php echo gettext("Answered Calls"); ?>
+				  <input name="terminatecauseid" type="radio" value="ANSWER" <?php if((!isset($terminatecauseid))||($terminatecauseid=="ANSWER")){?>checked<?php }?> />
+				  <?php echo gettext("All Calls"); ?>
+
+				   <input name="terminatecauseid" type="radio" value="ALL" <?php if($terminatecauseid=="ALL"){?>checked<?php }?>/>
+					</td>
+				</tr>
+				<tr class="bgcolor_005">
+					<td  class="fontstyle_searchoptions">
+						<?php echo gettext("RESULT");?> : 
+				   </td>
+				   <td  class="fontstyle_searchoptions">
+					<?php echo gettext("Minutes");?><input type="radio" NAME="resulttype" value="min" <?php if((!isset($resulttype))||($resulttype=="min")){?>checked<?php }?>> - <?php echo gettext("Seconds");?> <input type="radio" NAME="resulttype" value="sec" <?php if($resulttype=="sec"){?>checked<?php }?>>
+					</td>
+				</tr>
+				<tr>
+					<td  class="fontstyle_searchoptions">
+						<?php echo gettext("CURRENCY");?> :
+					</td>
+					<td  class="fontstyle_searchoptions">
+					<select NAME="choose_currency" size="1" class="form_input_select" >
+							<?php
+								$currencies_list = get_currencies();
+								foreach($currencies_list as $key => $cur_value) {
+							?>
+								<option value='<?php echo $key ?>' <?php if (($choose_currency==$key) || (!isset($choose_currency) && $key==strtoupper(BASE_CURRENCY))){?>selected<?php } ?>><?php echo $cur_value[1].' ('.$cur_value[2].')' ?>
+								</option>
+							<?php 	} ?>
+						</select>
+					</td>
+				</tr>				
+				</table>
+			  </td>
+			  </tr>
+			<!-- Select Option : to show just the Answered Calls or all calls, Result type, currencies... -->
+			
+			<tr>
+        		<td class="bgcolor_004" align="left" > </td>
+				<td class="bgcolor_005" align="center" >
+					<input class="form_input_button" value=" <?php echo gettext("Search");?> " type="submit">
+	  			</td>
+    		</tr>
+	</table>
+	</FORM>
+</center>
+
+
+<!-- ** ** ** ** ** Part to display the CDR ** ** ** ** ** -->
+<center><?php echo gettext("Number of Calls");?> : <?php  if (is_array($list) && count($list)>0){ echo $nb_record; }else{echo "0";}?></center>
+     <table width="<?php echo $FG_HTML_TABLE_WIDTH?>" border="0" align="center" cellpadding="0" cellspacing="0">
+		<TR bgcolor="#ffffff"> 
+          <TD class="callhistory_td11"> 
+            <TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
+                <TR> 
+                  <TD><SPAN style="COLOR: #ffffff; FONT-SIZE: 11px"><B><?php echo $FG_HTML_TABLE_TITLE?></B></SPAN></TD>
+                </TR>
+            </TABLE></TD>
+        </TR>
+        <TR> 
+          <TD> <TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
+                <TR class="bgcolor_008">
+				  <TD width="<?php echo $FG_ACTION_SIZE_COLUMN?>" align="center" class="tableBodyRight" style="PADDING-BOTTOM: 2px; PADDING-LEFT: 2px; PADDING-RIGHT: 2px; PADDING-TOP: 2px"></TD>					
+				  
+                  <?php 
+				  	if (is_array($list) && count($list)>0) {
+					
+				  	for($i=0;$i<$FG_NB_TABLE_COL;$i++) {
+					?>
+	                  <TD width="<?php echo $FG_TABLE_COL[$i][2]?>" align=middle class="tableBody" style="PADDING-BOTTOM: 2px; PADDING-LEFT: 2px; PADDING-RIGHT: 2px; PADDING-TOP: 2px"> 
+	                    <center><strong> 
+	                    <?php  if (strtoupper($FG_TABLE_COL[$i][4])=="SORT"){?>
+	                    <a href="<?php  echo $PHP_SELF."?customer=$customer&s=1&t=0&stitle=$stitle&atmenu=$atmenu&current_page=$current_page&order=".$FG_TABLE_COL[$i][1]."&sens="; if ($sens=="ASC"){echo"DESC";}else{echo"ASC";} 
+						echo "&posted=$posted&Period=$Period&frommonth=$frommonth&fromstatsmonth=$fromstatsmonth&tomonth=$tomonth&tostatsmonth=$tostatsmonth&fromday=$fromday&fromstatsday_sday=$fromstatsday_sday&fromstatsmonth_sday=$fromstatsmonth_sday&today=$today&tostatsday_sday=$tostatsday_sday&tostatsmonth_sday=$tostatsmonth_sday&phonenumbertype=$phonenumbertype&sourcetype=$sourcetype&clidtype=$clidtype&channel=$channel&resulttype=$resulttype&phonenumber=$phonenumber&src=$src&clid=$clid&terminatecauseid=$terminatecauseid&choose_calltype=$choose_calltype";?>"> 
+	                    <span class="liens"><?php  } ?>
+	                    <?php echo $FG_TABLE_COL[$i][0]?> 
+	                    <?php if ($order==$FG_TABLE_COL[$i][1] && $sens=="ASC"){?>
+	                    &nbsp;<img src="<?php echo Images_Path_Main ?>/icon_up_12x12.GIF" width="12" height="12" border="0"> 
+	                    <?php }elseif ($order==$FG_TABLE_COL[$i][1] && $sens=="DESC"){?>
+	                    &nbsp;<img src="<?php echo Images_Path_Main ?>/icon_down_12x12.GIF" width="12" height="12" border="0"> 
+	                    <?php }?>
+	                    <?php  if (strtoupper($FG_TABLE_COL[$i][4])=="SORT"){?>
+	                    </span></a> 
+	                    <?php }?>
+	                    </strong></center></TD>
+				   <?php } ?>
+				   		
+                </TR>
+                <TR> 
+                  <TD bgColor="#e1e1e1" colSpan=<?php echo $FG_TOTAL_TABLE_COL?> height="1">
+                </TR>
+				<?php
+				  	 $ligne_number=0;					 
+				  	 foreach ($list as $recordset){ 
+						 $ligne_number++;
+						 $recordset[0] = display_GMT($recordset[0], $_SESSION["gmtoffset"], 1);
+				?>
+				
+               		 <TR bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$ligne_number%2]?>"  onMouseOver="bgColor='#C4FFD7'" onMouseOut="bgColor='<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$ligne_number%2]?>'"> 
+						<TD align="<?php echo $FG_TABLE_COL[$i][3]?>" class="tableBody"><?php  echo $ligne_number+$current_page*$FG_LIMITE_DISPLAY.".&nbsp;"; ?></TD>
+							 
+				  		<?php for($i=0;$i<$FG_NB_TABLE_COL;$i++){ ?>
+						<?php 				
+							if ($FG_TABLE_COL[$i][6]=="lie"){
+									$instance_sub_table = new Table($FG_TABLE_COL[$i][7], $FG_TABLE_COL[$i][8]);
+									$sub_clause = str_replace("%id", $recordset[$i], $FG_TABLE_COL[$i][9]);																																	
+									$select_list = $instance_sub_table -> Get_list ($DBHandle, $sub_clause, null, null, null, null, null, null);
+									
+									
+									$field_list_sun = preg_split('/,/',$FG_TABLE_COL[$i][8]);
+									$record_display = $FG_TABLE_COL[$i][10];
+									
+									for ($l=1;$l<=count($field_list_sun);$l++){										
+										$record_display = str_replace("%$l", $select_list[0][$l-1], $record_display);	
+									}
+								
+							}elseif ($FG_TABLE_COL[$i][6]=="list"){
+									$select_list = $FG_TABLE_COL[$i][7];
+									$record_display = $select_list[$recordset[$i]][0];
+							
+							}else{
+									$record_display = $recordset[$i];
+							}
+							
+							if ( is_numeric($FG_TABLE_COL[$i][5]) && (strlen($record_display) > $FG_TABLE_COL[$i][5]) ) {
+								$record_display = substr($record_display, 0, $FG_TABLE_COL[$i][5]-3)."";  
+							}
+							
+							
+				 		 ?>
+                 		 <TD vAlign=top align="<?php echo $FG_TABLE_COL[$i][3]?>" class=tableBody><?php 
+                 		 if (isset ($FG_TABLE_COL[$i][11]) && strlen($FG_TABLE_COL[$i][11])>1){
+						 	call_user_func($FG_TABLE_COL[$i][11], $record_display);
+						 }else{
+						 	echo stripslashes($record_display);
+						 }						 
+						 ?></TD>
+				 		 <?php  } ?>
+                  
+					</TR>
+				<?php
+					 }//foreach ($list as $recordset)
+					 if ($ligne_number < $FG_LIMITE_DISPLAY)  $ligne_number_end=$ligne_number +2;
+					 while ($ligne_number < $ligne_number_end){
+					 	$ligne_number++;
+				?>
+					<TR bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$ligne_number%2]?>"> 
+				  		<?php for($i=0;$i<$FG_NB_TABLE_COL;$i++){ 
+				 		 ?>
+                 		 <TD vAlign=top class=tableBody>&nbsp;</TD>
+				 		 <?php  } ?>
+                 		 <TD align="center" vAlign=top class=tableBodyRight>&nbsp;</TD>				
+					</TR>
+									
+				<?php					 
+					 } //END_WHILE
+					 
+				  }else{
+				  		echo gettext("No data found !!!");
+				  }//end_if
+				 ?>
+            </TABLE></td>
+        </tr>
+        <TR bgcolor="#ffffff"> 
+          <TD bgColor=#ADBEDE height=16 style="PADDING-LEFT: 5px; PADDING-RIGHT: 3px"> 
+			<TABLE border=0 cellPadding=0 cellSpacing=0 width="100%">
+                <TR> 
+                  <TD align="right"><SPAN style="COLOR: #ffffff; FONT-SIZE: 11px"><B> 
+                    <?php if ($current_page>0){?>
+                    <img src="<?php echo Images_Path_Main ?>/fleche-g.gif" width="5" height="10"> <a href="<?php echo $PHP_SELF?>?s=1&t=0&order=<?php echo $order?>&sens=<?php echo $sens?>&current_page=<?php  echo ($current_page-1)?><?php  if (!is_null($letter) && ($letter!="")){ echo "&letter=$letter";} 
+					echo "&customer=$customer&posted=$posted&Period=$Period&frommonth=$frommonth&fromstatsmonth=$fromstatsmonth&tomonth=$tomonth&tostatsmonth=$tostatsmonth&fromday=$fromday&fromstatsday_sday=$fromstatsday_sday&fromstatsmonth_sday=$fromstatsmonth_sday&today=$today&tostatsday_sday=$tostatsday_sday&tostatsmonth_sday=$tostatsmonth_sday&phonenumbertype=$phonenumbertype&sourcetype=$sourcetype&clidtype=$clidtype&channel=$channel&resulttype=$resulttype&phonenumber=$phonenumber&src=$src&clid=$clid&terminatecauseid=$terminatecauseid&choose_calltype=$choose_calltype";?>"> 
+                    <?php echo gettext("PREVIOUS");?> </a> -
+                    <?php }?>
+                    <?php echo ($current_page+1);?> / <?php  echo $nb_record_max;?> 
+                    <?php if ($current_page<$nb_record_max-1){?>
+                    - <a href="<?php echo $PHP_SELF?>?s=1&t=0&order=<?php echo $order?>&sens=<?php echo $sens?>&current_page=<?php  echo ($current_page+1)?><?php  if (!is_null($letter) && ($letter!="")){ echo "&letter=$letter";} 
+					echo "&customer=$customer&posted=$posted&Period=$Period&frommonth=$frommonth&fromstatsmonth=$fromstatsmonth&tomonth=$tomonth&tostatsmonth=$tostatsmonth&fromday=$fromday&fromstatsday_sday=$fromstatsday_sday&fromstatsmonth_sday=$fromstatsmonth_sday&today=$today&tostatsday_sday=$tostatsday_sday&tostatsmonth_sday=$tostatsmonth_sday&phonenumbertype=$phonenumbertype&sourcetype=$sourcetype&clidtype=$clidtype&channel=$channel&resulttype=$resulttype&phonenumber=$phonenumber&src=$src&clid=$clid&terminatecauseid=$terminatecauseid&choose_calltype=$choose_calltype";?>"> 
+                    <?php echo gettext("NEXT");?> </a> <img src="<?php echo Images_Path_Main ?>/fleche-d.gif" width="5" height="10">
+                    </B></SPAN> 
+                    <?php }?>
+                  </TD>
+            </TABLE></TD>
+        </TR>
+      </table>
+
+<!-- ** ** ** ** ** Part to display the GRAPHIC ** ** ** ** ** -->
+<br>
+
+<?php 
+
+if (is_array($list_total_day) && count($list_total_day)>0){
+
+$mmax=0;
+$totalcall==0;
+$totalminutes=0;
+foreach ($list_total_day as $data){
+	if ($mmax < $data[1]) $mmax=$data[1];
+	$totalcall+=$data[3];
+	$totalminutes+=$data[1];
+	$totalcost+=$data[2];
+}
+
+?>
+
+
+<!-- TITLE GLOBAL -->
+<center>
+ <table border="0" cellspacing="0" cellpadding="0" width="80%"><tr><td align="left" height="30">
+		<table cellspacing="0" cellpadding="1" bgcolor="#000000" width="50%"><tr><td>
+			<table cellspacing="0" cellpadding="0" width="100%">
+				<tr><td class="callhistory_td1" align="left" ><?php echo gettext("SUMMARY");?></td></tr>
+			</table>
+		</td></tr></table>
+ </td></tr></table>
+
+<!-- FIN TITLE GLOBAL MINUTES //-->
+
+<table border="0" cellspacing="0" cellpadding="0"  width="80%">
+<tr><td bgcolor="#000000">			
+	<table border="0" cellspacing="1" cellpadding="2" width="100%">
+	<tr>
+		<td align="center" class="callhistory_td2"></td>
+    	<td class="callhistory_td3" align="center" colspan="5"><?php echo gettext("CALLING CARD MINUTES");?></td>
+    </tr>
+	<tr>
+		<td align="center" class="callhistory_td3"><?php echo gettext("DATE");?></td>
+        <td align="center" class="callhistory_td2"><?php echo gettext("DURATION");?></td>
+		<td align="center" class="callhistory_td2"><?php echo gettext("GRAPHIC");?></td>
+		<td align="center" class="callhistory_td2"><?php echo gettext("CALLS");?></td>
+		<td align="center" class="callhistory_td2"><acronym title="<?php echo gettext("AVERAGE LENGTH OF CALL");?>"><?php echo gettext("ALOC");?></acronym></font></td>
+		<td align="center" class="callhistory_td2"><?php echo gettext("TOTAL COST");?></td>
+
+		<!-- LOOP -->
+	<?php
+		$i=0;
+		foreach ($list_total_day as $data) {	
+			$i=($i+1)%2;
+			$tmc = $data[1]/$data[3];
+			
+			if ((!isset($resulttype)) || ($resulttype=="min")){  
+				$tmc = sprintf("%02d",intval($tmc/60)).":".sprintf("%02d",intval($tmc%60));		
+			}else{
+				$tmc =intval($tmc);
+			}
+			
+			if ((!isset($resulttype)) || ($resulttype=="min")){  
+				$minutes = sprintf("%02d",intval($data[1]/60)).":".sprintf("%02d",intval($data[1]%60));
+			}else{
+				$minutes = $data[1];
+			}
+			if ($mmax>0) 	$widthbar= intval(($data[1]/$mmax)*200); 
+			
+		?>
+			</tr><tr>
+			<td align="right" class="sidenav" nowrap="nowrap"><font class="callhistory_td5"><?php echo $data[0]?></font></td>
+			<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$i]?>" align="right" nowrap="nowrap" class="fontstyle_001"><?php echo $minutes?> </td>
+	        <td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$i]?>" align="left" nowrap="nowrap" width="<?php echo $widthbar+60?>">
+		        <table cellspacing="0" cellpadding="0"><tr>
+		        	<td bgcolor="#e22424"><img src="<?php echo Images_Path_Main ?>/spacer.gif" width="<?php echo $widthbar?>" height="6"></td>
+		        </tr></table>
+	        </td>
+	        <td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$i]?>" align="right" nowrap="nowrap" class="fontstyle_001"><?php echo $data[3]?></td>
+	        <td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$i]?>" align="right" nowrap="nowrap" class="fontstyle_001" ><?php echo $tmc?> </td>
+			<td bgcolor="<?php echo $FG_TABLE_ALTERNATE_ROW_COLOR[$i]?>" align="right" nowrap="nowrap" class="fontstyle_001"><?php  display_2bill($data[2]) ?></td>
+     	<?php 	 
+     	}	 	 	
+	 	
+		if ((!isset($resulttype)) || ($resulttype=="min")){  
+			$total_tmc = sprintf("%02d",intval(($totalminutes/$totalcall)/60)).":".sprintf("%02d",intval(($totalminutes/$totalcall)%60));				
+			$totalminutes = sprintf("%02d",intval($totalminutes/60)).":".sprintf("%02d",intval($totalminutes%60));
+		}else{
+			$total_tmc = intval($totalminutes/$totalcall);			
+		}
+	 
+	 ?>                   	
+	</tr>
+
+	<!-- TOTAL -->
+	<tr class="callhistory_td2">
+		<td align="right" nowrap="nowrap" class="callhistory_td4"><?php echo gettext("TOTAL");?></td>
+		<td align="center" nowrap="nowrap" colspan="2" class="callhistory_td4"><?php echo $totalminutes?> </td>
+		<td align="center" nowrap="nowrap" class="callhistory_td4"><?php echo $totalcall?></td>
+		<td align="center" nowrap="nowrap" class="callhistory_td4"><?php echo $total_tmc?></td>
+		<td align="center" nowrap="nowrap" class="callhistory_td4"><?php  display_2bill($totalcost) ?></td>
+	</tr>
+	
+	</table>
+	  
+</td></tr></table>
+
+<?php  } else { ?>
+	<center><h3><?php echo gettext("No calls in your selection");?>.</h3></center>
+<?php  } ?>
+</center>
+
+<?php
+
+$smarty->display( 'footer.tpl');
+
+
diff -rupN a2billing.orig/customer/export_csv_customer.php a2billing/customer/export_csv_customer.php
--- a2billing.orig/customer/export_csv_customer.php	1969-12-31 21:00:00.000000000 -0300
+++ a2billing/customer/export_csv_customer.php	2012-09-20 14:09:25.101341747 -0300
@@ -0,0 +1,94 @@
+<?php
+
+/* vim: set expandtab tabstop=4 shiftwidth=4 softtabstop=4: */
+
+/**
+ * This file is part of A2Billing (http://www.a2billing.net/)
+ *
+ * A2Billing, Commercial Open Source Telecom Billing platform,   
+ * powered by Star2billing S.L. <http://www.star2billing.com/>
+ * 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
+ * @author      Belaid Arezqui <areski@gmail.com>
+ * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
+ * @package     A2Billing
+ *
+ * Software License Agreement (GNU Affero General Public License)
+ *
+ * This program is free software: you can redistribute it and/or modify
+ * it under the terms of the GNU Affero General Public License as
+ * published by the Free Software Foundation, either version 3 of the
+ * License, or (at your option) any later version.
+ *
+ * This program is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+ * GNU Affero General Public License for more details.
+ *
+ * You should have received a copy of the GNU Affero General Public License
+ * along with this program.  If not, see <http://www.gnu.org/licenses/>.
+ * 
+ * 
+**/
+
+
+include ("lib/admin.defines.php");
+//require_once ("../lib/iam_csvdump.php");
+include ("lib/admin.module.access.php");
+
+getpost_ifset(array ( 'var_file', 'var_card_id' ));
+
+if (strlen($var_file) == 0) {
+	$var_file = '';
+}
+
+
+#  Set the parameters: SQL Query, hostname, databasename, dbuser and password
+//$dumpfile = new iam_csvdump;
+
+#  Call the CSV Dumping function and THAT'S IT!!!!  A file named dump.csv is sent to the user for download
+
+$log = new Logger();
+
+$root = "/var/www/html/billing/customer_cdr/".$var_card_id."/";
+$file = $var_file;
+$path = $root.$file;
+$type = '';
+ 
+ echo $path."\n";
+if (is_file($path)) {
+    $size = filesize($path);
+    if (function_exists('mime_content_type')) {
+        $type = mime_content_type($path);
+    } else if (function_exists('finfo_file')) {
+		$info = finfo_open(FILEINFO_MIME);
+        $type = finfo_file($info, $path);
+        finfo_close($info); 
+    }
+	echo $type."--".$size."..\n";
+    if ($type == '') {
+        $type = "application/force-download";
+    }
+    // Set Headers
+	header("Pragma: public");
+	header("Expires: 0");
+	header("Cache-Control: must-revalidate, post-check=0, pre-check=0");
+	header("Cache-control: public");
+	header("Content-Description: File Transfer");
+	header('Content-type: application/zip'); 
+	header('Content-Disposition: attachment; filename="'.basename($file).'"');
+	header("Content-Transfer-Encoding: binary");
+	header("Content-Length: " . filesize($file) );
+
+    // Download File
+    readfile($path);
+} else {
+    die("File not exist !!");
+}
+
+//$myfileName = $var_file;
+//$log->insertLog($_SESSION["admin_id"], 2, "FILE EXPORTED", "A File in CSV Format is exported by User, File Name= " . $myfileName . ".csv", '', $_SERVER['REMOTE_ADDR'], $_SERVER['REQUEST_URI'], '');
+//$dumpfile->dump_file($_SESSION[$var_export], $myfileName, "csv", DBNAME, USER, PASS, HOST, DB_TYPE);
+
+$log = null;
+
diff -rupN a2billing.orig/customer/lib/Misc.php a2billing/customer/lib/Misc.php
--- a2billing.orig/customer/lib/Misc.php	2012-09-18 06:38:22.000000000 -0300
+++ a2billing/customer/lib/Misc.php	2012-09-20 14:09:25.091341739 -0300
@@ -5,10 +5,10 @@
 /**
  * This file is part of A2Billing (http://www.a2billing.net/)
  *
- * A2Billing, Commercial Open Source Telecom Billing platform,
+ * A2Billing, Commercial Open Source Telecom Billing platform,   
  * powered by Star2billing S.L. <http://www.star2billing.com/>
- *
- * @copyright   Copyright (C) 2004-2012 - Star2billing S.L.
+ * 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
  * @author      Belaid Arezqui <areski@gmail.com>
  * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
  * @package     A2Billing
@@ -27,8 +27,8 @@
  *
  * You should have received a copy of the GNU Affero General Public License
  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
- *
- *
+ * 
+ * 
 **/
 
 
@@ -59,9 +59,9 @@ function a2b_decrypt($text, $key) {
  */
 function a2b_mail($to, $subject, $mail_content, $from = 'root@localhost', $fromname = '', $contenttype = 'multipart/alternative')
 {
-
+	
 	$mail = new PHPMailer(true);
-
+	
 	if (SMTP_SERVER) {
 		$mail->Mailer = "smtp";
 	} else {
@@ -85,7 +85,7 @@ function a2b_mail($to, $subject, $mail_c
 	$mail->AltBody = $mail_content; // Plain text body (for mail clients that cannot read 	HTML)
 	// if ContentType = multipart/alternative -> HTML will be send
 	$mail->ContentType = $contenttype;
-
+	
 	if (strpos($to, ',') > 0) {
 		foreach (explode(',', $to) as $toemail){
             $mail->AddAddress($toemail);
@@ -93,7 +93,7 @@ function a2b_mail($to, $subject, $mail_c
 	} else {
 	    $mail->AddAddress($to);
 	}
-
+	
 	try {
 		$mail->Send();
 	} catch (phpmailerException $e) {
@@ -236,26 +236,11 @@ function sanitize_data($input) {
 		}
 	} else {
 
-		// remove whitespaces (not a must though)
+		// remove whitespaces (not a must though)  
 		$input = trim($input);
 
 		$input = str_replace('--', '', $input);
 		$input = str_replace(';', '', $input);
-		$input = str_replace('#', '', $input);
-		$input = str_replace('/*', '', $input);
-
-		#injection sql
-		$input = str_ireplace('HAVING', '', $input);
-		$input = str_ireplace('UNION', '', $input);
-		$input = str_ireplace('SUBSTRING', '', $input);
-		$input = str_ireplace('ASCII', '', $input);
-		$input = str_ireplace('SHA1', '', $input);
-		$input = str_ireplace('MD5', '', $input);
-		$input = str_ireplace('SCRIPT', '', $input);
-		$input = str_ireplace('ROW_COUNT', '', $input);
-		$input = str_ireplace('SELECT', '', $input);
-		$input = str_ireplace('UPDATE', '', $input);
-		#$input = str_ireplace('DELETE', '', $input);
 
 		if (!(stripos($input, ' or 1') === FALSE)) {
 			return false;
@@ -268,7 +253,7 @@ function sanitize_data($input) {
 			$input = stripslashes($input);
 		}
 		$input = cleanInput($input);
-
+		
 		$output = addslashes($input);
 	}
 
@@ -351,7 +336,7 @@ function display_dateformat($mydate) {
  */
 function display_date_timestamp($timestamp){
 	echo date("m/d/Y H:i:s", $timestamp);
-}
+}	
 
 /*
  * function display_vm_callerid
@@ -359,7 +344,7 @@ function display_date_timestamp($timesta
 function display_vm_callerid($callerid_string){
 	$arr_spli = preg_split("/ /", $callerid_string);
 	echo str_replace('"',"", $arr_spli[0]);
-}
+}	
 
 
 
@@ -469,7 +454,7 @@ function linkonmonitorfile($value) {
 		}
 	}
 	if (!$find_record) return false;
-
+	
 	$myfile = base64_encode($myfile);
 	echo "<a target=_blank href=\"call-log-customers.php?download=file&file=" . $myfile . "\">";
 	echo '<img src="' . Images_Path . '/stock-mic.png" height="18" /></a>';
@@ -490,7 +475,7 @@ function linkonmonitorfile_customer($val
 		}
 	}
 	if (!$find_record) return false;
-
+	
 	$myfile = base64_encode($myfile);
 	echo "<a target=_blank href=\"call-history.php?download=file&file=" . $myfile . "\">";
 	echo '<img src="' . Images_Path . '/stock-mic.png" height="18" /></a>';
@@ -641,7 +626,7 @@ function MDP_NUMERIC($chrs = LEN_CARDNUM
     for($i = 0; $i < $chrs; $i++){
         $myrand .= mt_rand(0,9);
     }
-
+    
     return $myrand;
 }
 
@@ -884,11 +869,11 @@ function get_timezones($handle = null, $
 		$handle = DbConnect();
 	}
 	$instance_table = new Table();
-	if (!is_null($clause))
-		$clause = 'WHERE '.$clause;
+	if (!is_null($clause)) 
+		$clause = 'WHERE '.$clause; 
 	$QUERY = "SELECT id, gmttime, gmtzone, gmtoffset FROM cc_timezone $clause ORDER by id";
 	$result = $instance_table->SQLExec($handle, $QUERY, 1, 300);
-
+	
 	if (is_array($result)) {
 		$num_cur = count($result);
 		for ($i = 0; $i < $num_cur; $i++) {
@@ -904,13 +889,13 @@ function get_timezones($handle = null, $
 }
 
 function display_GMT($currDate, $number, $fulldate = 1)
-{
+{	
 	$timezone_list = get_timezones(null, "gmttime = '".SERVER_GMT."'");
 	foreach ($timezone_list as $key => $timezone_list_val) {
 		$server_offset = $timezone_list_val[3];
 		break;
 	}
-
+	
 	$date_time_array = getdate(strtotime($currDate));
 	$hours = $date_time_array['hours'];
 	$minutes = $date_time_array['minutes'];
@@ -919,7 +904,6 @@ function display_GMT($currDate, $number,
 	$day = $date_time_array['mday'];
 	$year = $date_time_array['year'];
 	$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
-
 	$timestamp = $timestamp - ($server_offset - $number);
 	/*
 	if ($fulldate == 1) {
@@ -929,7 +913,7 @@ function display_GMT($currDate, $number,
 	}
 	return $gmdate;
 	*/
-
+	
 	if ($fulldate == 1) {
 		$date = date("Y-m-d H:i:s", $timestamp);
 	} else {
@@ -1030,7 +1014,7 @@ function get_db_languages($handle = null
  */
 
 function archive_data($condition, $entity = "")
-{
+{	
 	$handle = DbConnect();
 	$instance_table = new Table();
 	if (!empty ($entity)) {
@@ -1073,7 +1057,7 @@ function do_field($sql, $fld, $dbfld) {
 	$fldtype = $fld . 'type';
 	global $$fld;
 	global $$fldtype;
-
+	
 	if ($$fld) {
 		if (strpos($sql, 'WHERE') > 0) {
 			$sql = "$sql AND ";
@@ -1114,7 +1098,7 @@ function currencies_update_yahoo ($DBHan
 	$strong_currency = 'EUR';
 	$url = "http://download.finance.yahoo.com/d/quotes.csv?s=";
 	$return = "";
-
+	
 	$QUERY = "SELECT id, currency, basecurrency FROM cc_currencies ORDER BY id";
 	$old_currencies = $instance_table->SQLExec($DBHandle, $QUERY);
 
@@ -1172,7 +1156,7 @@ function currencies_update_yahoo ($DBHan
 				return gettext("At least one of the entries in the CSV file isn't a number.") . ' ' . gettext('Currency update ABORTED.');
 			}
 		}
-
+		
 		// Find base_currency's value in $strong_currency to help avoid Yahoo's
 		// early truncation,  and therefore win back a lot of accuracy
 		$base_value = $currencies[$index_base_currency];
@@ -1250,7 +1234,7 @@ function generate_invoice_reference() {
 	$invoice_conf_table = new Table('cc_invoice_conf', 'value');
 	$conf_clause = "key_val = 'count_$year'";
 	$result = $invoice_conf_table->Get_list($handle, $conf_clause, 0);
-
+	
 	if (is_array($result) && !empty ($result[0][0])) {
 		$count = $result[0][0];
 		if (!is_numeric($count)) {
@@ -1339,13 +1323,13 @@ function mt_get()
     list($usec, $sec) = explode(" ", microtime());
     return ((float)$usec + (float)$sec);
 }
-
+ 
 // mt_start: starts the microtime counter
 function mt_start()
 {
     global $mt_time; $mt_time = mt_get();
 }
-
+ 
 // mt_end: calculates the elapsed time
 function mt_end($len=4)
 {
@@ -1376,8 +1360,8 @@ function open_url($url)
     $string = ob_get_contents();
 
     ob_end_clean();
-
-    return $string;
+   
+    return $string;    
 }
 
 
@@ -1387,22 +1371,22 @@ function open_url($url)
 function retrieve_rates_callplan($callplan_id, $DBHandle)
 {
     $instance_table = new Table();
-
+    
     $QUERY = "SELECT DISTINCT cc_ratecard.destination, cc_ratecard.dialprefix, cc_ratecard.buyrate, cc_ratecard.rateinitial, cc_ratecard.startdate, cc_ratecard.stopdate, cc_ratecard.initblock, " .
     		"cc_ratecard.connectcharge, cc_ratecard.id_trunk , cc_ratecard.idtariffplan , cc_ratecard.id FROM cc_tariffgroup RIGHT JOIN cc_tariffgroup_plan ON cc_tariffgroup_plan.idtariffgroup=cc_tariffgroup.id " .
     		"INNER JOIN cc_tariffplan ON (cc_tariffplan.id=cc_tariffgroup_plan.idtariffplan ) LEFT JOIN cc_ratecard ON cc_ratecard.idtariffplan=cc_tariffplan.id WHERE cc_tariffgroup.id= '$callplan_id' " .
     		"AND cc_ratecard.rateinitial = (SELECT min(c1.rateinitial) FROM cc_tariffgroup RIGHT JOIN cc_tariffgroup_plan ON cc_tariffgroup_plan.idtariffgroup=cc_tariffgroup.id " .
     		"INNER JOIN cc_tariffplan ON (cc_tariffplan.id=cc_tariffgroup_plan.idtariffplan ) LEFT JOIN cc_ratecard AS c1 ON c1.idtariffplan=cc_tariffplan.id WHERE cc_tariffgroup.id= '$callplan_id' " .
     		"AND cc_ratecard.dialprefix=c1.dialprefix) ORDER BY destination ASC";
-
+	
 	$result = $instance_table -> SQLExec ($DBHandle, $QUERY, 1, 3600); // cached for 1hour
-
+	
 	if (!is_array($result)) {
 	    return false;
 	}
-
+	
 	return $result;
-
+	
 }
 
 /*
@@ -1412,16 +1396,16 @@ function check_cp()
 {
 	$randn = rand(1, 10);
 	$ret_val = ($randn == 5)? 1 : 0;
-
+	
 	$pos_star = strpos(COPYRIGHT, 'star2billing');
 	if ($pos_star === false) {
 		return $ret_val;
 	}
 	$pageURL = get_curPageURL();
     $pos = strpos($pageURL, 'phpsysinfo');
-
+    
     if ($pos === false) {
-
+        
         $footer_content = file_get_contents("templates/default/footer.tpl");
 
         $pos_copyright = strpos($footer_content, '$COPYRIGHT');
@@ -1489,7 +1473,7 @@ function addRealMonth($timeStamp)
 
 
 function Display_Login_Button ($DBHandle, $id) {
-
+	
 	$inst_table = new Table("cc_card", "useralias, uipass");
 	$FG_TABLE_CLAUSE = "id = $id";
 	$list_card_info = $inst_table -> Get_list ($DBHandle, $FG_TABLE_CLAUSE);
@@ -1515,3 +1499,22 @@ function Display_Login_Button ($DBHandle
 }
 
 
+function date_add_hour($tmpdate, $hour = 0) {
+	
+	$second = $hour * 60 * 60 ;
+	$date_time_array = getdate(strtotime($tmpdate));
+	
+
+	$hours = $date_time_array['hours'];
+	$minutes = $date_time_array['minutes'];
+	$seconds = $date_time_array['seconds'];
+	$month = $date_time_array['mon'];
+	$day = $date_time_array['mday'];
+	$year = $date_time_array['year'];
+	
+	$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
+
+	$timestamp = $timestamp + $second;
+
+	return $timestamp;
+}
diff -rupN a2billing.orig/customer/templates/default/main.tpl a2billing/customer/templates/default/main.tpl
--- a2billing.orig/customer/templates/default/main.tpl	2012-09-18 06:38:22.000000000 -0300
+++ a2billing/customer/templates/default/main.tpl	2012-09-20 14:09:25.111341753 -0300
@@ -20,9 +20,12 @@
 	{/if}
 
 	{if $ACXCALL_HISTORY >0 }
-	<div class="toggle_menu"><li><a href="call-history.php"><strong>{php} echo gettext("CALL HISTORY");{/php}</strong></a></li></div>
+	<div class="toggle_menu"><li><a href="call.php?s=1&t=0&order=starttime&sens=DESC&current_page=0&terminatecauseid=ANSWER"><strong>{php} echo gettext("CALL - REAL TIME");{/php}</strong></a></li></div>
 	{/if}
-	
+
+	{if $ACXCALL_HISTORY >0 }
+	<div class="toggle_menu"><li><a href="call-history.php?s=1&t=0&order=t1.starttime&sens=DESC&current_page=0&terminatecauseid=ANSWER"><strong>{php} echo gettext("CALL - HISTORY");{/php}</strong></a></li></div>
+	{/if}	
 	{if $ACXPAYMENT_HISTORY >0 }
 	<div class="toggle_menu"><li><a href="payment-history.php"><strong>{php} echo gettext("PAYMENT HISTORY");{/php}</strong></a></li></div>
 	{/if}
diff -rupN a2billing.orig/webservice/lib/Misc.php a2billing/webservice/lib/Misc.php
--- a2billing.orig/webservice/lib/Misc.php	2012-09-18 06:38:22.000000000 -0300
+++ a2billing/webservice/lib/Misc.php	2012-09-20 14:09:25.091341739 -0300
@@ -5,10 +5,10 @@
 /**
  * This file is part of A2Billing (http://www.a2billing.net/)
  *
- * A2Billing, Commercial Open Source Telecom Billing platform,
+ * A2Billing, Commercial Open Source Telecom Billing platform,   
  * powered by Star2billing S.L. <http://www.star2billing.com/>
- *
- * @copyright   Copyright (C) 2004-2012 - Star2billing S.L.
+ * 
+ * @copyright   Copyright (C) 2004-2009 - Star2billing S.L. 
  * @author      Belaid Arezqui <areski@gmail.com>
  * @license     http://www.fsf.org/licensing/licenses/agpl-3.0.html
  * @package     A2Billing
@@ -27,8 +27,8 @@
  *
  * You should have received a copy of the GNU Affero General Public License
  * along with this program.  If not, see <http://www.gnu.org/licenses/>.
- *
- *
+ * 
+ * 
 **/
 
 
@@ -59,9 +59,9 @@ function a2b_decrypt($text, $key) {
  */
 function a2b_mail($to, $subject, $mail_content, $from = 'root@localhost', $fromname = '', $contenttype = 'multipart/alternative')
 {
-
+	
 	$mail = new PHPMailer(true);
-
+	
 	if (SMTP_SERVER) {
 		$mail->Mailer = "smtp";
 	} else {
@@ -85,7 +85,7 @@ function a2b_mail($to, $subject, $mail_c
 	$mail->AltBody = $mail_content; // Plain text body (for mail clients that cannot read 	HTML)
 	// if ContentType = multipart/alternative -> HTML will be send
 	$mail->ContentType = $contenttype;
-
+	
 	if (strpos($to, ',') > 0) {
 		foreach (explode(',', $to) as $toemail){
             $mail->AddAddress($toemail);
@@ -93,7 +93,7 @@ function a2b_mail($to, $subject, $mail_c
 	} else {
 	    $mail->AddAddress($to);
 	}
-
+	
 	try {
 		$mail->Send();
 	} catch (phpmailerException $e) {
@@ -236,26 +236,11 @@ function sanitize_data($input) {
 		}
 	} else {
 
-		// remove whitespaces (not a must though)
+		// remove whitespaces (not a must though)  
 		$input = trim($input);
 
 		$input = str_replace('--', '', $input);
 		$input = str_replace(';', '', $input);
-		$input = str_replace('#', '', $input);
-		$input = str_replace('/*', '', $input);
-
-		#injection sql
-		$input = str_ireplace('HAVING', '', $input);
-		$input = str_ireplace('UNION', '', $input);
-		$input = str_ireplace('SUBSTRING', '', $input);
-		$input = str_ireplace('ASCII', '', $input);
-		$input = str_ireplace('SHA1', '', $input);
-		$input = str_ireplace('MD5', '', $input);
-		$input = str_ireplace('SCRIPT', '', $input);
-		$input = str_ireplace('ROW_COUNT', '', $input);
-		$input = str_ireplace('SELECT', '', $input);
-		$input = str_ireplace('UPDATE', '', $input);
-		#$input = str_ireplace('DELETE', '', $input);
 
 		if (!(stripos($input, ' or 1') === FALSE)) {
 			return false;
@@ -268,7 +253,7 @@ function sanitize_data($input) {
 			$input = stripslashes($input);
 		}
 		$input = cleanInput($input);
-
+		
 		$output = addslashes($input);
 	}
 
@@ -351,7 +336,7 @@ function display_dateformat($mydate) {
  */
 function display_date_timestamp($timestamp){
 	echo date("m/d/Y H:i:s", $timestamp);
-}
+}	
 
 /*
  * function display_vm_callerid
@@ -359,7 +344,7 @@ function display_date_timestamp($timesta
 function display_vm_callerid($callerid_string){
 	$arr_spli = preg_split("/ /", $callerid_string);
 	echo str_replace('"',"", $arr_spli[0]);
-}
+}	
 
 
 
@@ -469,7 +454,7 @@ function linkonmonitorfile($value) {
 		}
 	}
 	if (!$find_record) return false;
-
+	
 	$myfile = base64_encode($myfile);
 	echo "<a target=_blank href=\"call-log-customers.php?download=file&file=" . $myfile . "\">";
 	echo '<img src="' . Images_Path . '/stock-mic.png" height="18" /></a>';
@@ -490,7 +475,7 @@ function linkonmonitorfile_customer($val
 		}
 	}
 	if (!$find_record) return false;
-
+	
 	$myfile = base64_encode($myfile);
 	echo "<a target=_blank href=\"call-history.php?download=file&file=" . $myfile . "\">";
 	echo '<img src="' . Images_Path . '/stock-mic.png" height="18" /></a>';
@@ -641,7 +626,7 @@ function MDP_NUMERIC($chrs = LEN_CARDNUM
     for($i = 0; $i < $chrs; $i++){
         $myrand .= mt_rand(0,9);
     }
-
+    
     return $myrand;
 }
 
@@ -884,11 +869,11 @@ function get_timezones($handle = null, $
 		$handle = DbConnect();
 	}
 	$instance_table = new Table();
-	if (!is_null($clause))
-		$clause = 'WHERE '.$clause;
+	if (!is_null($clause)) 
+		$clause = 'WHERE '.$clause; 
 	$QUERY = "SELECT id, gmttime, gmtzone, gmtoffset FROM cc_timezone $clause ORDER by id";
 	$result = $instance_table->SQLExec($handle, $QUERY, 1, 300);
-
+	
 	if (is_array($result)) {
 		$num_cur = count($result);
 		for ($i = 0; $i < $num_cur; $i++) {
@@ -904,13 +889,13 @@ function get_timezones($handle = null, $
 }
 
 function display_GMT($currDate, $number, $fulldate = 1)
-{
+{	
 	$timezone_list = get_timezones(null, "gmttime = '".SERVER_GMT."'");
 	foreach ($timezone_list as $key => $timezone_list_val) {
 		$server_offset = $timezone_list_val[3];
 		break;
 	}
-
+	
 	$date_time_array = getdate(strtotime($currDate));
 	$hours = $date_time_array['hours'];
 	$minutes = $date_time_array['minutes'];
@@ -919,7 +904,6 @@ function display_GMT($currDate, $number,
 	$day = $date_time_array['mday'];
 	$year = $date_time_array['year'];
 	$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
-
 	$timestamp = $timestamp - ($server_offset - $number);
 	/*
 	if ($fulldate == 1) {
@@ -929,7 +913,7 @@ function display_GMT($currDate, $number,
 	}
 	return $gmdate;
 	*/
-
+	
 	if ($fulldate == 1) {
 		$date = date("Y-m-d H:i:s", $timestamp);
 	} else {
@@ -1030,7 +1014,7 @@ function get_db_languages($handle = null
  */
 
 function archive_data($condition, $entity = "")
-{
+{	
 	$handle = DbConnect();
 	$instance_table = new Table();
 	if (!empty ($entity)) {
@@ -1073,7 +1057,7 @@ function do_field($sql, $fld, $dbfld) {
 	$fldtype = $fld . 'type';
 	global $$fld;
 	global $$fldtype;
-
+	
 	if ($$fld) {
 		if (strpos($sql, 'WHERE') > 0) {
 			$sql = "$sql AND ";
@@ -1114,7 +1098,7 @@ function currencies_update_yahoo ($DBHan
 	$strong_currency = 'EUR';
 	$url = "http://download.finance.yahoo.com/d/quotes.csv?s=";
 	$return = "";
-
+	
 	$QUERY = "SELECT id, currency, basecurrency FROM cc_currencies ORDER BY id";
 	$old_currencies = $instance_table->SQLExec($DBHandle, $QUERY);
 
@@ -1172,7 +1156,7 @@ function currencies_update_yahoo ($DBHan
 				return gettext("At least one of the entries in the CSV file isn't a number.") . ' ' . gettext('Currency update ABORTED.');
 			}
 		}
-
+		
 		// Find base_currency's value in $strong_currency to help avoid Yahoo's
 		// early truncation,  and therefore win back a lot of accuracy
 		$base_value = $currencies[$index_base_currency];
@@ -1250,7 +1234,7 @@ function generate_invoice_reference() {
 	$invoice_conf_table = new Table('cc_invoice_conf', 'value');
 	$conf_clause = "key_val = 'count_$year'";
 	$result = $invoice_conf_table->Get_list($handle, $conf_clause, 0);
-
+	
 	if (is_array($result) && !empty ($result[0][0])) {
 		$count = $result[0][0];
 		if (!is_numeric($count)) {
@@ -1339,13 +1323,13 @@ function mt_get()
     list($usec, $sec) = explode(" ", microtime());
     return ((float)$usec + (float)$sec);
 }
-
+ 
 // mt_start: starts the microtime counter
 function mt_start()
 {
     global $mt_time; $mt_time = mt_get();
 }
-
+ 
 // mt_end: calculates the elapsed time
 function mt_end($len=4)
 {
@@ -1376,8 +1360,8 @@ function open_url($url)
     $string = ob_get_contents();
 
     ob_end_clean();
-
-    return $string;
+   
+    return $string;    
 }
 
 
@@ -1387,22 +1371,22 @@ function open_url($url)
 function retrieve_rates_callplan($callplan_id, $DBHandle)
 {
     $instance_table = new Table();
-
+    
     $QUERY = "SELECT DISTINCT cc_ratecard.destination, cc_ratecard.dialprefix, cc_ratecard.buyrate, cc_ratecard.rateinitial, cc_ratecard.startdate, cc_ratecard.stopdate, cc_ratecard.initblock, " .
     		"cc_ratecard.connectcharge, cc_ratecard.id_trunk , cc_ratecard.idtariffplan , cc_ratecard.id FROM cc_tariffgroup RIGHT JOIN cc_tariffgroup_plan ON cc_tariffgroup_plan.idtariffgroup=cc_tariffgroup.id " .
     		"INNER JOIN cc_tariffplan ON (cc_tariffplan.id=cc_tariffgroup_plan.idtariffplan ) LEFT JOIN cc_ratecard ON cc_ratecard.idtariffplan=cc_tariffplan.id WHERE cc_tariffgroup.id= '$callplan_id' " .
     		"AND cc_ratecard.rateinitial = (SELECT min(c1.rateinitial) FROM cc_tariffgroup RIGHT JOIN cc_tariffgroup_plan ON cc_tariffgroup_plan.idtariffgroup=cc_tariffgroup.id " .
     		"INNER JOIN cc_tariffplan ON (cc_tariffplan.id=cc_tariffgroup_plan.idtariffplan ) LEFT JOIN cc_ratecard AS c1 ON c1.idtariffplan=cc_tariffplan.id WHERE cc_tariffgroup.id= '$callplan_id' " .
     		"AND cc_ratecard.dialprefix=c1.dialprefix) ORDER BY destination ASC";
-
+	
 	$result = $instance_table -> SQLExec ($DBHandle, $QUERY, 1, 3600); // cached for 1hour
-
+	
 	if (!is_array($result)) {
 	    return false;
 	}
-
+	
 	return $result;
-
+	
 }
 
 /*
@@ -1412,16 +1396,16 @@ function check_cp()
 {
 	$randn = rand(1, 10);
 	$ret_val = ($randn == 5)? 1 : 0;
-
+	
 	$pos_star = strpos(COPYRIGHT, 'star2billing');
 	if ($pos_star === false) {
 		return $ret_val;
 	}
 	$pageURL = get_curPageURL();
     $pos = strpos($pageURL, 'phpsysinfo');
-
+    
     if ($pos === false) {
-
+        
         $footer_content = file_get_contents("templates/default/footer.tpl");
 
         $pos_copyright = strpos($footer_content, '$COPYRIGHT');
@@ -1489,7 +1473,7 @@ function addRealMonth($timeStamp)
 
 
 function Display_Login_Button ($DBHandle, $id) {
-
+	
 	$inst_table = new Table("cc_card", "useralias, uipass");
 	$FG_TABLE_CLAUSE = "id = $id";
 	$list_card_info = $inst_table -> Get_list ($DBHandle, $FG_TABLE_CLAUSE);
@@ -1515,3 +1499,22 @@ function Display_Login_Button ($DBHandle
 }
 
 
+function date_add_hour($tmpdate, $hour = 0) {
+	
+	$second = $hour * 60 * 60 ;
+	$date_time_array = getdate(strtotime($tmpdate));
+	
+
+	$hours = $date_time_array['hours'];
+	$minutes = $date_time_array['minutes'];
+	$seconds = $date_time_array['seconds'];
+	$month = $date_time_array['mon'];
+	$day = $date_time_array['mday'];
+	$year = $date_time_array['year'];
+	
+	$timestamp = mktime($hours, $minutes, $seconds, $month, $day, $year);
+
+	$timestamp = $timestamp + $second;
+
+	return $timestamp;
+}
